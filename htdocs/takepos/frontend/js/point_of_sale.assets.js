
/* /point_of_sale/static/lib/fastclick.js defined in bundle 'point_of_sale.assets' */
function FastClick(layer){'use strict';var oldOnClick,self=this;this.trackingClick=false;this.trackingClickStart=0;this.targetElement=null;this.touchStartX=0;this.touchStartY=0;this.lastTouchIdentifier=0;this.touchBoundary=10;this.layer=layer;if(!layer||!layer.nodeType){throw new TypeError('Layer must be a document node');}
this.onClick=function(){return FastClick.prototype.onClick.apply(self,arguments);};this.onMouse=function(){return FastClick.prototype.onMouse.apply(self,arguments);};this.onTouchStart=function(){return FastClick.prototype.onTouchStart.apply(self,arguments);};this.onTouchMove=function(){return FastClick.prototype.onTouchMove.apply(self,arguments);};this.onTouchEnd=function(){return FastClick.prototype.onTouchEnd.apply(self,arguments);};this.onTouchCancel=function(){return FastClick.prototype.onTouchCancel.apply(self,arguments);};if(FastClick.notNeeded(layer)){return;}
if(this.deviceIsAndroid){layer.addEventListener('mouseover',this.onMouse,true);layer.addEventListener('mousedown',this.onMouse,true);layer.addEventListener('mouseup',this.onMouse,true);}
layer.addEventListener('click',this.onClick,true);layer.addEventListener('touchstart',this.onTouchStart,false);layer.addEventListener('touchmove',this.onTouchMove,false);layer.addEventListener('touchend',this.onTouchEnd,false);layer.addEventListener('touchcancel',this.onTouchCancel,false);if(!Event.prototype.stopImmediatePropagation){layer.removeEventListener=function(type,callback,capture){var rmv=Node.prototype.removeEventListener;if(type==='click'){rmv.call(layer,type,callback.hijacked||callback,capture);}else{rmv.call(layer,type,callback,capture);}};layer.addEventListener=function(type,callback,capture){var adv=Node.prototype.addEventListener;if(type==='click'){adv.call(layer,type,callback.hijacked||(callback.hijacked=function(event){if(!event.propagationStopped){callback(event);}}),capture);}else{adv.call(layer,type,callback,capture);}};}
if(typeof layer.onclick==='function'){oldOnClick=layer.onclick;layer.addEventListener('click',function(event){oldOnClick(event);},false);layer.onclick=null;}}
FastClick.prototype.deviceIsAndroid=navigator.userAgent.indexOf('Android')>0;FastClick.prototype.deviceIsIOS=/iP(ad|hone|od)/.test(navigator.userAgent);FastClick.prototype.deviceIsIOS4=FastClick.prototype.deviceIsIOS&&(/OS 4_\d(_\d)?/).test(navigator.userAgent);FastClick.prototype.deviceIsIOSWithBadTarget=FastClick.prototype.deviceIsIOS&&(/OS ([6-9]|\d{2})_\d/).test(navigator.userAgent);FastClick.prototype.needsClick=function(target){'use strict';switch(target.nodeName.toLowerCase()){case'button':case'select':case'textarea':if(target.disabled){return true;}
break;case'input':if((this.deviceIsIOS&&target.type==='file')||target.disabled){return true;}
break;case'label':case'video':return true;}
return(/\bneedsclick\b/).test(target.className);};FastClick.prototype.needsFocus=function(target){'use strict';switch(target.nodeName.toLowerCase()){case'textarea':return true;case'select':return!this.deviceIsAndroid;case'input':switch(target.type){case'button':case'checkbox':case'file':case'image':case'radio':case'submit':return false;}
return!target.disabled&&!target.readOnly;default:return(/\bneedsfocus\b/).test(target.className);}};FastClick.prototype.sendClick=function(targetElement,event){'use strict';var clickEvent,touch;if(document.activeElement&&document.activeElement!==targetElement){document.activeElement.blur();}
touch=event.changedTouches[0];clickEvent=document.createEvent('MouseEvents');clickEvent.initMouseEvent(this.determineEventType(targetElement),true,true,window,1,touch.screenX,touch.screenY,touch.clientX,touch.clientY,false,false,false,false,0,null);clickEvent.forwardedTouchEvent=true;targetElement.dispatchEvent(clickEvent);};FastClick.prototype.determineEventType=function(targetElement){'use strict;'
if(this.deviceIsAndroid&&targetElement.tagName.toLowerCase()==='select'){return'mousedown';}
return'click';}
FastClick.prototype.focus=function(targetElement){'use strict';var length;if(this.deviceIsIOS&&targetElement.setSelectionRange&&targetElement.type.indexOf('date')!==0&&targetElement.type!=='time'){length=targetElement.value.length;targetElement.setSelectionRange(length,length);}else{targetElement.focus();}};FastClick.prototype.updateScrollParent=function(targetElement){'use strict';var scrollParent,parentElement;scrollParent=targetElement.fastClickScrollParent;if(!scrollParent||!scrollParent.contains(targetElement)){parentElement=targetElement;do{if(parentElement.scrollHeight>parentElement.offsetHeight){scrollParent=parentElement;targetElement.fastClickScrollParent=parentElement;break;}
parentElement=parentElement.parentElement;}while(parentElement);}
if(scrollParent){scrollParent.fastClickLastScrollTop=scrollParent.scrollTop;}};FastClick.prototype.getTargetElementFromEventTarget=function(eventTarget){'use strict';if(eventTarget.nodeType===Node.TEXT_NODE){return eventTarget.parentNode;}
return eventTarget;};FastClick.prototype.onTouchStart=function(event){'use strict';var targetElement,touch,selection;if(event.targetTouches.length>1){return true;}
targetElement=this.getTargetElementFromEventTarget(event.target);touch=event.targetTouches[0];if(this.deviceIsIOS){selection=window.getSelection();if(selection.rangeCount&&!selection.isCollapsed){return true;}
if(!this.deviceIsIOS4){if(touch.identifier===this.lastTouchIdentifier){event.preventDefault();return false;}
this.lastTouchIdentifier=touch.identifier;this.updateScrollParent(targetElement);}}
this.trackingClick=true;this.trackingClickStart=event.timeStamp;this.targetElement=targetElement;this.touchStartX=touch.pageX;this.touchStartY=touch.pageY;if((event.timeStamp-this.lastClickTime)<200){event.preventDefault();}
return true;};FastClick.prototype.touchHasMoved=function(event){'use strict';var touch=event.changedTouches[0],boundary=this.touchBoundary;if(Math.abs(touch.pageX-this.touchStartX)>boundary||Math.abs(touch.pageY-this.touchStartY)>boundary){return true;}
return false;};FastClick.prototype.onTouchMove=function(event){'use strict';if(!this.trackingClick){return true;}
if(this.targetElement!==this.getTargetElementFromEventTarget(event.target)||this.touchHasMoved(event)){this.trackingClick=false;this.targetElement=null;}
return true;};FastClick.prototype.findControl=function(labelElement){'use strict';if(labelElement.control!==undefined){return labelElement.control;}
if(labelElement.htmlFor){return document.getElementById(labelElement.htmlFor);}
return labelElement.querySelector('button, input:not([type=hidden]), keygen, meter, output, progress, select, textarea');};FastClick.prototype.onTouchEnd=function(event){'use strict';var forElement,trackingClickStart,targetTagName,scrollParent,touch,targetElement=this.targetElement;if(!this.trackingClick){return true;}
if((event.timeStamp-this.lastClickTime)<200){this.cancelNextClick=true;return true;}
this.cancelNextClick=false;this.lastClickTime=event.timeStamp;trackingClickStart=this.trackingClickStart;this.trackingClick=false;this.trackingClickStart=0;if(this.deviceIsIOSWithBadTarget){touch=event.changedTouches[0];targetElement=document.elementFromPoint(touch.pageX-window.pageXOffset,touch.pageY-window.pageYOffset)||targetElement;targetElement.fastClickScrollParent=this.targetElement.fastClickScrollParent;}
targetTagName=targetElement.tagName.toLowerCase();if(targetTagName==='label'){forElement=this.findControl(targetElement);if(forElement){this.focus(targetElement);if(this.deviceIsAndroid){return false;}
targetElement=forElement;}}else if(this.needsFocus(targetElement)){if((event.timeStamp-trackingClickStart)>100||(this.deviceIsIOS&&window.top!==window&&targetTagName==='input')){this.targetElement=null;return false;}
this.focus(targetElement);if(!this.deviceIsIOS4||targetTagName!=='select'){this.targetElement=null;event.preventDefault();}
return false;}
if(this.deviceIsIOS&&!this.deviceIsIOS4){scrollParent=targetElement.fastClickScrollParent;if(scrollParent&&scrollParent.fastClickLastScrollTop!==scrollParent.scrollTop){return true;}}
if(!this.needsClick(targetElement)){event.preventDefault();this.sendClick(targetElement,event);}
return false;};FastClick.prototype.onTouchCancel=function(){'use strict';this.trackingClick=false;this.targetElement=null;};FastClick.prototype.onMouse=function(event){'use strict';if(!this.targetElement){return true;}
if(event.forwardedTouchEvent){return true;}
if(!event.cancelable){return true;}
if(!this.needsClick(this.targetElement)||this.cancelNextClick){if(event.stopImmediatePropagation){event.stopImmediatePropagation();}else{event.propagationStopped=true;}
event.stopPropagation();event.preventDefault();return false;}
return true;};FastClick.prototype.onClick=function(event){'use strict';var permitted;if(this.trackingClick){this.targetElement=null;this.trackingClick=false;return true;}
if(event.target.type==='submit'&&event.detail===0){return true;}
permitted=this.onMouse(event);if(!permitted){this.targetElement=null;}
return permitted;};FastClick.prototype.destroy=function(){'use strict';var layer=this.layer;if(this.deviceIsAndroid){layer.removeEventListener('mouseover',this.onMouse,true);layer.removeEventListener('mousedown',this.onMouse,true);layer.removeEventListener('mouseup',this.onMouse,true);}
layer.removeEventListener('click',this.onClick,true);layer.removeEventListener('touchstart',this.onTouchStart,false);layer.removeEventListener('touchmove',this.onTouchMove,false);layer.removeEventListener('touchend',this.onTouchEnd,false);layer.removeEventListener('touchcancel',this.onTouchCancel,false);};FastClick.notNeeded=function(layer){'use strict';var metaViewport;if(typeof window.ontouchstart==='undefined'){return true;}
if((/Chrome\/[0-9]+/).test(navigator.userAgent)){if(FastClick.prototype.deviceIsAndroid){metaViewport=document.querySelector('meta[name=viewport]');if(metaViewport&&metaViewport.content.indexOf('user-scalable=no')!==-1){return false;}}else{return true;}}
if(layer.style.msTouchAction==='none'){return true;}
return false;};FastClick.attach=function(layer){'use strict';return new FastClick(layer);};if(typeof define!=='undefined'&&define.amd){define(function(){'use strict';return FastClick;});}else if(typeof module!=='undefined'&&module.exports){module.exports=FastClick.attach;module.exports.FastClick=FastClick;}else{window.FastClick=FastClick;};

/* /point_of_sale/static/lib/waitfont.js defined in bundle 'point_of_sale.assets' */
(function(){function waitForWebfonts(fonts,callback){var loadedFonts=0;for(var i=0,l=fonts.length;i<l;++i){(function(font){var node=document.createElement('span');node.innerHTML='giItT1WQy@!-/#';node.style.position='absolute';node.style.left='-10000px';node.style.top='-10000px';node.style.fontSize='300px';node.style.fontFamily='sans-serif';node.style.fontVariant='normal';node.style.fontStyle='normal';node.style.fontWeight='normal';node.style.letterSpacing='0';document.body.appendChild(node);var width=node.offsetWidth;node.style.fontFamily=font;var interval;function checkFont(){if(node&&node.offsetWidth!=width){++loadedFonts;node.parentNode.removeChild(node);node=null;}
if(loadedFonts>=fonts.length){if(interval){clearInterval(interval);}
if(loadedFonts==fonts.length){callback();return true;}}};if(!checkFont()){interval=setInterval(checkFont,50);}})(fonts[i]);}}
window.waitForWebfonts=waitForWebfonts;})();;

/* /point_of_sale/static/src/js/main.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.main',function(require){"use strict";var chrome=require('point_of_sale.chrome');var core=require('web.core');core.action_registry.add('pos.ui',chrome.Chrome);});;

/* /point_of_sale/static/src/js/db.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.DB',function(require){"use strict";var core=require('web.core');var PosDB=core.Class.extend({name:'openerp_pos_db',limit:100,init:function(options){options=options||{};this.name=options.name||this.name;this.limit=options.limit||this.limit;if(options.uuid){this.name=this.name+'_'+options.uuid;}
this.cache={};this.product_by_id={};this.product_by_barcode={};this.product_by_category_id={};this.partner_sorted=[];this.partner_by_id={};this.partner_by_barcode={};this.partner_search_string="";this.partner_write_date=null;this.category_by_id={};this.root_category_id=0;this.category_products={};this.category_ancestors={};this.category_childs={};this.category_parent={};this.category_search_string={};},set_uuid:function(uuid){this.name=this.name+'_'+uuid;},get_category_by_id:function(categ_id){if(categ_id instanceof Array){var list=[];for(var i=0,len=categ_id.length;i<len;i++){var cat=this.category_by_id[categ_id[i]];if(cat){list.push(cat);}else{console.error("get_category_by_id: no category has id:",categ_id[i]);}}
return list;}else{return this.category_by_id[categ_id];}},get_category_childs_ids:function(categ_id){return this.category_childs[categ_id]||[];},get_category_ancestors_ids:function(categ_id){return this.category_ancestors[categ_id]||[];},get_category_parent_id:function(categ_id){return this.category_parent[categ_id]||this.root_category_id;},add_categories:function(categories){var self=this;if(!this.category_by_id[this.root_category_id]){this.category_by_id[this.root_category_id]={id:this.root_category_id,name:'Root',};}
for(var i=0,len=categories.length;i<len;i++){this.category_by_id[categories[i].id]=categories[i];}
len=categories.length;for(i=0;i<len;i++){var cat=categories[i];var parent_id=cat.parent_id[0]||this.root_category_id;this.category_parent[cat.id]=cat.parent_id[0];if(!this.category_childs[parent_id]){this.category_childs[parent_id]=[];}
this.category_childs[parent_id].push(cat.id);}
function make_ancestors(cat_id,ancestors){self.category_ancestors[cat_id]=ancestors;ancestors=ancestors.slice(0);ancestors.push(cat_id);var childs=self.category_childs[cat_id]||[];for(var i=0,len=childs.length;i<len;i++){make_ancestors(childs[i],ancestors);}}
make_ancestors(this.root_category_id,[]);},category_contains:function(categ_id,product_id){var product=this.product_by_id[product_id];if(product){var cid=product.pos_categ_id[0];while(cid&&cid!==categ_id){cid=this.category_parent[cid];}
return!!cid;}
return false;},load:function(store,deft){if(this.cache[store]!==undefined){return this.cache[store];}
var data=localStorage[this.name+'_'+store];if(data!==undefined&&data!==""){data=JSON.parse(data);this.cache[store]=data;return data;}else{return deft;}},save:function(store,data){localStorage[this.name+'_'+store]=JSON.stringify(data);this.cache[store]=data;},_product_search_string:function(product){var str=product.display_name;if(product.barcode){str+='|'+product.barcode;}
if(product.default_code){str+='|'+product.default_code;}
if(product.description){str+='|'+product.description;}
if(product.description_sale){str+='|'+product.description_sale;}
str=product.id+':'+str.replace(/:/g,'')+'\n';return str;},add_products:function(products){var stored_categories=this.product_by_category_id;if(!products instanceof Array){products=[products];}
for(var i=0,len=products.length;i<len;i++){var product=products[i];var search_string=this._product_search_string(product);var categ_id=product.pos_categ_id?product.pos_categ_id[0]:this.root_category_id;product.product_tmpl_id=product.product_tmpl_id[0];if(!stored_categories[categ_id]){stored_categories[categ_id]=[];}
stored_categories[categ_id].push(product.id);if(this.category_search_string[categ_id]===undefined){this.category_search_string[categ_id]='';}
this.category_search_string[categ_id]+=search_string;var ancestors=this.get_category_ancestors_ids(categ_id)||[];for(var j=0,jlen=ancestors.length;j<jlen;j++){var ancestor=ancestors[j];if(!stored_categories[ancestor]){stored_categories[ancestor]=[];}
stored_categories[ancestor].push(product.id);if(this.category_search_string[ancestor]===undefined){this.category_search_string[ancestor]='';}
this.category_search_string[ancestor]+=search_string;}
this.product_by_id[product.id]=product;if(product.barcode){this.product_by_barcode[product.barcode]=product;}}},_partner_search_string:function(partner){var str=partner.name;if(partner.barcode){str+='|'+partner.barcode;}
if(partner.address){str+='|'+partner.address;}
if(partner.phone){str+='|'+partner.phone.split(' ').join('');}
if(partner.mobile){str+='|'+partner.mobile.split(' ').join('');}
if(partner.email){str+='|'+partner.email;}
str=''+partner.id+':'+str.replace(':','')+'\n';return str;},add_partners:function(partners){var updated_count=0;var new_write_date='';var partner;for(var i=0,len=partners.length;i<len;i++){partner=partners[i];var local_partner_date=(this.partner_write_date||'').replace(/^(\d{4}-\d{2}-\d{2}) ((\d{2}:?){3})$/,'$1T$2Z');var dist_partner_date=(partner.write_date||'').replace(/^(\d{4}-\d{2}-\d{2}) ((\d{2}:?){3})$/,'$1T$2Z');if(this.partner_write_date&&this.partner_by_id[partner.id]&&new Date(local_partner_date).getTime()+1000>=new Date(dist_partner_date).getTime()){continue;}else if(new_write_date<partner.write_date){new_write_date=partner.write_date;}
if(!this.partner_by_id[partner.id]){this.partner_sorted.push(partner.id);}
this.partner_by_id[partner.id]=partner;updated_count+=1;}
this.partner_write_date=new_write_date||this.partner_write_date;if(updated_count){this.partner_search_string="";this.partner_by_barcode={};for(var id in this.partner_by_id){partner=this.partner_by_id[id];if(partner.barcode){this.partner_by_barcode[partner.barcode]=partner;}
partner.address=(partner.street||'')+', '+
(partner.zip||'')+' '+
(partner.city||'')+', '+
(partner.country_id[1]||'');this.partner_search_string+=this._partner_search_string(partner);}}
return updated_count;},get_partner_write_date:function(){return this.partner_write_date||"1970-01-01 00:00:00";},get_partner_by_id:function(id){return this.partner_by_id[id];},get_partner_by_barcode:function(barcode){return this.partner_by_barcode[barcode];},get_partners_sorted:function(max_count){max_count=max_count?Math.min(this.partner_sorted.length,max_count):this.partner_sorted.length;var partners=[];for(var i=0;i<max_count;i++){partners.push(this.partner_by_id[this.partner_sorted[i]]);}
return partners;},search_partner:function(query){try{query=query.replace(/[\[\]\(\)\+\*\?\.\-\!\&\^\$\|\~\_\{\}\:\,\\\/]/g,'.');query=query.replace(/ /g,'.+');var re=RegExp("([0-9]+):.*?"+query,"gi");}catch(e){return[];}
var results=[];for(var i=0;i<this.limit;i++){var r=re.exec(this.partner_search_string);if(r){var id=Number(r[1]);results.push(this.get_partner_by_id(id));}else{break;}}
return results;},clear:function(){for(var i=0,len=arguments.length;i<len;i++){localStorage.removeItem(this.name+'_'+arguments[i]);}},_count_props:function(obj){var count=0;for(var prop in obj){if(obj.hasOwnProperty(prop)){count++;}}
return count;},get_product_by_id:function(id){return this.product_by_id[id];},get_product_by_barcode:function(barcode){if(this.product_by_barcode[barcode]){return this.product_by_barcode[barcode];}else{return undefined;}},get_product_by_category:function(category_id){var product_ids=this.product_by_category_id[category_id];var list=[];if(product_ids){for(var i=0,len=Math.min(product_ids.length,this.limit);i<len;i++){list.push(this.product_by_id[product_ids[i]]);}}
return list;},search_product_in_category:function(category_id,query){try{query=query.replace(/[\[\]\(\)\+\*\?\.\-\!\&\^\$\|\~\_\{\}\:\,\\\/]/g,'.');query=query.replace(/ /g,'.+');var re=RegExp("([0-9]+):.*?"+query,"gi");}catch(e){return[];}
var results=[];for(var i=0;i<this.limit;i++){var r=re.exec(this.category_search_string[category_id]);if(r){var id=Number(r[1]);results.push(this.get_product_by_id(id));}else{break;}}
return results;},is_product_in_category:function(category_ids,product_id){if(!(category_ids instanceof Array)){category_ids=[category_ids];}
var cat=this.get_product_by_id(product_id).pos_categ_id[0];while(cat){for(var i=0;i<category_ids.length;i++){if(cat==category_ids[i]){return true;}}
cat=this.get_category_parent_id(cat);}
return false;},add_order:function(order){var order_id=order.uid;var orders=this.load('orders',[]);for(var i=0,len=orders.length;i<len;i++){if(orders[i].id===order_id){orders[i].data=order;this.save('orders',orders);return order_id;}}
this.remove_unpaid_order(order);orders.push({id:order_id,data:order});this.save('orders',orders);return order_id;},remove_order:function(order_id){var orders=this.load('orders',[]);orders=_.filter(orders,function(order){return order.id!==order_id;});this.save('orders',orders);},remove_all_orders:function(){this.save('orders',[]);},get_orders:function(){return this.load('orders',[]);},get_order:function(order_id){var orders=this.get_orders();for(var i=0,len=orders.length;i<len;i++){if(orders[i].id===order_id){return orders[i];}}
return undefined;},save_unpaid_order:function(order){var order_id=order.uid;var orders=this.load('unpaid_orders',[]);var serialized=order.export_as_JSON();for(var i=0;i<orders.length;i++){if(orders[i].id===order_id){orders[i].data=serialized;this.save('unpaid_orders',orders);return order_id;}}
orders.push({id:order_id,data:serialized});this.save('unpaid_orders',orders);return order_id;},remove_unpaid_order:function(order){var orders=this.load('unpaid_orders',[]);orders=_.filter(orders,function(o){return o.id!==order.uid;});this.save('unpaid_orders',orders);},remove_all_unpaid_orders:function(){this.save('unpaid_orders',[]);},get_unpaid_orders:function(){var saved=this.load('unpaid_orders',[]);var orders=[];for(var i=0;i<saved.length;i++){orders.push(saved[i].data);}
return orders;},set_cashier:function(cashier){this.save('cashier',cashier||null);},get_cashier:function(){return this.load('cashier');}});return PosDB;});;

/* /point_of_sale/static/src/js/models.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.models',function(require){"use strict";var ajax=require('web.ajax');var BarcodeParser=require('barcodes.BarcodeParser');var PosDB=require('point_of_sale.DB');var devices=require('point_of_sale.devices');var concurrency=require('web.concurrency');var core=require('web.core');var field_utils=require('web.field_utils');var rpc=require('web.rpc');var session=require('web.session');var time=require('web.time');var utils=require('web.utils');var QWeb=core.qweb;var _t=core._t;var Mutex=concurrency.Mutex;var round_di=utils.round_decimals;var round_pr=utils.round_precision;var exports={};exports.PosModel=Backbone.Model.extend({initialize:function(session,attributes){Backbone.Model.prototype.initialize.call(this,attributes);var self=this;this.flush_mutex=new Mutex();this.chrome=attributes.chrome;this.gui=attributes.gui;this.proxy=new devices.ProxyDevice(this);this.barcode_reader=new devices.BarcodeReader({'pos':this,proxy:this.proxy});this.proxy_queue=new devices.JobQueue();this.db=new PosDB();this.debug=core.debug;this.company_logo=null;this.company_logo_base64='';this.currency=null;this.shop=null;this.company=null;this.user=null;this.users=[];this.partners=[];this.cashregisters=[];this.taxes=[];this.pos_session=null;this.config=null;this.units=[];this.units_by_id={};this.default_pricelist=null;this.order_sequence=1;window.posmodel=this;this.set({'synch':{state:'connected',pending:0},'orders':new OrderCollection(),'selectedOrder':null,'selectedClient':null,'cashier':null,});this.get('orders').bind('remove',function(order,_unused_,options){self.on_removed_order(order,options.index,options.reason);});function update_client(){var order=self.get_order();this.set('selectedClient',order?order.get_client():null);}
this.get('orders').bind('add remove change',update_client,this);this.bind('change:selectedOrder',update_client,this);this.ready=this.load_server_data().then(function(){return self.after_load_server_data();});},after_load_server_data:function(){this.load_orders();this.set_start_order();if(this.config.use_proxy){if(this.config.iface_customer_facing_display){this.on('change:selectedOrder',this.send_current_order_to_customer_facing_display,this);}
return this.connect_to_proxy();}},destroy:function(){this.proxy.close();this.barcode_reader.disconnect();this.barcode_reader.disconnect_from_proxy();},connect_to_proxy:function(){var self=this;var done=new $.Deferred();this.barcode_reader.disconnect_from_proxy();this.chrome.loading_message(_t('Connecting to the PosBox'),0);this.chrome.loading_skip(function(){self.proxy.stop_searching();});this.proxy.autoconnect({force_ip:self.config.proxy_ip||undefined,progress:function(prog){self.chrome.loading_progress(prog);},}).then(function(){if(self.config.iface_scan_via_proxy){self.barcode_reader.connect_to_proxy();}}).always(function(){done.resolve();});return done;},models:[{label:'version',loaded:function(self){return session.rpc('version_info.php',{}).done(function(version){self.version=version;});},},{model:'res.users',fields:['name','company_id'],ids:function(self){return[session.uid];},loaded:function(self,users){self.user=users[0];},},{model:'res.company',fields:['currency_id','email','website','company_registry','vat','name','phone','partner_id','country_id','tax_calculation_rounding_method'],ids:function(self){return[self.user.company_id[0]];},loaded:function(self,companies){self.company=companies[0];},},{model:'decimal.precision',fields:['name','digits'],loaded:function(self,dps){self.dp={};for(var i=0;i<dps.length;i++){self.dp[dps[i].name]=dps[i].digits;}},},{model:'product.uom',fields:[],domain:null,context:function(self){return{active_test:false};},loaded:function(self,units){self.units=units;_.each(units,function(unit){self.units_by_id[unit.id]=unit;});}},{model:'res.partner',fields:['name','street','city','state_id','country_id','vat','phone','zip','mobile','email','barcode','write_date','property_account_position_id','property_product_pricelist'],domain:[['customer','=',true]],loaded:function(self,partners){self.partners=partners;self.db.add_partners(partners);},},{model:'res.country',fields:['name','vat_label'],loaded:function(self,countries){self.countries=countries;self.company.country=null;for(var i=0;i<countries.length;i++){if(countries[i].id===self.company.country_id[0]){self.company.country=countries[i];}}},},{model:'account.tax',fields:['name','amount','price_include','include_base_amount','amount_type','children_tax_ids'],domain:function(self){return[['company_id','=',self.company&&self.company.id||false]]},loaded:function(self,taxes){self.taxes=taxes;self.taxes_by_id={};_.each(taxes,function(tax){self.taxes_by_id[tax.id]=tax;});_.each(self.taxes_by_id,function(tax){tax.children_tax_ids=_.map(tax.children_tax_ids,function(child_tax_id){return self.taxes_by_id[child_tax_id];});});},},{model:'pos.session',fields:['id','journal_ids','name','user_id','config_id','start_at','stop_at','sequence_number','login_number'],domain:function(self){return[['state','=','opened'],['user_id','=',session.uid]];},loaded:function(self,pos_sessions){self.pos_session=pos_sessions[0];},},{model:'pos.config',fields:[],domain:function(self){return[['id','=',self.pos_session.config_id[0]]];},loaded:function(self,configs){self.config=configs[0];self.config.use_proxy=self.config.iface_payment_terminal||self.config.iface_electronic_scale||self.config.iface_print_via_proxy||self.config.iface_scan_via_proxy||self.config.iface_cashdrawer||self.config.iface_customer_facing_display;if(self.config.company_id[0]!==self.user.company_id[0]){throw new Error(_t("Error: The Point of Sale User must belong to the same company as the Point of Sale. You are probably trying to load the point of sale as an administrator in a multi-company setup, with the administrator account set to the wrong company."));}
self.db.set_uuid(self.config.uuid);self.set_cashier(self.get_cashier());self.db.save('pos_session_id',self.pos_session.id);var orders=self.db.get_orders();for(var i=0;i<orders.length;i++){self.pos_session.sequence_number=Math.max(self.pos_session.sequence_number,orders[i].data.sequence_number+1);}},},{model:'res.users',fields:['name','pos_security_pin','groups_id','barcode'],domain:function(self){return[['company_id','=',self.user.company_id[0]],'|',['groups_id','=',self.config.group_pos_manager_id[0]],['groups_id','=',self.config.group_pos_user_id[0]]];},loaded:function(self,users){var pos_users=[];var current_cashier=self.get_cashier();for(var i=0;i<users.length;i++){var user=users[i];for(var j=0;j<user.groups_id.length;j++){var group_id=user.groups_id[j];if(group_id===self.config.group_pos_manager_id[0]){user.role='manager';break;}else if(group_id===self.config.group_pos_user_id[0]){user.role='cashier';}}
if(user.role){pos_users.push(user);}
if(user.id===self.user.id){self.user=user;}
if(user.id===current_cashier.id){self.set_cashier(user);}}
self.users=pos_users;},},{model:'stock.location',fields:[],ids:function(self){return[self.config.stock_location_id[0]];},loaded:function(self,locations){self.shop=locations[0];},},{model:'product.pricelist',fields:['name','display_name'],domain:function(self){return[['id','in',self.config.available_pricelist_ids]];},loaded:function(self,pricelists){_.map(pricelists,function(pricelist){pricelist.items=[];});self.default_pricelist=_.findWhere(pricelists,{id:self.config.pricelist_id[0]});self.pricelists=pricelists;},},{model:'product.pricelist.item',domain:function(self){return[['pricelist_id','in',_.pluck(self.pricelists,'id')]];},loaded:function(self,pricelist_items){var pricelist_by_id={};_.each(self.pricelists,function(pricelist){pricelist_by_id[pricelist.id]=pricelist;});_.each(pricelist_items,function(item){var pricelist=pricelist_by_id[item.pricelist_id[0]];pricelist.items.push(item);item.base_pricelist=pricelist_by_id[item.base_pricelist_id[0]];});},},{model:'product.category',fields:['name','parent_id'],loaded:function(self,product_categories){var category_by_id={};_.each(product_categories,function(category){category_by_id[category.id]=category;});_.each(product_categories,function(category){category.parent=category_by_id[category.parent_id[0]];});self.product_categories=product_categories;},},{model:'res.currency',fields:['name','symbol','position','rounding','rate'],ids:function(self){return[self.config.currency_id[0],self.company.currency_id[0]];},loaded:function(self,currencies){self.currency=currencies[0];if(self.currency.rounding>0&&self.currency.rounding<1){self.currency.decimals=Math.ceil(Math.log(1.0/self.currency.rounding)/Math.log(10));}else{self.currency.decimals=0;}
self.company_currency=currencies[1];},},{model:'pos.category',fields:['id','name','parent_id','child_id'],domain:null,loaded:function(self,categories){self.db.add_categories(categories);},},{model:'product.product',fields:['display_name','list_price','lst_price','standard_price','categ_id','pos_categ_id','taxes_id','barcode','default_code','to_weight','uom_id','description_sale','description','product_tmpl_id','tracking'],order:_.map(['sequence','default_code','name'],function(name){return{name:name};}),domain:[['sale_ok','=',true],['available_in_pos','=',true]],context:function(self){return{display_default_code:false};},loaded:function(self,products){var using_company_currency=self.config.currency_id[0]===self.company.currency_id[0];var conversion_rate=self.currency.rate/self.company_currency.rate;self.db.add_products(_.map(products,function(product){if(!using_company_currency){product.lst_price=round_pr(product.lst_price*conversion_rate,self.currency.rounding);}
product.categ=_.findWhere(self.product_categories,{'id':product.categ_id[0]});return new exports.Product({},product);}));},},{model:'account.bank.statement',fields:['account_id','currency_id','journal_id','state','name','user_id','pos_session_id'],domain:function(self){return[['state','=','open'],['pos_session_id','=',self.pos_session.id]];},loaded:function(self,cashregisters,tmp){self.cashregisters=cashregisters;tmp.journals=[];_.each(cashregisters,function(statement){tmp.journals.push(statement.journal_id[0]);});},},{model:'account.journal',fields:['type','sequence'],domain:function(self,tmp){return[['id','in',tmp.journals]];},loaded:function(self,journals){var i;self.journals=journals;var cashregisters=self.cashregisters;var ilen=cashregisters.length;for(i=0;i<ilen;i++){for(var j=0,jlen=journals.length;j<jlen;j++){if(cashregisters[i].journal_id[0]===journals[j].id){cashregisters[i].journal=journals[j];}}}
self.cashregisters_by_id={};for(i=0;i<self.cashregisters.length;i++){self.cashregisters_by_id[self.cashregisters[i].id]=self.cashregisters[i];}
self.cashregisters=self.cashregisters.sort(function(a,b){if(a.journal.type=="cash"&&b.journal.type!="cash"){return-1;}else if(a.journal.type!="cash"&&b.journal.type=="cash"){return 1;}else{return a.journal.sequence-b.journal.sequence;}});},},{model:'account.fiscal.position',fields:[],domain:function(self){return[['id','in',self.config.fiscal_position_ids]];},loaded:function(self,fiscal_positions){self.fiscal_positions=fiscal_positions;}},{model:'account.fiscal.position.tax',fields:[],domain:function(self){var fiscal_position_tax_ids=[];self.fiscal_positions.forEach(function(fiscal_position){fiscal_position.tax_ids.forEach(function(tax_id){fiscal_position_tax_ids.push(tax_id);});});return[['id','in',fiscal_position_tax_ids]];},loaded:function(self,fiscal_position_taxes){self.fiscal_position_taxes=fiscal_position_taxes;self.fiscal_positions.forEach(function(fiscal_position){fiscal_position.fiscal_position_taxes_by_id={};fiscal_position.tax_ids.forEach(function(tax_id){var fiscal_position_tax=_.find(fiscal_position_taxes,function(fiscal_position_tax){return fiscal_position_tax.id===tax_id;});fiscal_position.fiscal_position_taxes_by_id[fiscal_position_tax.id]=fiscal_position_tax;});});}},{label:'fonts',loaded:function(){var fonts_loaded=new $.Deferred();waitForWebfonts(['Lato','Inconsolata'],function(){fonts_loaded.resolve();});setTimeout(function(){fonts_loaded.resolve();},5000);return fonts_loaded;},},{label:'pictures',loaded:function(self){self.company_logo=new Image();var logo_loaded=new $.Deferred();self.company_logo.onload=function(){var img=self.company_logo;var ratio=1;var targetwidth=300;var maxheight=150;if(img.width!==targetwidth){ratio=targetwidth/img.width;}
if(img.height*ratio>maxheight){ratio=maxheight/img.height;}
var width=Math.floor(img.width*ratio);var height=Math.floor(img.height*ratio);var c=document.createElement('canvas');c.width=width;c.height=height;var ctx=c.getContext('2d');ctx.drawImage(self.company_logo,0,0,width,height);self.company_logo_base64=c.toDataURL();logo_loaded.resolve();};self.company_logo.onerror=function(){logo_loaded.reject();};self.company_logo.crossOrigin="anonymous";self.company_logo.src='company_logo.png'+'?dbname='+session.db+'&_'+Math.random();return logo_loaded;},},{label:'barcodes',loaded:function(self){var barcode_parser=new BarcodeParser({'nomenclature_id':self.config.barcode_nomenclature_id});self.barcode_reader.set_barcode_parser(barcode_parser);return barcode_parser.is_loaded();},}],load_server_data:function(){var self=this;var loaded=new $.Deferred();var progress=0;var progress_step=1.0/self.models.length;var tmp={};function load_model(index){if(index>=self.models.length){loaded.resolve();}else{var model=self.models[index];self.chrome.loading_message(_t('Loading')+' '+(model.label||model.model||''),progress);var cond=typeof model.condition==='function'?model.condition(self,tmp):true;if(!cond){load_model(index+1);return;}
var fields=typeof model.fields==='function'?model.fields(self,tmp):model.fields;var domain=typeof model.domain==='function'?model.domain(self,tmp):model.domain;var context=typeof model.context==='function'?model.context(self,tmp):model.context||{};var ids=typeof model.ids==='function'?model.ids(self,tmp):model.ids;var order=typeof model.order==='function'?model.order(self,tmp):model.order;progress+=progress_step;if(model.model){var params={model:model.model,context:_.extend(context,session.user_context||{}),};if(model.ids){params.method='read';params.args=[ids,fields];}else{params.method='search_read';params.domain=domain;params.fields=fields;params.orderBy=order;}
rpc.query(params).then(function(result){try{$.when(model.loaded(self,result,tmp)).then(function(){load_model(index+1);},function(err){loaded.reject(err);});}catch(err){console.error(err.message,err.stack);loaded.reject(err);}},function(err){loaded.reject(err);});}else if(model.loaded){try{$.when(model.loaded(self,tmp)).then(function(){load_model(index+1);},function(err){loaded.reject(err);});}catch(err){loaded.reject(err);}}else{load_model(index+1);}}}
try{load_model(0);}catch(err){loaded.reject(err);}
return loaded;},load_new_partners:function(){var self=this;var def=new $.Deferred();var fields=_.find(this.models,function(model){return model.model==='res.partner';}).fields;var domain=[['customer','=',true],['write_date','>',this.db.get_partner_write_date()]];rpc.query({model:'res.partner',method:'search_read',args:[domain,fields],},{timeout:3000,shadow:true,}).then(function(partners){if(self.db.add_partners(partners)){def.resolve();}else{def.reject();}},function(type,err){def.reject();});return def;},on_removed_order:function(removed_order,index,reason){var order_list=this.get_order_list();if((reason==='abandon'||removed_order.temporary)&&order_list.length>0){this.set_order(order_list[index]||order_list[order_list.length-1]);}else{this.add_new_order();}},get_cashier:function(){if(this.db.load('pos_session_id')!==this.pos_session.id){this.set_cashier(this.user);}
return this.db.get_cashier()||this.get('cashier')||this.user;},set_cashier:function(user){this.set('cashier',user);this.db.set_cashier(this.get('cashier'));},add_new_order:function(){var order=new exports.Order({},{pos:this});this.get('orders').add(order);this.set('selectedOrder',order);return order;},load_orders:function(){var jsons=this.db.get_unpaid_orders();var orders=[];var not_loaded_count=0;for(var i=0;i<jsons.length;i++){var json=jsons[i];if(json.pos_session_id===this.pos_session.id){orders.push(new exports.Order({},{pos:this,json:json,}));}else{not_loaded_count+=1;}}
if(not_loaded_count){console.info('There are '+not_loaded_count+' locally saved unpaid orders belonging to another session');}
orders=orders.sort(function(a,b){return a.sequence_number-b.sequence_number;});if(orders.length){this.get('orders').add(orders);}},set_start_order:function(){var orders=this.get('orders').models;if(orders.length&&!this.get('selectedOrder')){this.set('selectedOrder',orders[0]);}else{this.add_new_order();}},get_order:function(){return this.get('selectedOrder');},get_client:function(){var order=this.get_order();if(order){return order.get_client();}
return null;},set_order:function(order){this.set({selectedOrder:order});},get_order_list:function(){return this.get('orders').models;},delete_current_order:function(){var order=this.get_order();if(order){order.destroy({'reason':'abandon'});}},_convert_product_img_to_base64:function(product,url){var deferred=new $.Deferred();var img=new Image();img.onload=function(){var canvas=document.createElement('CANVAS');var ctx=canvas.getContext('2d');canvas.height=this.height;canvas.width=this.width;ctx.drawImage(this,0,0);var dataURL=canvas.toDataURL('image/jpeg');product.image_base64=dataURL;canvas=null;deferred.resolve();};img.crossOrigin='use-credentials';img.src=url;return deferred;},send_current_order_to_customer_facing_display:function(){var self=this;this.render_html_for_customer_facing_display().then(function(rendered_html){self.proxy.update_customer_facing_display(rendered_html);});},render_html_for_customer_facing_display:function(){var self=this;var order=this.get_order();var rendered_html=this.config.customer_facing_display_html;var get_image_deferreds=[];if(order){order.get_orderlines().forEach(function(orderline){var product=orderline.product;var image_url='image.php?model=product.product&field=image_medium&id='+product.id;if(!product.image_base64){get_image_deferreds.push(self._convert_product_img_to_base64(product,image_url));}});}
return $.when.apply($,get_image_deferreds).then(function(){var rendered_order_lines="";var rendered_payment_lines="";var order_total_with_tax=self.chrome.format_currency(0);if(order){rendered_order_lines=QWeb.render('CustomerFacingDisplayOrderLines',{'orderlines':order.get_orderlines(),'widget':self.chrome,});rendered_payment_lines=QWeb.render('CustomerFacingDisplayPaymentLines',{'order':order,'widget':self.chrome,});order_total_with_tax=self.chrome.format_currency(order.get_total_with_tax());}
var $rendered_html=$(rendered_html);$rendered_html.find('.pos_orderlines_list').html(rendered_order_lines);$rendered_html.find('.pos-total').find('.pos_total-amount').html(order_total_with_tax);var pos_change_title=$rendered_html.find('.pos-change_title').text();$rendered_html.find('.pos-paymentlines').html(rendered_payment_lines);$rendered_html.find('.pos-change_title').text(pos_change_title);rendered_html=_.reduce($rendered_html,function(memory,current_element){return memory+$(current_element).prop('outerHTML');},"");rendered_html=QWeb.render('CustomerFacingDisplayHead',{origin:window.location.origin})+rendered_html;return rendered_html;});},push_order:function(order,opts){opts=opts||{};var self=this;if(order){this.db.add_order(order.export_as_JSON());}
var pushed=new $.Deferred();this.flush_mutex.exec(function(){var flushed=self._flush_orders(self.db.get_orders(),opts);flushed.always(function(ids){pushed.resolve();});return flushed;});return pushed;},push_and_invoice_order:function(order){var self=this;var invoiced=new $.Deferred();if(!order.get_client()){invoiced.reject({code:400,message:'Missing Customer',data:{}});return invoiced;}
var order_id=this.db.add_order(order.export_as_JSON());this.flush_mutex.exec(function(){var done=new $.Deferred();var transfer=self._flush_orders([self.db.get_order(order_id)],{timeout:30000,to_invoice:true});transfer.fail(function(error){invoiced.reject(error);done.reject();});transfer.pipe(function(order_server_id){self.chrome.do_action('point_of_sale.pos_invoice_report',{additional_context:{active_ids:order_server_id,}}).done(function(){invoiced.resolve();done.resolve();});});return done;});return invoiced;},_flush_orders:function(orders,options){var self=this;this.set('synch',{state:'connecting',pending:orders.length});return self._save_to_server(orders,options).done(function(server_ids){var pending=self.db.get_orders().length;self.set('synch',{state:pending?'connecting':'connected',pending:pending});return server_ids;}).fail(function(error,event){var pending=self.db.get_orders().length;if(self.get('failed')){self.set('synch',{state:'error',pending:pending});}else{self.set('synch',{state:'disconnected',pending:pending});}});},_save_to_server:function(orders,options){if(!orders||!orders.length){var result=$.Deferred();result.resolve([]);return result;}
options=options||{};var self=this;var timeout=typeof options.timeout==='number'?options.timeout:7500*orders.length;var order_ids_to_sync=_.pluck(orders,'id');var args=[_.map(orders,function(order){order.to_invoice=options.to_invoice||false;return order;})];return rpc.query({model:'pos.order',method:'create_from_ui/index.php',args:args,kwargs:{context:session.user_context},},{timeout:timeout,shadow:!options.to_invoice}).then(function(server_ids){_.each(order_ids_to_sync,function(order_id){self.db.remove_order(order_id);});self.set('failed',false);return server_ids;}).fail(function(type,error){if(error.code===200){if(error.data.exception_type=='warning'){delete error.data.debug;}
if((!self.get('failed')||options.show_error)&&!options.to_invoice){self.gui.show_popup('error-traceback',{'title':error.data.message,'body':error.data.debug});}
self.set('failed',error);}
console.error('Failed to send orders:',orders);});},scan_product:function(parsed_code){var selectedOrder=this.get_order();var product=this.db.get_product_by_barcode(parsed_code.base_code);if(!product){return false;}
if(parsed_code.type==='price'){selectedOrder.add_product(product,{price:parsed_code.value});}else if(parsed_code.type==='weight'){selectedOrder.add_product(product,{quantity:parsed_code.value,merge:false});}else if(parsed_code.type==='discount'){selectedOrder.add_product(product,{discount:parsed_code.value,merge:false});}else{selectedOrder.add_product(product);}
return true;},export_paid_orders:function(){return JSON.stringify({'paid_orders':this.db.get_orders(),'session':this.pos_session.name,'session_id':this.pos_session.id,'date':(new Date()).toUTCString(),'version':this.version.server_version_info,},null,2);},export_unpaid_orders:function(){return JSON.stringify({'unpaid_orders':this.db.get_unpaid_orders(),'session':this.pos_session.name,'session_id':this.pos_session.id,'date':(new Date()).toUTCString(),'version':this.version.server_version_info,},null,2);},import_orders:function(str){var json=JSON.parse(str);var report={paid:0,unpaid:0,unpaid_skipped_existing:0,unpaid_skipped_session:0,unpaid_skipped_sessions:[],};if(json.paid_orders){for(var i=0;i<json.paid_orders.length;i++){this.db.add_order(json.paid_orders[i].data);}
report.paid=json.paid_orders.length;this.push_order();}
if(json.unpaid_orders){var orders=[];var existing=this.get_order_list();var existing_uids={};var skipped_sessions={};for(var i=0;i<existing.length;i++){existing_uids[existing[i].uid]=true;}
for(var i=0;i<json.unpaid_orders.length;i++){var order=json.unpaid_orders[i];if(order.pos_session_id!==this.pos_session.id){report.unpaid_skipped_session+=1;skipped_sessions[order.pos_session_id]=true;}else if(existing_uids[order.uid]){report.unpaid_skipped_existing+=1;}else{orders.push(new exports.Order({},{pos:this,json:order,}));}}
orders=orders.sort(function(a,b){return a.sequence_number-b.sequence_number;});if(orders.length){report.unpaid=orders.length;this.get('orders').add(orders);}
report.unpaid_skipped_sessions=_.keys(skipped_sessions);}
return report;},_load_orders:function(){var jsons=this.db.get_unpaid_orders();var orders=[];var not_loaded_count=0;for(var i=0;i<jsons.length;i++){var json=jsons[i];if(json.pos_session_id===this.pos_session.id){orders.push(new exports.Order({},{pos:this,json:json,}));}else{not_loaded_count+=1;}}
if(not_loaded_count){console.info('There are '+not_loaded_count+' locally saved unpaid orders belonging to another session');}
orders=orders.sort(function(a,b){return a.sequence_number-b.sequence_number;});if(orders.length){this.get('orders').add(orders);}},});exports.load_fields=function(model_name,fields){if(!(fields instanceof Array)){fields=[fields];}
var models=exports.PosModel.prototype.models;for(var i=0;i<models.length;i++){var model=models[i];if(model.model===model_name){if((model.fields instanceof Array)&&model.fields.length>0){model.fields=model.fields.concat(fields||[]);}}}};exports.load_models=function(models,options){options=options||{};if(!(models instanceof Array)){models=[models];}
var pmodels=exports.PosModel.prototype.models;var index=pmodels.length;if(options.before){for(var i=0;i<pmodels.length;i++){if(pmodels[i].model===options.before||pmodels[i].label===options.before){index=i;break;}}}else if(options.after){for(var i=0;i<pmodels.length;i++){if(pmodels[i].model===options.after||pmodels[i].label===options.after){index=i+1;}}}
pmodels.splice.apply(pmodels,[index,0].concat(models));};exports.Product=Backbone.Model.extend({initialize:function(attr,options){_.extend(this,options);},get_price:function(pricelist,quantity){var self=this;var date=moment().startOf('day');if(pricelist===undefined){alert(_t('An error occurred when loading product prices. '+'Make sure all pricelists are available in the POS.'));}
var category_ids=[];var category=this.categ;while(category){category_ids.push(category.id);category=category.parent;}
var pricelist_items=_.filter(pricelist.items,function(item){return(!item.product_tmpl_id||item.product_tmpl_id[0]===self.product_tmpl_id)&&(!item.product_id||item.product_id[0]===self.id)&&(!item.categ_id||_.contains(category_ids,item.categ_id[0]))&&(!item.date_start||moment(item.date_start).isSameOrBefore(date))&&(!item.date_end||moment(item.date_end).isSameOrAfter(date));});var price=self.lst_price;_.find(pricelist_items,function(rule){if(rule.min_quantity&&quantity<rule.min_quantity){return false;}
if(rule.base==='pricelist'){price=self.get_price(rule.base_pricelist,quantity);}else if(rule.base==='standard_price'){price=self.standard_price;}
if(rule.compute_price==='fixed'){price=rule.fixed_price;return true;}else if(rule.compute_price==='percentage'){price=price-(price*(rule.percent_price/100));return true;}else{var price_limit=price;price=price-(price*(rule.price_discount/100));if(rule.price_round){price=round_pr(price,rule.price_round);}
if(rule.price_surcharge){price+=rule.price_surcharge;}
if(rule.price_min_margin){price=Math.max(price,price_limit+rule.price_min_margin);}
if(rule.price_max_margin){price=Math.min(price,price_limit+rule.price_max_margin);}
return true;}
return false;});return price;},});var orderline_id=1;exports.Orderline=Backbone.Model.extend({initialize:function(attr,options){this.pos=options.pos;this.order=options.order;if(options.json){this.init_from_JSON(options.json);return;}
this.product=options.product;this.set_product_lot(this.product);this.set_quantity(1);this.discount=0;this.discountStr='0';this.type='unit';this.selected=false;this.id=orderline_id++;this.price_manually_set=false;if(options.price){this.set_unit_price(options.price);}else{this.set_unit_price(this.product.get_price(this.order.pricelist,this.get_quantity()));}},init_from_JSON:function(json){this.product=this.pos.db.get_product_by_id(json.product_id);if(!this.product){console.error('ERROR: attempting to recover product ID',json.product_id,'not available in the point of sale. Correct the product or clean the browser cache.');}
this.set_product_lot(this.product);this.price=json.price_unit;this.set_discount(json.discount);this.set_quantity(json.qty,'do not recompute unit price');this.id=json.id;orderline_id=Math.max(this.id+1,orderline_id);var pack_lot_lines=json.pack_lot_ids;for(var i=0;i<pack_lot_lines.length;i++){var packlotline=pack_lot_lines[i][2];var pack_lot_line=new exports.Packlotline({},{'json':_.extend(packlotline,{'order_line':this})});this.pack_lot_lines.add(pack_lot_line);}},clone:function(){var orderline=new exports.Orderline({},{pos:this.pos,order:this.order,product:this.product,price:this.price,});orderline.order=null;orderline.quantity=this.quantity;orderline.quantityStr=this.quantityStr;orderline.discount=this.discount;orderline.price=this.price;orderline.type=this.type;orderline.selected=false;orderline.price_manually_set=this.price_manually_set;return orderline;},set_product_lot:function(product){this.has_product_lot=product.tracking!=='none'&&this.pos.config.use_existing_lots;this.pack_lot_lines=this.has_product_lot&&new PacklotlineCollection(null,{'order_line':this});},set_discount:function(discount){var disc=Math.min(Math.max(parseFloat(discount)||0,0),100);this.discount=disc;this.discountStr=''+disc;this.trigger('change',this);},get_discount:function(){return this.discount;},get_discount_str:function(){return this.discountStr;},get_product_type:function(){return this.type;},set_quantity:function(quantity,keep_price){this.order.assert_editable();if(quantity==='remove'){this.order.remove_orderline(this);return;}else{var quant=parseFloat(quantity)||0;var unit=this.get_unit();if(unit){if(unit.rounding){this.quantity=round_pr(quant,unit.rounding);var decimals=this.pos.dp['Product Unit of Measure'];this.quantity=round_di(this.quantity,decimals)
this.quantityStr=field_utils.format.float(this.quantity,{digits:[69,decimals]});}else{this.quantity=round_pr(quant,1);this.quantityStr=this.quantity.toFixed(0);}}else{this.quantity=quant;this.quantityStr=''+this.quantity;}}
if(!keep_price&&!this.price_manually_set){this.set_unit_price(this.product.get_price(this.order.pricelist,this.get_quantity()));this.order.fix_tax_included_price(this);}
this.trigger('change',this);},get_quantity:function(){return this.quantity;},get_quantity_str:function(){return this.quantityStr;},get_quantity_str_with_unit:function(){var unit=this.get_unit();if(unit&&!unit.is_pos_groupable){return this.quantityStr+' '+unit.name;}else{return this.quantityStr;}},get_required_number_of_lots:function(){var lots_required=1;if(this.product.tracking=='serial'){lots_required=this.quantity;}
return lots_required;},compute_lot_lines:function(){var pack_lot_lines=this.pack_lot_lines;var lines=pack_lot_lines.length;var lots_required=this.get_required_number_of_lots();if(lots_required>lines){for(var i=0;i<lots_required-lines;i++){pack_lot_lines.add(new exports.Packlotline({},{'order_line':this}));}}
if(lots_required<lines){var to_remove=lines-lots_required;var lot_lines=pack_lot_lines.sortBy('lot_name').slice(0,to_remove);pack_lot_lines.remove(lot_lines);}
return this.pack_lot_lines;},has_valid_product_lot:function(){if(!this.has_product_lot){return true;}
var valid_product_lot=this.pack_lot_lines.get_valid_lots();return this.get_required_number_of_lots()===valid_product_lot.length;},get_unit:function(){var unit_id=this.product.uom_id;if(!unit_id){return undefined;}
unit_id=unit_id[0];if(!this.pos){return undefined;}
return this.pos.units_by_id[unit_id];},get_product:function(){return this.product;},set_selected:function(selected){this.selected=selected;this.trigger('change',this);},is_selected:function(){return this.selected;},can_be_merged_with:function(orderline){if(this.get_product().id!==orderline.get_product().id){return false;}else if(!this.get_unit()||!this.get_unit().is_pos_groupable){return false;}else if(this.get_product_type()!==orderline.get_product_type()){return false;}else if(this.get_discount()>0){return false;}else if(this.price!==orderline.get_product().get_price(orderline.order.pricelist,this.get_quantity())){return false;}else if(this.product.tracking=='lot'){return false;}else{return true;}},merge:function(orderline){this.order.assert_editable();this.set_quantity(this.get_quantity()+orderline.get_quantity());},export_as_JSON:function(){var pack_lot_ids=[];if(this.has_product_lot){this.pack_lot_lines.each(_.bind(function(item){return pack_lot_ids.push([0,0,item.export_as_JSON()]);},this));}
return{qty:this.get_quantity(),price_unit:this.get_unit_price(),discount:this.get_discount(),product_id:this.get_product().id,tax_ids:[[6,false,_.map(this.get_applicable_taxes(),function(tax){return tax.id;})]],id:this.id,pack_lot_ids:pack_lot_ids};},export_for_printing:function(){return{quantity:this.get_quantity(),unit_name:this.get_unit().name,price:this.get_unit_display_price(),discount:this.get_discount(),product_name:this.get_product().display_name,product_name_wrapped:this.generate_wrapped_product_name(),price_display:this.get_display_price(),price_with_tax:this.get_price_with_tax(),price_without_tax:this.get_price_without_tax(),tax:this.get_tax(),product_description:this.get_product().description,product_description_sale:this.get_product().description_sale,};},generate_wrapped_product_name:function(){var MAX_LENGTH=24;var wrapped=[];var name=this.get_product().display_name;var current_line="";while(name.length>0){var space_index=name.indexOf(" ");if(space_index===-1){space_index=name.length;}
if(current_line.length+space_index>MAX_LENGTH){if(current_line.length){wrapped.push(current_line);}
current_line="";}
current_line+=name.slice(0,space_index+1);name=name.slice(space_index+1);}
if(current_line.length){wrapped.push(current_line);}
return wrapped;},set_unit_price:function(price){this.order.assert_editable();this.price=round_di(parseFloat(price)||0,this.pos.dp['Product Price']);this.trigger('change',this);},get_unit_price:function(){var digits=this.pos.dp['Product Price'];return parseFloat(round_di(this.price||0,digits).toFixed(digits));},get_unit_display_price:function(){if(this.pos.config.iface_tax_included==='total'){var quantity=this.quantity;this.quantity=1.0;var price=this.get_all_prices().priceWithTax;this.quantity=quantity;return price;}else{return this.get_unit_price();}},get_base_price:function(){var rounding=this.pos.currency.rounding;return round_pr(this.get_unit_price()*this.get_quantity()*(1-this.get_discount()/100),rounding);},get_display_price:function(){if(this.pos.config.iface_tax_included==='total'){return this.get_price_with_tax();}else{return this.get_base_price();}},get_price_without_tax:function(){return this.get_all_prices().priceWithoutTax;},get_price_with_tax:function(){return this.get_all_prices().priceWithTax;},get_tax:function(){return this.get_all_prices().tax;},get_applicable_taxes:function(){var i;var ptaxes_ids=this.get_product().taxes_id;var ptaxes_set={};for(i=0;i<ptaxes_ids.length;i++){ptaxes_set[ptaxes_ids[i]]=true;}
var taxes=[];for(i=0;i<this.pos.taxes.length;i++){if(ptaxes_set[this.pos.taxes[i].id]){taxes.push(this.pos.taxes[i]);}}
return taxes;},get_tax_details:function(){return this.get_all_prices().taxDetails;},get_taxes:function(){var taxes_ids=this.get_product().taxes_id;var taxes=[];for(var i=0;i<taxes_ids.length;i++){taxes.push(this.pos.taxes_by_id[taxes_ids[i]]);}
return taxes;},_map_tax_fiscal_position:function(tax){var current_order=this.pos.get_order();var order_fiscal_position=current_order&&current_order.fiscal_position;if(order_fiscal_position){var mapped_tax=_.find(order_fiscal_position.fiscal_position_taxes_by_id,function(fiscal_position_tax){return fiscal_position_tax.tax_src_id[0]===tax.id;});if(mapped_tax){tax=this.pos.taxes_by_id[mapped_tax.tax_dest_id[0]];}}
return tax;},_compute_all:function(tax,base_amount,quantity){if(tax.amount_type==='fixed'){var sign_base_amount=base_amount>=0?1:-1;return(Math.abs(tax.amount)*sign_base_amount)*quantity;}
if((tax.amount_type==='percent'&&!tax.price_include)||(tax.amount_type==='division'&&tax.price_include)){return base_amount*tax.amount/100;}
if(tax.amount_type==='percent'&&tax.price_include){return base_amount-(base_amount/(1+tax.amount/100));}
if(tax.amount_type==='division'&&!tax.price_include){return base_amount/(1-tax.amount/100)-base_amount;}
return false;},compute_all:function(taxes,price_unit,quantity,currency_rounding,no_map_tax){var self=this;var list_taxes=[];var currency_rounding_bak=currency_rounding;if(this.pos.company.tax_calculation_rounding_method=="round_globally"){currency_rounding=currency_rounding*0.00001;}
var total_excluded=round_pr(price_unit*quantity,currency_rounding);var total_included=total_excluded;var base=total_excluded;_(taxes).each(function(tax){if(!no_map_tax){tax=self._map_tax_fiscal_position(tax);}
if(!tax){return;}
if(tax.amount_type==='group'){var ret=self.compute_all(tax.children_tax_ids,price_unit,quantity,currency_rounding);total_excluded=ret.total_excluded;base=ret.total_excluded;total_included=ret.total_included;list_taxes=list_taxes.concat(ret.taxes);}
else{var tax_amount=self._compute_all(tax,base,quantity);tax_amount=round_pr(tax_amount,currency_rounding);if(tax_amount){if(tax.price_include){total_excluded-=tax_amount;base-=tax_amount;}
else{total_included+=tax_amount;}
if(tax.include_base_amount){base+=tax_amount;}
var data={id:tax.id,amount:tax_amount,name:tax.name,};list_taxes.push(data);}}});return{taxes:list_taxes,total_excluded:round_pr(total_excluded,currency_rounding_bak),total_included:round_pr(total_included,currency_rounding_bak)};},get_all_prices:function(){var price_unit=this.get_unit_price()*(1.0-(this.get_discount()/100.0));var taxtotal=0;var product=this.get_product();var taxes_ids=product.taxes_id;var taxes=this.pos.taxes;var taxdetail={};var product_taxes=[];_(taxes_ids).each(function(el){product_taxes.push(_.detect(taxes,function(t){return t.id===el;}));});var all_taxes=this.compute_all(product_taxes,price_unit,this.get_quantity(),this.pos.currency.rounding);_(all_taxes.taxes).each(function(tax){taxtotal+=tax.amount;taxdetail[tax.id]=tax.amount;});return{"priceWithTax":all_taxes.total_included,"priceWithoutTax":all_taxes.total_excluded,"tax":taxtotal,"taxDetails":taxdetail,};},});var OrderlineCollection=Backbone.Collection.extend({model:exports.Orderline,});exports.Packlotline=Backbone.Model.extend({defaults:{lot_name:null},initialize:function(attributes,options){this.order_line=options.order_line;if(options.json){this.init_from_JSON(options.json);return;}},init_from_JSON:function(json){this.order_line=json.order_line;this.set_lot_name(json.lot_name);},set_lot_name:function(name){this.set({lot_name:_.str.trim(name)||null});},get_lot_name:function(){return this.get('lot_name');},export_as_JSON:function(){return{lot_name:this.get_lot_name(),};},add:function(){var order_line=this.order_line,index=this.collection.indexOf(this);var new_lot_model=new exports.Packlotline({},{'order_line':this.order_line});this.collection.add(new_lot_model,{at:index+1});return new_lot_model;},remove:function(){this.collection.remove(this);}});var PacklotlineCollection=Backbone.Collection.extend({model:exports.Packlotline,initialize:function(models,options){this.order_line=options.order_line;},get_empty_model:function(){return this.findWhere({'lot_name':null});},remove_empty_model:function(){this.remove(this.where({'lot_name':null}));},get_valid_lots:function(){return this.filter(function(model){return model.get('lot_name');});},set_quantity_by_lot:function(){if(this.order_line.product.tracking=='serial'){var valid_lots=this.get_valid_lots();this.order_line.set_quantity(valid_lots.length);}}});exports.Paymentline=Backbone.Model.extend({initialize:function(attributes,options){this.pos=options.pos;this.order=options.order;this.amount=0;this.selected=false;if(options.json){this.init_from_JSON(options.json);return;}
this.cashregister=options.cashregister;this.name=this.cashregister.journal_id[1];},init_from_JSON:function(json){this.amount=json.amount;this.cashregister=this.pos.cashregisters_by_id[json.statement_id];this.name=this.cashregister.journal_id[1];},set_amount:function(value){this.order.assert_editable();this.amount=round_di(parseFloat(value)||0,this.pos.currency.decimals);this.trigger('change',this);},get_amount:function(){return this.amount;},get_amount_str:function(){return field_utils.format.float(this.amount,{digits:[69,this.pos.currency.decimals]});},set_selected:function(selected){if(this.selected!==selected){this.selected=selected;this.trigger('change',this);}},get_type:function(){return this.cashregister.journal.type;},export_as_JSON:function(){return{name:time.datetime_to_str(new Date()),statement_id:this.cashregister.id,account_id:this.cashregister.account_id[0],journal_id:this.cashregister.journal_id[0],amount:this.get_amount()};},export_for_printing:function(){return{amount:this.get_amount(),journal:this.cashregister.journal_id[1],};},});var PaymentlineCollection=Backbone.Collection.extend({model:exports.Paymentline,});exports.Order=Backbone.Model.extend({initialize:function(attributes,options){Backbone.Model.prototype.initialize.apply(this,arguments);var self=this;options=options||{};this.init_locked=true;this.pos=options.pos;this.selected_orderline=undefined;this.selected_paymentline=undefined;this.screen_data={};this.temporary=options.temporary||false;this.creation_date=new Date();this.to_invoice=false;this.orderlines=new OrderlineCollection();this.paymentlines=new PaymentlineCollection();this.pos_session_id=this.pos.pos_session.id;this.finalized=false;this.set_pricelist(this.pos.default_pricelist);this.set({client:null});if(options.json){this.init_from_JSON(options.json);}else{this.sequence_number=this.pos.pos_session.sequence_number++;this.uid=this.generate_unique_id();this.name=_t("Order ")+this.uid;this.validation_date=undefined;this.fiscal_position=_.find(this.pos.fiscal_positions,function(fp){return fp.id===self.pos.config.default_fiscal_position_id[0];});}
this.on('change',function(){this.save_to_db("order:change");},this);this.orderlines.on('change',function(){this.save_to_db("orderline:change");},this);this.orderlines.on('add',function(){this.save_to_db("orderline:add");},this);this.orderlines.on('remove',function(){this.save_to_db("orderline:remove");},this);this.paymentlines.on('change',function(){this.save_to_db("paymentline:change");},this);this.paymentlines.on('add',function(){this.save_to_db("paymentline:add");},this);this.paymentlines.on('remove',function(){this.save_to_db("paymentline:rem");},this);if(this.pos.config.iface_customer_facing_display){this.orderlines.on('change',this.pos.send_current_order_to_customer_facing_display,this.pos);this.orderlines.on('remove',this.pos.send_current_order_to_customer_facing_display,this.pos);this.paymentlines.on('change',this.pos.send_current_order_to_customer_facing_display,this.pos);this.paymentlines.on('remove',this.pos.send_current_order_to_customer_facing_display,this.pos);}
this.init_locked=false;this.save_to_db();return this;},save_to_db:function(){if(!this.temporary&&!this.init_locked){this.pos.db.save_unpaid_order(this);}},init_from_JSON:function(json){var client;this.sequence_number=json.sequence_number;this.pos.pos_session.sequence_number=Math.max(this.sequence_number+1,this.pos.pos_session.sequence_number);this.session_id=json.pos_session_id;this.uid=json.uid;this.name=_t("Order ")+this.uid;this.validation_date=json.creation_date;if(json.fiscal_position_id){var fiscal_position=_.find(this.pos.fiscal_positions,function(fp){return fp.id===json.fiscal_position_id;});if(fiscal_position){this.fiscal_position=fiscal_position;}else{console.error('ERROR: trying to load a fiscal position not available in the pos');}}
if(json.pricelist_id){this.pricelist=_.find(this.pos.pricelists,function(pricelist){return pricelist.id===json.pricelist_id;});}else{this.pricelist=this.pos.default_pricelist;}
if(json.partner_id){client=this.pos.db.get_partner_by_id(json.partner_id);if(!client){console.error('ERROR: trying to load a parner not available in the pos');}}else{client=null;}
this.set_client(client);this.temporary=false;this.to_invoice=false;var orderlines=json.lines;for(var i=0;i<orderlines.length;i++){var orderline=orderlines[i][2];this.add_orderline(new exports.Orderline({},{pos:this.pos,order:this,json:orderline}));}
var paymentlines=json.statement_ids;for(var i=0;i<paymentlines.length;i++){var paymentline=paymentlines[i][2];var newpaymentline=new exports.Paymentline({},{pos:this.pos,order:this,json:paymentline});this.paymentlines.add(newpaymentline);if(i===paymentlines.length-1){this.select_paymentline(newpaymentline);}}},export_as_JSON:function(){var orderLines,paymentLines;orderLines=[];this.orderlines.each(_.bind(function(item){return orderLines.push([0,0,item.export_as_JSON()]);},this));paymentLines=[];this.paymentlines.each(_.bind(function(item){return paymentLines.push([0,0,item.export_as_JSON()]);},this));return{name:this.get_name(),amount_paid:this.get_total_paid(),amount_total:this.get_total_with_tax(),amount_tax:this.get_total_tax(),amount_return:this.get_change(),lines:orderLines,statement_ids:paymentLines,pos_session_id:this.pos_session_id,pricelist_id:this.pricelist?this.pricelist.id:false,partner_id:this.get_client()?this.get_client().id:false,user_id:this.pos.get_cashier().id,uid:this.uid,sequence_number:this.sequence_number,creation_date:this.validation_date||this.creation_date,fiscal_position_id:this.fiscal_position?this.fiscal_position.id:false};},export_for_printing:function(){var orderlines=[];var self=this;this.orderlines.each(function(orderline){orderlines.push(orderline.export_for_printing());});var paymentlines=[];this.paymentlines.each(function(paymentline){paymentlines.push(paymentline.export_for_printing());});var client=this.get('client');var cashier=this.pos.get_cashier();var company=this.pos.company;var shop=this.pos.shop;var date=new Date();function is_xml(subreceipt){return subreceipt?(subreceipt.split('\n')[0].indexOf('<!DOCTYPE QWEB')>=0):false;}
function render_xml(subreceipt){if(!is_xml(subreceipt)){return subreceipt;}else{subreceipt=subreceipt.split('\n').slice(1).join('\n');var qweb=new QWeb2.Engine();qweb.debug=core.debug;qweb.default_dict=_.clone(QWeb.default_dict);qweb.add_template('<templates><t t-name="subreceipt">'+subreceipt+'</t></templates>');return qweb.render('subreceipt',{'pos':self.pos,'widget':self.pos.chrome,'order':self,'receipt':receipt});}}
var receipt={orderlines:orderlines,paymentlines:paymentlines,subtotal:this.get_subtotal(),total_with_tax:this.get_total_with_tax(),total_without_tax:this.get_total_without_tax(),total_tax:this.get_total_tax(),total_paid:this.get_total_paid(),total_discount:this.get_total_discount(),tax_details:this.get_tax_details(),change:this.get_change(),name:this.get_name(),client:client?client.name:null,invoice_id:null,cashier:cashier?cashier.name:null,precision:{price:2,money:2,quantity:3,},date:{year:date.getFullYear(),month:date.getMonth(),date:date.getDate(),day:date.getDay(),hour:date.getHours(),minute:date.getMinutes(),isostring:date.toISOString(),localestring:date.toLocaleString(),},company:{email:company.email,website:company.website,company_registry:company.company_registry,contact_address:company.partner_id[1],vat:company.vat,vat_label:company.country&&company.country.vat_label||'',name:company.name,phone:company.phone,logo:this.pos.company_logo_base64,},shop:{name:shop.name,},currency:this.pos.currency,};if(is_xml(this.pos.config.receipt_header)){receipt.header='';receipt.header_xml=render_xml(this.pos.config.receipt_header);}else{receipt.header=this.pos.config.receipt_header||'';}
if(is_xml(this.pos.config.receipt_footer)){receipt.footer='';receipt.footer_xml=render_xml(this.pos.config.receipt_footer);}else{receipt.footer=this.pos.config.receipt_footer||'';}
return receipt;},is_empty:function(){return this.orderlines.models.length===0;},generate_unique_id:function(){function zero_pad(num,size){var s=""+num;while(s.length<size){s="0"+s;}
return s;}
return zero_pad(this.pos.pos_session.id,5)+'-'+
zero_pad(this.pos.pos_session.login_number,3)+'-'+
zero_pad(this.sequence_number,4);},get_name:function(){return this.name;},assert_editable:function(){if(this.finalized){throw new Error('Finalized Order cannot be modified');}},add_orderline:function(line){this.assert_editable();if(line.order){line.order.remove_orderline(line);}
line.order=this;this.orderlines.add(line);this.select_orderline(this.get_last_orderline());},get_orderline:function(id){var orderlines=this.orderlines.models;for(var i=0;i<orderlines.length;i++){if(orderlines[i].id===id){return orderlines[i];}}
return null;},get_orderlines:function(){return this.orderlines.models;},get_last_orderline:function(){return this.orderlines.at(this.orderlines.length-1);},get_tip:function(){var tip_product=this.pos.db.get_product_by_id(this.pos.config.tip_product_id[0]);var lines=this.get_orderlines();if(!tip_product){return 0;}else{for(var i=0;i<lines.length;i++){if(lines[i].get_product()===tip_product){return lines[i].get_unit_price();}}
return 0;}},initialize_validation_date:function(){this.validation_date=new Date();this.formatted_validation_date=field_utils.format.datetime(moment(this.validation_date),{},{timezone:false});},set_tip:function(tip){var tip_product=this.pos.db.get_product_by_id(this.pos.config.tip_product_id[0]);var lines=this.get_orderlines();if(tip_product){for(var i=0;i<lines.length;i++){if(lines[i].get_product()===tip_product){lines[i].set_unit_price(tip);return;}}
this.add_product(tip_product,{quantity:1,price:tip});}},set_pricelist:function(pricelist){var self=this;this.pricelist=pricelist;var lines_to_recompute=_.filter(this.get_orderlines(),function(line){return!line.price_manually_set;});_.each(lines_to_recompute,function(line){line.set_unit_price(line.product.get_price(self.pricelist,line.get_quantity()));self.fix_tax_included_price(line);});this.trigger('change');},remove_orderline:function(line){this.assert_editable();this.orderlines.remove(line);this.select_orderline(this.get_last_orderline());},fix_tax_included_price:function(line){if(this.fiscal_position){var unit_price=line.price;var taxes=line.get_taxes();var mapped_included_taxes=[];_(taxes).each(function(tax){var line_tax=line._map_tax_fiscal_position(tax);if(tax.price_include&&tax.id!=line_tax.id){mapped_included_taxes.push(tax);}})
if(mapped_included_taxes.length>0){unit_price=line.compute_all(mapped_included_taxes,unit_price,1,this.pos.currency.rounding,true).total_excluded;}
line.set_unit_price(unit_price);}},add_product:function(product,options){if(this._printed){this.destroy();return this.pos.get_order().add_product(product,options);}
this.assert_editable();options=options||{};var attr=JSON.parse(JSON.stringify(product));attr.pos=this.pos;attr.order=this;var line=new exports.Orderline({},{pos:this.pos,order:this,product:product});if(options.quantity!==undefined){line.set_quantity(options.quantity);}
if(options.price!==undefined){line.set_unit_price(options.price);}
this.fix_tax_included_price(line);if(options.discount!==undefined){line.set_discount(options.discount);}
if(options.extras!==undefined){for(var prop in options.extras){line[prop]=options.extras[prop];}}
var to_merge_orderline;for(var i=0;i<this.orderlines.length;i++){if(this.orderlines.at(i).can_be_merged_with(line)&&options.merge!==false){to_merge_orderline=this.orderlines.at(i);}}
if(to_merge_orderline){to_merge_orderline.merge(line);}else{this.orderlines.add(line);}
this.select_orderline(this.get_last_orderline());if(line.has_product_lot){this.display_lot_popup();}},get_selected_orderline:function(){return this.selected_orderline;},select_orderline:function(line){if(line){if(line!==this.selected_orderline){if(this.selected_orderline){this.selected_orderline.set_selected(false);}
this.selected_orderline=line;this.selected_orderline.set_selected(true);}}else{this.selected_orderline=undefined;}},deselect_orderline:function(){if(this.selected_orderline){this.selected_orderline.set_selected(false);this.selected_orderline=undefined;}},display_lot_popup:function(){var order_line=this.get_selected_orderline();if(order_line){var pack_lot_lines=order_line.compute_lot_lines();this.pos.gui.show_popup('packlotline',{'title':_t('Lot/Serial Number(s) Required'),'pack_lot_lines':pack_lot_lines,'order_line':order_line,'order':this,});}},add_paymentline:function(cashregister){this.assert_editable();var newPaymentline=new exports.Paymentline({},{order:this,cashregister:cashregister,pos:this.pos});if(cashregister.journal.type!=='cash'||this.pos.config.iface_precompute_cash){newPaymentline.set_amount(this.get_due());}
this.paymentlines.add(newPaymentline);this.select_paymentline(newPaymentline);},get_paymentlines:function(){return this.paymentlines.models;},remove_paymentline:function(line){this.assert_editable();if(this.selected_paymentline===line){this.select_paymentline(undefined);}
this.paymentlines.remove(line);},clean_empty_paymentlines:function(){var lines=this.paymentlines.models;var empty=[];for(var i=0;i<lines.length;i++){if(!lines[i].get_amount()){empty.push(lines[i]);}}
for(var i=0;i<empty.length;i++){this.remove_paymentline(empty[i]);}},select_paymentline:function(line){if(line!==this.selected_paymentline){if(this.selected_paymentline){this.selected_paymentline.set_selected(false);}
this.selected_paymentline=line;if(this.selected_paymentline){this.selected_paymentline.set_selected(true);}
this.trigger('change:selected_paymentline',this.selected_paymentline);}},get_subtotal:function(){return round_pr(this.orderlines.reduce((function(sum,orderLine){return sum+orderLine.get_display_price();}),0),this.pos.currency.rounding);},get_total_with_tax:function(){return this.get_total_without_tax()+this.get_total_tax();},get_total_without_tax:function(){return round_pr(this.orderlines.reduce((function(sum,orderLine){return sum+orderLine.get_price_without_tax();}),0),this.pos.currency.rounding);},get_total_discount:function(){return round_pr(this.orderlines.reduce((function(sum,orderLine){return sum+(orderLine.get_unit_price()*(orderLine.get_discount()/100)*orderLine.get_quantity());}),0),this.pos.currency.rounding);},get_total_tax:function(){return round_pr(this.orderlines.reduce((function(sum,orderLine){return sum+orderLine.get_tax();}),0),this.pos.currency.rounding);},get_total_paid:function(){return round_pr(this.paymentlines.reduce((function(sum,paymentLine){return sum+paymentLine.get_amount();}),0),this.pos.currency.rounding);},get_tax_details:function(){var details={};var fulldetails=[];this.orderlines.each(function(line){var ldetails=line.get_tax_details();for(var id in ldetails){if(ldetails.hasOwnProperty(id)){details[id]=(details[id]||0)+ldetails[id];}}});for(var id in details){if(details.hasOwnProperty(id)){fulldetails.push({amount:details[id],tax:this.pos.taxes_by_id[id],name:this.pos.taxes_by_id[id].name});}}
return fulldetails;},get_total_for_category_with_tax:function(categ_id){var total=0;var self=this;if(categ_id instanceof Array){for(var i=0;i<categ_id.length;i++){total+=this.get_total_for_category_with_tax(categ_id[i]);}
return total;}
this.orderlines.each(function(line){if(self.pos.db.category_contains(categ_id,line.product.id)){total+=line.get_price_with_tax();}});return total;},get_total_for_taxes:function(tax_id){var total=0;if(!(tax_id instanceof Array)){tax_id=[tax_id];}
var tax_set={};for(var i=0;i<tax_id.length;i++){tax_set[tax_id[i]]=true;}
this.orderlines.each(function(line){var taxes_ids=line.get_product().taxes_id;for(var i=0;i<taxes_ids.length;i++){if(tax_set[taxes_ids[i]]){total+=line.get_price_with_tax();return;}}});return total;},get_change:function(paymentline){if(!paymentline){var change=this.get_total_paid()-this.get_total_with_tax();}else{var change=-this.get_total_with_tax();var lines=this.paymentlines.models;for(var i=0;i<lines.length;i++){change+=lines[i].get_amount();if(lines[i]===paymentline){break;}}}
return round_pr(Math.max(0,change),this.pos.currency.rounding);},get_due:function(paymentline){if(!paymentline){var due=this.get_total_with_tax()-this.get_total_paid();}else{var due=this.get_total_with_tax();var lines=this.paymentlines.models;for(var i=0;i<lines.length;i++){if(lines[i]===paymentline){break;}else{due-=lines[i].get_amount();}}}
return round_pr(due,this.pos.currency.rounding);},is_paid:function(){return this.get_due()<=0;},is_paid_with_cash:function(){return!!this.paymentlines.find(function(pl){return pl.cashregister.journal.type==='cash';});},finalize:function(){this.destroy();},destroy:function(){Backbone.Model.prototype.destroy.apply(this,arguments);this.pos.db.remove_unpaid_order(this);},set_to_invoice:function(to_invoice){this.assert_editable();this.to_invoice=to_invoice;},is_to_invoice:function(){return this.to_invoice;},set_client:function(client){this.assert_editable();this.set('client',client);},get_client:function(){return this.get('client');},get_client_name:function(){var client=this.get('client');return client?client.name:"";},set_screen_data:function(key,value){if(arguments.length===2){this.screen_data[key]=value;}else if(arguments.length===1){for(var key in arguments[0]){this.screen_data[key]=arguments[0][key];}}},get_screen_data:function(key){return this.screen_data[key];},});var OrderCollection=Backbone.Collection.extend({model:exports.Order,});exports.NumpadState=Backbone.Model.extend({defaults:{buffer:"0",mode:"quantity"},appendNewChar:function(newChar){var oldBuffer;oldBuffer=this.get('buffer');if(oldBuffer==='0'){this.set({buffer:newChar});}else if(oldBuffer==='-0'){this.set({buffer:"-"+newChar});}else{this.set({buffer:(this.get('buffer'))+newChar});}
this.trigger('set_value',this.get('buffer'));},deleteLastChar:function(){if(this.get('buffer')===""){if(this.get('mode')==='quantity'){this.trigger('set_value','remove');}else{this.trigger('set_value',this.get('buffer'));}}else{var newBuffer=this.get('buffer').slice(0,-1)||"";this.set({buffer:newBuffer});this.trigger('set_value',this.get('buffer'));}},switchSign:function(){var oldBuffer;oldBuffer=this.get('buffer');this.set({buffer:oldBuffer[0]==='-'?oldBuffer.substr(1):"-"+oldBuffer});this.trigger('set_value',this.get('buffer'));},changeMode:function(newMode){this.set({buffer:"0",mode:newMode});},reset:function(){this.set({buffer:"0",mode:"quantity"});},resetValue:function(){this.set({buffer:'0'});},});return exports;});;

/* /point_of_sale/static/src/js/widget_base.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.BaseWidget',function(require){"use strict";var field_utils=require('web.field_utils');var utils=require('web.utils');var Widget=require('web.Widget');var round_di=utils.round_decimals;var PosBaseWidget=Widget.extend({init:function(parent,options){this._super(parent);options=options||{};this.pos=options.pos||(parent?parent.pos:undefined);this.chrome=options.chrome||(parent?parent.chrome:undefined);this.gui=options.gui||(parent?parent.gui:undefined);},format_currency:function(amount,precision){var currency=(this.pos&&this.pos.currency)?this.pos.currency:{symbol:'$',position:'after',rounding:0.01,decimals:2};amount=this.format_currency_no_symbol(amount,precision);if(currency.position==='after'){return amount+' '+(currency.symbol||'');}else{return(currency.symbol||'')+' '+amount;}},format_currency_no_symbol:function(amount,precision){var currency=(this.pos&&this.pos.currency)?this.pos.currency:{symbol:'$',position:'after',rounding:0.01,decimals:2};var decimals=currency.decimals;if(precision&&this.pos.dp[precision]!==undefined){decimals=this.pos.dp[precision];}
if(typeof amount==='number'){amount=round_di(amount,decimals).toFixed(decimals);amount=field_utils.format.float(round_di(amount,decimals),{digits:[69,decimals]});}
return amount;},show:function(){this.$el.removeClass('oe_hidden');},hide:function(){this.$el.addClass('oe_hidden');},format_pr:function(value,precision){var decimals=precision>0?Math.max(0,Math.ceil(Math.log(1.0/precision)/Math.log(10))):0;return value.toFixed(decimals);},format_fixed:function(value,integer_width,decimal_width){value=value.toFixed(decimal_width||0);var width=value.indexOf('.');if(width<0){width=value.length;}
var missing=integer_width-width;while(missing>0){value='0'+value;missing--;}
return value;},});return PosBaseWidget;});;

/* /point_of_sale/static/src/js/keyboard.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.keyboard',function(require){"use strict";var Widget=require('web.Widget');var OnscreenKeyboardWidget=Widget.extend({template:'OnscreenKeyboardSimple',init:function(parent,options){this._super(parent,options);options=options||{};this.keyboard_model=options.keyboard_model||'simple';if(this.keyboard_model==='full'){this.template='OnscreenKeyboardFull';}
this.input_selector=options.input_selector||'.searchbox input';this.$target=null;this.capslock=false;this.shift=false;this.numlock=false;},connect:function(target){var self=this;this.$target=$(target);this.$target.focus(function(){self.show();});},generateEvent:function(type,key){var event=document.createEvent("KeyboardEvent");var initMethod=event.initKeyboardEvent?'initKeyboardEvent':'initKeyEvent';event[initMethod](type,true,true,window,false,false,false,false,((typeof key.code==='undefined')?key.char.charCodeAt(0):key.code),((typeof key.char==='undefined')?String.fromCharCode(key.code):key.char));return event;},writeCharacter:function(character){var input=this.$target[0];input.dispatchEvent(this.generateEvent('keypress',{char:character}));if(character!=='\n'){input.value+=character;}
input.dispatchEvent(this.generateEvent('keyup',{char:character}));},deleteCharacter:function(){var input=this.$target[0];input.dispatchEvent(this.generateEvent('keypress',{code:8}));input.value=input.value.substr(0,input.value.length-1);input.dispatchEvent(this.generateEvent('keyup',{code:8}));},deleteAllCharacters:function(){var input=this.$target[0];if(input.value){input.dispatchEvent(this.generateEvent('keypress',{code:8}));input.value="";input.dispatchEvent(this.generateEvent('keyup',{code:8}));}},show:function(){$('.keyboard_frame').show().css({'height':'235px'});},hide:function(){$('.keyboard_frame').css({'height':'0'}).hide();this.reset();},toggleShift:function(){$('.letter').toggleClass('uppercase');$('.symbol span').toggle();this.shift=(this.shift===true)?false:true;this.capslock=false;},toggleCapsLock:function(){$('.letter').toggleClass('uppercase');this.capslock=true;},toggleNumLock:function(){$('.symbol span').toggle();$('.numlock span').toggle();this.numlock=(this.numlock===true)?false:true;},removeShift:function(){if(this.shift===true){$('.symbol span').toggle();if(this.capslock===false)$('.letter').toggleClass('uppercase');this.shift=false;}},reset:function(){if(this.shift){this.toggleShift();}
if(this.capslock){this.toggleCapsLock();}
if(this.numlock){this.toggleNumLock();}},start:function(){var self=this;$('.close_button').click(function(){self.deleteAllCharacters();self.hide();});$('.keyboard li').click(function(){var $this=$(this),character=$this.html();if($this.hasClass('left-shift')||$this.hasClass('right-shift')){self.toggleShift();return false;}
if($this.hasClass('capslock')){self.toggleCapsLock();return false;}
if($this.hasClass('delete')){self.deleteCharacter();return false;}
if($this.hasClass('numlock')){self.toggleNumLock();return false;}
if($this.hasClass('symbol'))character=$('span:visible',$this).html();if($this.hasClass('space'))character=' ';if($this.hasClass('tab'))character="\t";if($this.hasClass('return'))character="\n";if($this.hasClass('uppercase'))character=character.toUpperCase();self.removeShift();self.writeCharacter(character);});},});return{OnscreenKeyboardWidget:OnscreenKeyboardWidget,};});;

/* /point_of_sale/static/src/js/chrome.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.chrome',function(require){"use strict";var PosBaseWidget=require('point_of_sale.BaseWidget');var gui=require('point_of_sale.gui');var keyboard=require('point_of_sale.keyboard');var models=require('point_of_sale.models');var core=require('web.core');var ajax=require('web.ajax');var CrashManager=require('web.CrashManager');var BarcodeEvents=require('barcodes.BarcodeEvents').BarcodeEvents;var _t=core._t;var _lt=core._lt;var QWeb=core.qweb;var OrderSelectorWidget=PosBaseWidget.extend({template:'OrderSelectorWidget',init:function(parent,options){this._super(parent,options);this.pos.get('orders').bind('add remove change',this.renderElement,this);this.pos.bind('change:selectedOrder',this.renderElement,this);},get_order_by_uid:function(uid){var orders=this.pos.get_order_list();for(var i=0;i<orders.length;i++){if(orders[i].uid===uid){return orders[i];}}
return undefined;},order_click_handler:function(event,$el){var order=this.get_order_by_uid($el.data('uid'));if(order){this.pos.set_order(order);}},neworder_click_handler:function(event,$el){this.pos.add_new_order();},deleteorder_click_handler:function(event,$el){var self=this;var order=this.pos.get_order();if(!order){return;}else if(!order.is_empty()){this.gui.show_popup('confirm',{'title':_t('Destroy Current Order ?'),'body':_t('You will lose any data associated with the current order'),confirm:function(){self.pos.delete_current_order();},});}else{this.pos.delete_current_order();}},renderElement:function(){var self=this;this._super();this.$('.order-button.select-order').click(function(event){self.order_click_handler(event,$(this));});this.$('.neworder-button').click(function(event){self.neworder_click_handler(event,$(this));});this.$('.deleteorder-button').click(function(event){self.deleteorder_click_handler(event,$(this));});},});var UsernameWidget=PosBaseWidget.extend({template:'UsernameWidget',init:function(parent,options){options=options||{};this._super(parent,options);},renderElement:function(){var self=this;this._super();this.$el.click(function(){self.click_username();});},click_username:function(){var self=this;this.gui.select_user({'security':true,'current_user':this.pos.get_cashier(),'title':_t('Change Cashier'),}).then(function(user){self.pos.set_cashier(user);self.renderElement();});},get_name:function(){var user=this.pos.get_cashier();if(user){return user.name;}else{return"";}},});var HeaderButtonWidget=PosBaseWidget.extend({template:'HeaderButtonWidget',init:function(parent,options){options=options||{};this._super(parent,options);this.action=options.action;this.label=options.label;},renderElement:function(){var self=this;this._super();if(this.action){this.$el.click(function(){self.action();});}},show:function(){this.$el.removeClass('oe_hidden');},hide:function(){this.$el.addClass('oe_hidden');},});var DebugWidget=PosBaseWidget.extend({template:"DebugWidget",eans:{admin_badge:'0410100000006',client_badge:'0420200000004',invalid_ean:'1232456',soda_33cl:'5449000000996',oranges_kg:'2100002031410',lemon_price:'2301000001560',unknown_product:'9900000000004',},events:['open_cashbox','print_receipt','scale_read',],init:function(parent,options){this._super(parent,options);var self=this;this.dragging=false;this.dragpos={x:0,y:0};function eventpos(event){if(event.touches&&event.touches[0]){return{x:event.touches[0].screenX,y:event.touches[0].screenY};}else{return{x:event.screenX,y:event.screenY};}}
this.dragend_handler=function(event){self.dragging=false;};this.dragstart_handler=function(event){self.dragging=true;self.dragpos=eventpos(event);};this.dragmove_handler=function(event){if(self.dragging){var top=this.offsetTop;var left=this.offsetLeft;var pos=eventpos(event);var dx=pos.x-self.dragpos.x;var dy=pos.y-self.dragpos.y;self.dragpos=pos;this.style.right='auto';this.style.bottom='auto';this.style.left=left+dx+'px';this.style.top=top+dy+'px';}
event.preventDefault();event.stopPropagation();};},show:function(){this.$el.css({opacity:0});this.$el.removeClass('oe_hidden');this.$el.animate({opacity:1},250,'swing');},hide:function(){var self=this;this.$el.animate({opacity:0,},250,'swing',function(){self.$el.addClass('oe_hidden');});},start:function(){var self=this;if(this.pos.debug){this.show();}
this.el.addEventListener('mouseleave',this.dragend_handler);this.el.addEventListener('mouseup',this.dragend_handler);this.el.addEventListener('touchend',this.dragend_handler);this.el.addEventListener('touchcancel',this.dragend_handler);this.el.addEventListener('mousedown',this.dragstart_handler);this.el.addEventListener('touchstart',this.dragstart_handler);this.el.addEventListener('mousemove',this.dragmove_handler);this.el.addEventListener('touchmove',this.dragmove_handler);this.$('.toggle').click(function(){self.hide();});this.$('.button.set_weight').click(function(){var kg=Number(self.$('input.weight').val());if(!isNaN(kg)){self.pos.proxy.debug_set_weight(kg);}});this.$('.button.reset_weight').click(function(){self.$('input.weight').val('');self.pos.proxy.debug_reset_weight();});this.$('.button.custom_ean').click(function(){var ean=self.pos.barcode_reader.barcode_parser.sanitize_ean(self.$('input.ean').val()||'0');self.$('input.ean').val(ean);self.pos.barcode_reader.scan(ean);});this.$('.button.barcode').click(function(){self.pos.barcode_reader.scan(self.$('input.ean').val());});this.$('.button.delete_orders').click(function(){self.gui.show_popup('confirm',{'title':_t('Delete Paid Orders ?'),'body':_t('This operation will permanently destroy all paid orders from the local storage. You will lose all the data. This operation cannot be undone.'),confirm:function(){self.pos.db.remove_all_orders();self.pos.set({synch:{state:'connected',pending:0}});},});});this.$('.button.delete_unpaid_orders').click(function(){self.gui.show_popup('confirm',{'title':_t('Delete Unpaid Orders ?'),'body':_t('This operation will destroy all unpaid orders in the browser. You will lose all the unsaved data and exit the point of sale. This operation cannot be undone.'),confirm:function(){self.pos.db.remove_all_unpaid_orders();window.location='/';},});});this.$('.button.export_unpaid_orders').click(function(){self.gui.prepare_download_link(self.pos.export_unpaid_orders(),_t("unpaid orders")+' '+moment().format('YYYY-MM-DD-HH-mm-ss')+'.json',".export_unpaid_orders",".download_unpaid_orders");});this.$('.button.export_paid_orders').click(function(){self.gui.prepare_download_link(self.pos.export_paid_orders(),_t("paid orders")+' '+moment().format('YYYY-MM-DD-HH-mm-ss')+'.json',".export_paid_orders",".download_paid_orders");});this.$('.button.display_refresh').click(function(){self.pos.proxy.message('display_refresh',{});});this.$('.button.import_orders input').on('change',function(event){var file=event.target.files[0];if(file){var reader=new FileReader();reader.onload=function(event){var report=self.pos.import_orders(event.target.result);self.gui.show_popup('orderimport',{report:report});};reader.readAsText(file);}});_.each(this.events,function(name){self.pos.proxy.add_notification(name,function(){self.$('.event.'+name).stop().clearQueue().css({'background-color':'#6CD11D'});self.$('.event.'+name).animate({'background-color':'#1E1E1E'},2000);});});},});var StatusWidget=PosBaseWidget.extend({status:['connected','connecting','disconnected','warning','error'],set_status:function(status,msg){for(var i=0;i<this.status.length;i++){this.$('.js_'+this.status[i]).addClass('oe_hidden');}
this.$('.js_'+status).removeClass('oe_hidden');if(msg){this.$('.js_msg').removeClass('oe_hidden').html(msg);}else{this.$('.js_msg').addClass('oe_hidden').html('');}},});var SynchNotificationWidget=StatusWidget.extend({template:'SynchNotificationWidget',start:function(){var self=this;this.pos.bind('change:synch',function(pos,synch){self.set_status(synch.state,synch.pending);});this.$el.click(function(){self.pos.push_order(null,{'show_error':true});});},});var ProxyStatusWidget=StatusWidget.extend({template:'ProxyStatusWidget',set_smart_status:function(status){if(status.status==='connected'){var warning=false;var msg='';if(this.pos.config.iface_scan_via_proxy){var scanner=status.drivers.scanner?status.drivers.scanner.status:false;if(scanner!='connected'&&scanner!='connecting'){warning=true;msg+=_t('Scanner');}}
if(this.pos.config.iface_print_via_proxy||this.pos.config.iface_cashdrawer){var printer=status.drivers.escpos?status.drivers.escpos.status:false;if(printer!='connected'&&printer!='connecting'){warning=true;msg=msg?msg+' & ':msg;msg+=_t('Printer');}}
if(this.pos.config.iface_electronic_scale){var scale=status.drivers.scale?status.drivers.scale.status:false;if(scale!='connected'&&scale!='connecting'){warning=true;msg=msg?msg+' & ':msg;msg+=_t('Scale');}}
msg=msg?msg+' '+_t('Offline'):msg;this.set_status(warning?'warning':'connected',msg);}else{this.set_status(status.status,'');}},start:function(){var self=this;this.set_smart_status(this.pos.proxy.get('status'));this.pos.proxy.on('change:status',this,function(eh,status){self.set_smart_status(status.newValue);});this.$el.click(function(){self.pos.connect_to_proxy();});},});var SaleDetailsButton=PosBaseWidget.extend({template:'SaleDetailsButton',start:function(){var self=this;this.$el.click(function(){self.pos.proxy.print_sale_details();});},});var ClientScreenWidget=PosBaseWidget.extend({template:'ClientScreenWidget',change_status_display:function(status){var msg=''
if(status==='success'){this.$('.js_warning').addClass('oe_hidden');this.$('.js_disconnected').addClass('oe_hidden');this.$('.js_connected').removeClass('oe_hidden');}else if(status==='warning'){this.$('.js_disconnected').addClass('oe_hidden');this.$('.js_connected').addClass('oe_hidden');this.$('.js_warning').removeClass('oe_hidden');msg=_t('Connected, Not Owned');}else{this.$('.js_warning').addClass('oe_hidden');this.$('.js_connected').addClass('oe_hidden');this.$('.js_disconnected').removeClass('oe_hidden');msg=_t('Disconnected')
if(status==='not_found'){msg=_t('Client Screen Unsupported. Please upgrade the PosBox')}}
this.$('.oe_customer_display_text').text(msg);},status_loop:function(){var self=this;function loop(){if(self.pos.proxy.posbox_supports_display){var deffered=self.pos.proxy.test_ownership_of_client_screen();if(deffered){deffered.then(function(data){if(typeof data==='string'){data=JSON.parse(data);}
if(data.status==='OWNER'){self.change_status_display('success');}else{self.change_status_display('warning');}},function(err){if(typeof err=="undefined"){self.change_status_display('failure');}else{self.change_status_display('not_found');self.pos.proxy.posbox_supports_display=false;}}).always(function(){setTimeout(loop,3000);});}}}
loop();},start:function(){if(this.pos.config.iface_customer_facing_display){this.show();var self=this;this.$el.click(function(){self.pos.render_html_for_customer_facing_display().then(function(rendered_html){self.pos.proxy.take_ownership_over_client_screen(rendered_html).then(function(data){if(typeof data==='string'){data=JSON.parse(data);}
if(data.status==='success'){self.change_status_display('success');}else{self.change_status_display('warning');}
if(!self.pos.proxy.posbox_supports_display){self.pos.proxy.posbox_supports_display=true;self.status_loop();}},function(err){if(typeof err=="undefined"){self.change_status_display('failure');}else{self.change_status_display('not_found');}});});});this.status_loop();}else{this.hide();}},});var Chrome=PosBaseWidget.extend({template:'Chrome',init:function(){var self=this;this._super(arguments[0],{});this.started=new $.Deferred();this.ready=new $.Deferred();this.pos=new models.PosModel(this.getSession(),{chrome:this});this.gui=new gui.Gui({pos:this.pos,chrome:this});this.chrome=this;this.pos.gui=this.gui;this.logo_click_time=0;this.logo_click_count=0;this.previous_touch_y_coordinate=-1;this.widget={};this.cleanup_dom();this.pos.ready.done(function(){self.build_chrome();self.build_widgets();self.disable_rubberbanding();self.disable_backpace_back();self.ready.resolve();self.loading_hide();self.replace_crashmanager();self.pos.push_order();}).fail(function(err){self.loading_error(err);});},cleanup_dom:function(){$(document).off();$(window).off();$('html').off();$('body').off();this.$el.parent().off();BarcodeEvents.start();},build_chrome:function(){var self=this;FastClick.attach(document.body);if($.browser.chrome){var chrome_version=$.browser.version.split('.')[0];if(parseInt(chrome_version,10)>=50){ajax.loadCSS('css/chrome50.css');}}
this.renderElement();this.$('.pos-logo').click(function(){self.click_logo();});if(this.pos.config.iface_big_scrollbars){this.$el.addClass('big-scrollbars');}},show_error:function(error){this.gui.show_popup('error-traceback',{'title':error.message,'body':error.message+'\n'+error.data.debug+'\n',});},replace_crashmanager:function(){var self=this;CrashManager.include({show_error:function(error){if(self.gui){self.show_error(error);}else{this._super(error);}},});},click_logo:function(){if(this.pos.debug){this.widget.debug.show();}else{var self=this;var time=(new Date()).getTime();var delay=500;if(this.logo_click_time+500<time){this.logo_click_time=time;this.logo_click_count=1;}else{this.logo_click_time=time;this.logo_click_count+=1;if(this.logo_click_count>=6){this.logo_click_count=0;this.gui.sudo().then(function(){self.widget.debug.show();});}}}},_scrollable:function(element,scrolling_down){var $element=$(element);var scrollable=true;if(!scrolling_down&&$element.scrollTop()<=0){scrollable=false;}else if(scrolling_down&&$element.scrollTop()+$element.height()>=element.scrollHeight){scrollable=false;}
return scrollable;},disable_rubberbanding:function(){var self=this;document.body.addEventListener('touchstart',function(event){self.previous_touch_y_coordinate=event.touches[0].clientY;});document.body.addEventListener('touchmove',function(event){var node=event.target;var current_touch_y_coordinate=event.touches[0].clientY;var scrolling_down;if(current_touch_y_coordinate<self.previous_touch_y_coordinate){scrolling_down=true;}else{scrolling_down=false;}
while(node){if(node.classList&&node.classList.contains('touch-scrollable')&&self._scrollable(node,scrolling_down)){return;}
node=node.parentNode;}
event.preventDefault();});},disable_backpace_back:function(){$(document).on("keydown",function(e){if(e.which===8&&!$(e.target).is("input, textarea")){e.preventDefault();}});},loading_error:function(err){var self=this;var title=err.message;var body=err.stack;if(err.message==='XmlHttpRequestError '){title='Network Failure (XmlHttpRequestError)';body='The Point of Sale could not be loaded due to a network problem.\n Please check your internet connection.';}else if(err.code===200){title=err.data.message;body=err.data.debug;}
if(typeof body!=='string'){body='Traceback not available.';}
var popup=$(QWeb.render('ErrorTracebackPopupWidget',{widget:{options:{title:title,body:body}},}));popup.find('.button').click(function(){self.gui.close();});popup.css({zindex:9001});popup.appendTo(this.$el);},loading_progress:function(fac){this.$('.loader .loader-feedback').removeClass('oe_hidden');this.$('.loader .progress').removeClass('oe_hidden').css({'width':''+Math.floor(fac*100)+'%'});},loading_message:function(msg,progress){this.$('.loader .loader-feedback').removeClass('oe_hidden');this.$('.loader .message').text(msg);if(typeof progress!=='undefined'){this.loading_progress(progress);}else{this.$('.loader .progress').addClass('oe_hidden');}},loading_skip:function(callback){if(callback){this.$('.loader .loader-feedback').removeClass('oe_hidden');this.$('.loader .button.skip').removeClass('oe_hidden');this.$('.loader .button.skip').off('click');this.$('.loader .button.skip').click(callback);}else{this.$('.loader .button.skip').addClass('oe_hidden');}},loading_hide:function(){var self=this;this.$('.loader').animate({opacity:0},1500,'swing',function(){self.$('.loader').addClass('oe_hidden');});},loading_show:function(){this.$('.loader').removeClass('oe_hidden').animate({opacity:1},150,'swing');},widgets:[{'name':'order_selector','widget':OrderSelectorWidget,'replace':'.placeholder-OrderSelectorWidget',},{'name':'sale_details','widget':SaleDetailsButton,'append':'.pos-rightheader','condition':function(){return this.pos.config.use_proxy;},},{'name':'proxy_status','widget':ProxyStatusWidget,'append':'.pos-rightheader','condition':function(){return this.pos.config.use_proxy;},},{'name':'screen_status','widget':ClientScreenWidget,'append':'.pos-rightheader','condition':function(){return this.pos.config.use_proxy;},},{'name':'notification','widget':SynchNotificationWidget,'append':'.pos-rightheader',},{'name':'close_button','widget':HeaderButtonWidget,'append':'.pos-rightheader','args':{label:_lt('Close'),action:function(){var self=this;if(!this.confirmed){this.$el.addClass('confirm');this.$el.text(_t('Confirm'));this.confirmed=setTimeout(function(){self.$el.removeClass('confirm');self.$el.text(_t('Close'));self.confirmed=false;},2000);}else{clearTimeout(this.confirmed);this.gui.close();}},}},{'name':'username','widget':UsernameWidget,'replace':'.placeholder-UsernameWidget',},{'name':'keyboard','widget':keyboard.OnscreenKeyboardWidget,'replace':'.placeholder-OnscreenKeyboardWidget',},{'name':'debug','widget':DebugWidget,'append':'.pos-content',},],build_widgets:function(){var classe;for(var i=0;i<this.widgets.length;i++){var def=this.widgets[i];if(!def.condition||def.condition.call(this)){var args=typeof def.args==='function'?def.args(this):def.args;var w=new def.widget(this,args||{});if(def.replace){w.replace(this.$(def.replace));}else if(def.append){w.appendTo(this.$(def.append));}else if(def.prepend){w.prependTo(this.$(def.prepend));}else{w.appendTo(this.$el);}
this.widget[def.name]=w;}}
this.screens={};for(i=0;i<this.gui.screen_classes.length;i++){classe=this.gui.screen_classes[i];if(!classe.condition||classe.condition.call(this)){var screen=new classe.widget(this,{});screen.appendTo(this.$('.screens'));this.screens[classe.name]=screen;this.gui.add_screen(classe.name,screen);}}
this.popups={};for(i=0;i<this.gui.popup_classes.length;i++){classe=this.gui.popup_classes[i];if(!classe.condition||classe.condition.call(this)){var popup=new classe.widget(this,{});popup.appendTo(this.$('.popups'));this.popups[classe.name]=popup;this.gui.add_popup(classe.name,popup);}}
this.gui.set_startup_screen('products');this.gui.set_default_screen('products');},destroy:function(){this.pos.destroy();this._super();}});return{Chrome:Chrome,DebugWidget:DebugWidget,HeaderButtonWidget:HeaderButtonWidget,OrderSelectorWidget:OrderSelectorWidget,ProxyStatusWidget:ProxyStatusWidget,SaleDetailsButton:SaleDetailsButton,ClientScreenWidget:ClientScreenWidget,StatusWidget:StatusWidget,SynchNotificationWidget:SynchNotificationWidget,UsernameWidget:UsernameWidget,};});;

/* /point_of_sale/static/src/js/devices.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.devices',function(require){"use strict";var core=require('web.core');var mixins=require('web.mixins');var rpc=require('web.rpc');var Session=require('web.Session');var PosBaseWidget=require('point_of_sale.BaseWidget');var QWeb=core.qweb;var _t=core._t;var JobQueue=function(){var queue=[];var running=false;var scheduled_end_time=0;var end_of_queue=(new $.Deferred()).resolve();var stoprepeat=false;var run=function(){if(end_of_queue.state()==='resolved'){end_of_queue=new $.Deferred();}
if(queue.length>0){running=true;var job=queue[0];if(!job.opts.repeat||stoprepeat){queue.shift();stoprepeat=false;}
scheduled_end_time=(new Date()).getTime()+(job.opts.duration||0);var def=job.fun()||(new $.Deferred()).resolve();def.always(function(){setTimeout(function(){run();},Math.max(0,scheduled_end_time-(new Date()).getTime()));});}else{running=false;scheduled_end_time=0;end_of_queue.resolve();}};this.schedule=function(fun,opts){queue.push({fun:fun,opts:opts||{}});if(!running){run();}};this.clear=function(){queue=_.filter(queue,function(job){return job.opts.important===true;});};this.stoprepeat=function(){stoprepeat=true;};this.finished=function(){return end_of_queue;};};var ProxyDevice=core.Class.extend(mixins.PropertiesMixin,{init:function(parent,options){mixins.PropertiesMixin.init.call(this);var self=this;this.setParent(parent);options=options||{};this.pos=parent;this.weighing=false;this.debug_weight=0;this.use_debug_weight=false;this.paying=false;this.default_payment_status={status:'waiting',message:'',payment_method:undefined,receipt_client:undefined,receipt_shop:undefined,};this.custom_payment_status=this.default_payment_status;this.receipt_queue=[];this.notifications={};this.bypass_proxy=false;this.connection=null;this.host='';this.keptalive=false;this.set('status',{});this.set_connection_status('disconnected');this.on('change:status',this,function(eh,status){status=status.newValue;if(status.status==='connected'){self.print_receipt();}});this.posbox_supports_display=true;window.hw_proxy=this;},set_connection_status:function(status,drivers){var oldstatus=this.get('status');var newstatus={};newstatus.status=status;newstatus.drivers=status==='disconnected'?{}:oldstatus.drivers;newstatus.drivers=drivers?drivers:newstatus.drivers;this.set('status',newstatus);},disconnect:function(){if(this.get('status').status!=='disconnected'){this.connection.destroy();this.set_connection_status('disconnected');}},connect:function(url){var self=this;this.connection=new Session(undefined,url,{use_cors:true});this.host=url;this.set_connection_status('connecting',{});return this.message('handshake').then(function(response){if(response){self.set_connection_status('connected');localStorage.hw_proxy_url=url;self.keepalive();}else{self.set_connection_status('disconnected');console.error('Connection refused by the Proxy');}},function(){self.set_connection_status('disconnected');console.error('Could not connect to the Proxy');});},autoconnect:function(options){var self=this;this.set_connection_status('connecting',{});var found_url=new $.Deferred();var success=new $.Deferred();if(options.force_ip){found_url=this.try_hard_to_connect(options.force_ip,options);}else if(localStorage.hw_proxy_url){found_url=this.try_hard_to_connect(localStorage.hw_proxy_url,options).then(null,function(){return self.find_proxy(options);});}else{found_url=this.find_proxy(options);}
success=found_url.then(function(url){return self.connect(url);});success.fail(function(){self.set_connection_status('disconnected');});return success;},keepalive:function(){var self=this;function status(){self.connection.rpc('/hw_proxy/status_json',{},{shadow:true,timeout:2500}).then(function(driver_status){self.set_connection_status('connected',driver_status);},function(){if(self.get('status').status!=='connecting'){self.set_connection_status('disconnected');}}).always(function(){setTimeout(status,5000);});}
if(!this.keptalive){this.keptalive=true;status();}},message:function(name,params){var callbacks=this.notifications[name]||[];for(var i=0;i<callbacks.length;i++){callbacks[i](params);}
if(this.get('status').status!=='disconnected'){return this.connection.rpc('/hw_proxy/'+name,params||{},{shadow:true});}else{return(new $.Deferred()).reject();}},try_hard_to_connect:function(url,options){options=options||{};var port=':'+(options.port||'8069');this.set_connection_status('connecting');if(url.indexOf('//')<0){url='http://'+url;}
if(url.indexOf(':',5)<0){url=url+port;}
function try_real_hard_to_connect(url,retries,done){done=done||new $.Deferred();$.ajax({url:url+'/hw_proxy/hello',method:'GET',timeout:1000,}).done(function(){done.resolve(url);}).fail(function(){if(retries>0){try_real_hard_to_connect(url,retries-1,done);}else{done.reject();}});return done;}
return try_real_hard_to_connect(url,3);},find_proxy:function(options){options=options||{};var self=this;var port=':'+(options.port||'8069');var urls=[];var found=false;var parallel=8;var done=new $.Deferred();var threads=[];var progress=0;urls.push('http://localhost'+port);for(var i=0;i<256;i++){urls.push('http://192.168.0.'+i+port);urls.push('http://192.168.1.'+i+port);urls.push('http://10.0.0.'+i+port);}
var prog_inc=1/urls.length;function update_progress(){progress=found?1:progress+prog_inc;if(options.progress){options.progress(progress);}}
function thread(done){var url=urls.shift();done=done||new $.Deferred();if(!url||found||!self.searching_for_proxy){done.resolve();return done;}
$.ajax({url:url+'/hw_proxy/hello',method:'GET',timeout:400,}).done(function(){found=true;update_progress();done.resolve(url);}).fail(function(){update_progress();thread(done);});return done;}
this.searching_for_proxy=true;var len=Math.min(parallel,urls.length);for(i=0;i<len;i++){threads.push(thread());}
$.when.apply($,threads).then(function(){var urls=[];for(var i=0;i<arguments.length;i++){if(arguments[i]){urls.push(arguments[i]);}}
done.resolve(urls[0]);});return done;},stop_searching:function(){this.searching_for_proxy=false;this.set_connection_status('disconnected');},add_notification:function(name,callback){if(!this.notifications[name]){this.notifications[name]=[];}
this.notifications[name].push(callback);},scale_read:function(){var self=this;var ret=new $.Deferred();if(self.use_debug_weight){return(new $.Deferred()).resolve({weight:this.debug_weight,unit:'Kg',info:'ok'});}
this.message('scale_read',{}).then(function(weight){ret.resolve(weight);},function(){ret.resolve({weight:0.0,unit:'Kg',info:'ok'});});return ret;},debug_set_weight:function(kg){this.use_debug_weight=true;this.debug_weight=kg;},debug_reset_weight:function(){this.use_debug_weight=false;this.debug_weight=0;},open_cashbox:function(){return this.message('open_cashbox');},print_receipt:function(receipt){var self=this;if(receipt){this.receipt_queue.push(receipt);}
function send_printing_job(){if(self.receipt_queue.length>0){var r=self.receipt_queue.shift();self.message('print_xml_receipt',{receipt:r},{timeout:5000}).then(function(){send_printing_job();},function(error){if(error){self.pos.gui.show_popup('error-traceback',{'title':_t('Printing Error: ')+error.data.message,'body':error.data.debug,});return;}
self.receipt_queue.unshift(r);});}}
send_printing_job();},print_sale_details:function(){var self=this;rpc.query({model:'report.point_of_sale.report_saledetails',method:'get_sale_details',}).then(function(result){var env={widget:new PosBaseWidget(self),company:self.pos.company,pos:self.pos,products:result.products,payments:result.payments,taxes:result.taxes,total_paid:result.total_paid,date:(new Date()).toLocaleString(),};var report=QWeb.render('SaleDetailsReport',env);self.print_receipt(report);});},update_customer_facing_display:function(html){if(this.posbox_supports_display){return this.message('customer_facing_display',{html:html},{timeout:5000});}},take_ownership_over_client_screen:function(html){return this.message("take_control",{html:html});},test_ownership_of_client_screen:function(){if(this.connection){return this.message("test_ownership",{});}
return null;},log:function(){return this.message('log',{'arguments':_.toArray(arguments)});},});var BarcodeReader=core.Class.extend({actions:['product','cashier','client',],init:function(attributes){this.pos=attributes.pos;this.action_callback={};this.proxy=attributes.proxy;this.remote_scanning=false;this.remote_active=0;this.barcode_parser=attributes.barcode_parser;this.action_callback_stack=[];core.bus.on('barcode_scanned',this,function(barcode){this.scan(barcode);});},set_barcode_parser:function(barcode_parser){this.barcode_parser=barcode_parser;},save_callbacks:function(){var callbacks={};for(var name in this.action_callback){callbacks[name]=this.action_callback[name];}
this.action_callback_stack.push(callbacks);},restore_callbacks:function(){if(this.action_callback_stack.length){var callbacks=this.action_callback_stack.pop();this.action_callback=callbacks;}},set_action_callback:function(action,callback){if(arguments.length==2){this.action_callback[action]=callback;}else{var actions=arguments[0];for(var action in actions){this.set_action_callback(action,actions[action]);}}},reset_action_callbacks:function(){for(var action in this.action_callback){this.action_callback[action]=undefined;}},scan:function(code){if(!code){return;}
var parsed_result=this.barcode_parser.parse_barcode(code);if(this.action_callback[parsed_result.type]){this.action_callback[parsed_result.type](parsed_result);}else if(this.action_callback.error){this.action_callback.error(parsed_result);}else{console.warn("Ignored Barcode Scan:",parsed_result);}},connect_to_proxy:function(){var self=this;this.remote_scanning=true;if(this.remote_active>=1){return;}
this.remote_active=1;function waitforbarcode(){return self.proxy.connection.rpc('/hw_proxy/scanner',{},{shadow:true,timeout:7500}).then(function(barcode){if(!self.remote_scanning){self.remote_active=0;return;}
self.scan(barcode);waitforbarcode();},function(){if(!self.remote_scanning){self.remote_active=0;return;}
setTimeout(waitforbarcode,5000);});}
waitforbarcode();},disconnect_from_proxy:function(){this.remote_scanning=false;},});return{JobQueue:JobQueue,ProxyDevice:ProxyDevice,BarcodeReader:BarcodeReader,};});;

/* /point_of_sale/static/src/js/gui.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.gui',function(require){"use strict";var core=require('web.core');var field_utils=require('web.field_utils');var session=require('web.session');var _t=core._t;var Gui=core.Class.extend({screen_classes:[],popup_classes:[],init:function(options){var self=this;this.pos=options.pos;this.chrome=options.chrome;this.screen_instances={};this.popup_instances={};this.default_screen=null;this.startup_screen=null;this.current_popup=null;this.current_screen=null;this.chrome.ready.then(function(){self.close_other_tabs();var order=self.pos.get_order();if(order){self.show_saved_screen(order);}else{self.show_screen(self.startup_screen);}
self.pos.bind('change:selectedOrder',function(){self.show_saved_screen(self.pos.get_order());});});},add_screen:function(name,screen){screen.hide();this.screen_instances[name]=screen;},set_default_screen:function(name){this.default_screen=name;},set_startup_screen:function(name){this.startup_screen=name;},show_saved_screen:function(order,options){options=options||{};this.close_popup();if(order){this.show_screen(order.get_screen_data('screen')||options.default_screen||this.default_screen,null,'refresh');}else{this.show_screen(this.startup_screen);}},show_screen:function(screen_name,params,refresh,skip_close_popup){var screen=this.screen_instances[screen_name];if(!screen){console.error("ERROR: show_screen("+screen_name+") : screen not found");}
if(!skip_close_popup){this.close_popup();}
var order=this.pos.get_order();if(order){var old_screen_name=order.get_screen_data('screen');order.set_screen_data('screen',screen_name);if(params){order.set_screen_data('params',params);}
if(screen_name!==old_screen_name){order.set_screen_data('previous-screen',old_screen_name);}}
if(refresh||screen!==this.current_screen){if(this.current_screen){this.current_screen.close();this.current_screen.hide();}
this.current_screen=screen;this.current_screen.show(refresh);}},get_current_screen:function(){return this.pos.get_order()?(this.pos.get_order().get_screen_data('screen')||this.default_screen):this.startup_screen;},back:function(){var previous=this.pos.get_order().get_screen_data('previous-screen');if(previous){this.show_screen(previous);}},get_current_screen_param:function(param){if(this.pos.get_order()){var params=this.pos.get_order().get_screen_data('params');return params?params[param]:undefined;}else{return undefined;}},add_popup:function(name,popup){popup.hide();this.popup_instances[name]=popup;},show_popup:function(name,options){if(this.current_popup){this.close_popup();}
this.current_popup=this.popup_instances[name];return this.current_popup.show(options);},close_popup:function(){if(this.current_popup){this.current_popup.close();this.current_popup.hide();this.current_popup=null;}},has_popup:function(){return!!this.current_popup;},close_other_tabs:function(){var self=this;var now=Date.now();localStorage['message']='';localStorage['message']=JSON.stringify({'message':'close_tabs','session':this.pos.pos_session.id,'window_uid':now,});window.addEventListener("storage",function(event){var msg=event.data;if(event.key==='message'&&event.newValue){var msg=JSON.parse(event.newValue);if(msg.message==='close_tabs'&&msg.session==self.pos.pos_session.id&&msg.window_uid!=now){console.info('POS / Session opened in another window. EXITING POS')
self._close();}}},false);},select_user:function(options){options=options||{};var self=this;var def=new $.Deferred();var list=[];for(var i=0;i<this.pos.users.length;i++){var user=this.pos.users[i];if(!options.only_managers||user.role==='manager'){list.push({'label':user.name,'item':user,});}}
this.show_popup('selection',{title:options.title||_t('Select User'),list:list,confirm:function(user){def.resolve(user);},cancel:function(){def.reject();},is_selected:function(user){return user===self.pos.get_cashier();},});return def.then(function(user){if(options.security&&user!==options.current_user&&user.pos_security_pin){return self.ask_password(user.pos_security_pin).then(function(){return user;});}else{return user;}});},ask_password:function(password){var self=this;var ret=new $.Deferred();if(password){this.show_popup('password',{'title':_t('Password ?'),confirm:function(pw){if(pw!==password){self.show_popup('error',_t('Incorrect Password'));ret.reject();}else{ret.resolve();}},});}else{ret.resolve();}
return ret;},sudo:function(user){user=user||this.pos.get_cashier();if(user.role==='manager'){return new $.Deferred().resolve(user);}else{return this.select_user({security:true,only_managers:true,title:_t('Login as a Manager'),});}},close:function(){var self=this;var pending=this.pos.db.get_orders().length;if(!pending){this._close();}else{this.pos.push_order().always(function(){var pending=self.pos.db.get_orders().length;if(!pending){self._close();}else{var reason=self.pos.get('failed')?'configuration errors':'internet connection issues';self.show_popup('confirm',{'title':_t('Offline Orders'),'body':_t(['Some orders could not be submitted to','the server due to '+reason+'.','You can exit the Point of Sale, but do','not close the session before the issue','has been resolved.'].join(' ')),'confirm':function(){self._close();},});}});}},_close:function(){var self=this;this.chrome.loading_show();this.chrome.loading_message(_t('Closing ...'));this.pos.push_order().then(function(){var url="backoffice.php";window.location=session.debug?$.param.querystring(url,{debug:session.debug}):url;});},play_sound:function(sound){var src='';if(sound==='error'){src="sounds/error.wav";}else if(sound==='bell'){src="/point_of_sale/static/src/sounds/bell.wav";}else{console.error('Unknown sound: ',sound);return;}
$('body').append('<audio src="'+src+'" autoplay="true"></audio>');},download_file:function(contents,name){href_params=this.prepare_file_blob(contents,name);var evt=document.createEvent("HTMLEvents");evt.initEvent("click");$("<a>",href_params).get(0).dispatchEvent(evt);},prepare_download_link:function(contents,filename,src,target){var href_params=this.prepare_file_blob(contents,filename);$(target).parent().attr(href_params);$(src).addClass('oe_hidden');$(target).removeClass('oe_hidden');$(target).click(function(){$(src).removeClass('oe_hidden');$(this).addClass('oe_hidden');});},prepare_file_blob:function(contents,name){var URL=window.URL||window.webkitURL;if(typeof contents!=='string'){contents=JSON.stringify(contents,null,2);}
var blob=new Blob([contents]);return{download:name||'document.txt',href:URL.createObjectURL(blob),}},send_email:function(address,subject,body){window.open("mailto:"+address+"?subject="+(subject?window.encodeURIComponent(subject):'')+"&body="+(body?window.encodeURIComponent(body):''));},numpad_input:function(buffer,input,options){var newbuf=buffer.slice(0);options=options||{};var newbuf_float=field_utils.parse.float(newbuf);var decimal_point=_t.database.parameters.decimal_point;if(input===decimal_point){if(options.firstinput){newbuf="0.";}else if(!newbuf.length||newbuf==='-'){newbuf+="0.";}else if(newbuf.indexOf(decimal_point)<0){newbuf=newbuf+decimal_point;}}else if(input==='CLEAR'){newbuf="";}else if(input==='BACKSPACE'){newbuf=newbuf.substring(0,newbuf.length-1);}else if(input==='+'){if(newbuf[0]==='-'){newbuf=newbuf.substring(1,newbuf.length);}}else if(input==='-'){if(newbuf[0]==='-'){newbuf=newbuf.substring(1,newbuf.length);}else{newbuf='-'+newbuf;}}else if(input[0]==='+'&&!isNaN(parseFloat(input))){newbuf=this.chrome.format_currency_no_symbol(newbuf_float+parseFloat(input));}else if(!isNaN(parseInt(input))){if(options.firstinput){newbuf=''+input;}else{newbuf+=input;}}
if(newbuf.length>buffer.length&&newbuf.length>12){this.play_sound('bell');return buffer.slice(0);}
return newbuf;},});var define_screen=function(classe){Gui.prototype.screen_classes.push(classe);};var define_popup=function(classe){Gui.prototype.popup_classes.push(classe);};return{Gui:Gui,define_screen:define_screen,define_popup:define_popup,};});;

/* /point_of_sale/static/src/js/popups.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.popups',function(require){"use strict";var PosBaseWidget=require('point_of_sale.BaseWidget');var gui=require('point_of_sale.gui');var _t=require('web.core')._t;var PopupWidget=PosBaseWidget.extend({template:'PopupWidget',init:function(parent,args){this._super(parent,args);this.options={};},events:{'click .button.cancel':'click_cancel','click .button.confirm':'click_confirm','click .selection-item':'click_item','click .input-button':'click_numpad','click .mode-button':'click_numpad',},show:function(options){if(this.$el){this.$el.removeClass('oe_hidden');}
if(typeof options==='string'){this.options={title:options};}else{this.options=options||{};}
this.renderElement();if(this.pos.barcode_reader){this.pos.barcode_reader.save_callbacks();this.pos.barcode_reader.reset_action_callbacks();}},close:function(){if(this.pos.barcode_reader){this.pos.barcode_reader.restore_callbacks();}},hide:function(){if(this.$el){this.$el.addClass('oe_hidden');}},click_cancel:function(){this.gui.close_popup();if(this.options.cancel){this.options.cancel.call(this);}},click_confirm:function(){this.gui.close_popup();if(this.options.confirm){this.options.confirm.call(this);}},click_item:function(){},click_numad:function(){},});gui.define_popup({name:'alert',widget:PopupWidget});var ErrorPopupWidget=PopupWidget.extend({template:'ErrorPopupWidget',show:function(options){this._super(options);this.gui.play_sound('error');},});gui.define_popup({name:'error',widget:ErrorPopupWidget});var ErrorTracebackPopupWidget=ErrorPopupWidget.extend({template:'ErrorTracebackPopupWidget',show:function(opts){var self=this;this._super(opts);this.$('.download').off('click').click(function(){self.gui.prepare_download_link(self.options.body,_t('error')+' '+moment().format('YYYY-MM-DD-HH-mm-ss')+'.txt','.download','.download_error_file');});this.$('.email').off('click').click(function(){self.gui.send_email(self.pos.company.email,_t('IMPORTANT: Bug Report From Odoo Point Of Sale'),self.options.body);});}});gui.define_popup({name:'error-traceback',widget:ErrorTracebackPopupWidget});var ErrorBarcodePopupWidget=ErrorPopupWidget.extend({template:'ErrorBarcodePopupWidget',show:function(barcode){this._super({barcode:barcode});},});gui.define_popup({name:'error-barcode',widget:ErrorBarcodePopupWidget});var ConfirmPopupWidget=PopupWidget.extend({template:'ConfirmPopupWidget',});gui.define_popup({name:'confirm',widget:ConfirmPopupWidget});var SelectionPopupWidget=PopupWidget.extend({template:'SelectionPopupWidget',show:function(options){var self=this;options=options||{};this._super(options);this.list=options.list||[];this.is_selected=options.is_selected||function(item){return false;};this.renderElement();},click_item:function(event){this.gui.close_popup();if(this.options.confirm){var item=this.list[parseInt($(event.target).data('item-index'))];item=item?item.item:item;this.options.confirm.call(self,item);}}});gui.define_popup({name:'selection',widget:SelectionPopupWidget});var TextInputPopupWidget=PopupWidget.extend({template:'TextInputPopupWidget',show:function(options){options=options||{};this._super(options);this.renderElement();this.$('input,textarea').focus();},click_confirm:function(){var value=this.$('input,textarea').val();this.gui.close_popup();if(this.options.confirm){this.options.confirm.call(this,value);}},});gui.define_popup({name:'textinput',widget:TextInputPopupWidget});var TextAreaPopupWidget=TextInputPopupWidget.extend({template:'TextAreaPopupWidget',});gui.define_popup({name:'textarea',widget:TextAreaPopupWidget});var PackLotLinePopupWidget=PopupWidget.extend({template:'PackLotLinePopupWidget',events:_.extend({},PopupWidget.prototype.events,{'click .remove-lot':'remove_lot','keydown':'add_lot','blur .packlot-line-input':'lose_input_focus'}),show:function(options){this._super(options);this.focus();},click_confirm:function(){var pack_lot_lines=this.options.pack_lot_lines;this.$('.packlot-line-input').each(function(index,el){var cid=$(el).attr('cid'),lot_name=$(el).val();var pack_line=pack_lot_lines.get({cid:cid});pack_line.set_lot_name(lot_name);});pack_lot_lines.remove_empty_model();pack_lot_lines.set_quantity_by_lot();this.options.order.save_to_db();this.options.order_line.trigger('change',this.options.order_line);this.gui.close_popup();},add_lot:function(ev){if(ev.keyCode===$.ui.keyCode.ENTER&&this.options.order_line.product.tracking=='serial'){var pack_lot_lines=this.options.pack_lot_lines,$input=$(ev.target),cid=$input.attr('cid'),lot_name=$input.val();var lot_model=pack_lot_lines.get({cid:cid});lot_model.set_lot_name(lot_name);if(!pack_lot_lines.get_empty_model()){var new_lot_model=lot_model.add();this.focus_model=new_lot_model;}
pack_lot_lines.set_quantity_by_lot();this.renderElement();this.focus();}},remove_lot:function(ev){var pack_lot_lines=this.options.pack_lot_lines,$input=$(ev.target).prev(),cid=$input.attr('cid');var lot_model=pack_lot_lines.get({cid:cid});lot_model.remove();pack_lot_lines.set_quantity_by_lot();this.renderElement();},lose_input_focus:function(ev){var $input=$(ev.target),cid=$input.attr('cid');var lot_model=this.options.pack_lot_lines.get({cid:cid});lot_model.set_lot_name($input.val());},focus:function(){this.$("input[autofocus]").focus();this.focus_model=false;}});gui.define_popup({name:'packlotline',widget:PackLotLinePopupWidget});var NumberPopupWidget=PopupWidget.extend({template:'NumberPopupWidget',show:function(options){options=options||{};this._super(options);this.inputbuffer=''+(options.value||'');this.decimal_separator=_t.database.parameters.decimal_point;this.renderElement();this.firstinput=true;},click_numpad:function(event){var newbuf=this.gui.numpad_input(this.inputbuffer,$(event.target).data('action'),{'firstinput':this.firstinput});this.firstinput=(newbuf.length===0);if(newbuf!==this.inputbuffer){this.inputbuffer=newbuf;this.$('.value').text(this.inputbuffer);}},click_confirm:function(){this.gui.close_popup();if(this.options.confirm){this.options.confirm.call(this,this.inputbuffer);}},});gui.define_popup({name:'number',widget:NumberPopupWidget});var PasswordPopupWidget=NumberPopupWidget.extend({renderElement:function(){this._super();this.$('.popup').addClass('popup-password');},click_numpad:function(event){this._super.apply(this,arguments);var $value=this.$('.value');$value.text($value.text().replace(/./g,''));},});gui.define_popup({name:'password',widget:PasswordPopupWidget});var OrderImportPopupWidget=PopupWidget.extend({template:'OrderImportPopupWidget',});gui.define_popup({name:'orderimport',widget:OrderImportPopupWidget});return PopupWidget;});;

/* /point_of_sale/static/src/js/screens.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.screens',function(require){"use strict";var PosBaseWidget=require('point_of_sale.BaseWidget');var gui=require('point_of_sale.gui');var models=require('point_of_sale.models');var core=require('web.core');var rpc=require('web.rpc');var utils=require('web.utils');var field_utils=require('web.field_utils');var QWeb=core.qweb;var _t=core._t;var round_pr=utils.round_precision;var ScreenWidget=PosBaseWidget.extend({init:function(parent,options){this._super(parent,options);this.hidden=false;},barcode_product_screen:'products',barcode_product_action:function(code){var self=this;if(self.pos.scan_product(code)){if(self.barcode_product_screen){self.gui.show_screen(self.barcode_product_screen,null,null,true);}}else{this.barcode_error_action(code);}},barcode_cashier_action:function(code){var self=this;var users=this.pos.users;for(var i=0,len=users.length;i<len;i++){if(users[i].barcode===code.code){if(users[i].id!==this.pos.get_cashier().id&&users[i].pos_security_pin){return this.gui.ask_password(users[i].pos_security_pin).then(function(){self.pos.set_cashier(users[i]);self.chrome.widget.username.renderElement();return true;});}else{this.pos.set_cashier(users[i]);this.chrome.widget.username.renderElement();return true;}}}
this.barcode_error_action(code);return false;},barcode_client_action:function(code){var partner=this.pos.db.get_partner_by_barcode(code.code);if(partner){this.pos.get_order().set_client(partner);return true;}
this.barcode_error_action(code);return false;},barcode_discount_action:function(code){var last_orderline=this.pos.get_order().get_last_orderline();if(last_orderline){last_orderline.set_discount(code.value);}},barcode_error_action:function(code){var show_code;if(code.code.length>32){show_code=code.code.substring(0,29)+'...';}else{show_code=code.code;}
this.gui.show_popup('error-barcode',show_code);},show:function(){var self=this;this.hidden=false;if(this.$el){this.$el.removeClass('oe_hidden');}
this.pos.barcode_reader.set_action_callback({'cashier':_.bind(self.barcode_cashier_action,self),'product':_.bind(self.barcode_product_action,self),'weight':_.bind(self.barcode_product_action,self),'price':_.bind(self.barcode_product_action,self),'client':_.bind(self.barcode_client_action,self),'discount':_.bind(self.barcode_discount_action,self),'error':_.bind(self.barcode_error_action,self),});},close:function(){if(this.pos.barcode_reader){this.pos.barcode_reader.reset_action_callbacks();}},hide:function(){this.hidden=true;if(this.$el){this.$el.addClass('oe_hidden');}},renderElement:function(){this._super();if(this.hidden){if(this.$el){this.$el.addClass('oe_hidden');}}},});var DomCache=core.Class.extend({init:function(options){options=options||{};this.max_size=options.max_size||2000;this.cache={};this.access_time={};this.size=0;},cache_node:function(key,node){var cached=this.cache[key];this.cache[key]=node;this.access_time[key]=new Date().getTime();if(!cached){this.size++;while(this.size>=this.max_size){var oldest_key=null;var oldest_time=new Date().getTime();for(key in this.cache){var time=this.access_time[key];if(time<=oldest_time){oldest_time=time;oldest_key=key;}}
if(oldest_key){delete this.cache[oldest_key];delete this.access_time[oldest_key];}
this.size--;}}
return node;},clear_node:function(key){var cached=this.cache[key];if(cached){delete this.cache[key];delete this.access_time[key];this.size--;}},get_node:function(key){var cached=this.cache[key];if(cached){this.access_time[key]=new Date().getTime();}
return cached;},});var ScaleScreenWidget=ScreenWidget.extend({template:'ScaleScreenWidget',next_screen:'products',previous_screen:'products',show:function(){this._super();var self=this;var queue=this.pos.proxy_queue;this.set_weight(0);this.renderElement();this.hotkey_handler=function(event){if(event.which===13){self.order_product();self.gui.show_screen(self.next_screen);}else if(event.which===27){self.gui.show_screen(self.previous_screen);}};$('body').on('keypress',this.hotkey_handler);this.$('.back').click(function(){self.gui.show_screen(self.previous_screen);});this.$('.next,.buy-product').click(function(){self.gui.show_screen(self.next_screen);self.order_product();});queue.schedule(function(){return self.pos.proxy.scale_read().then(function(weight){self.set_weight(weight.weight);});},{duration:500,repeat:true});},get_product:function(){return this.gui.get_current_screen_param('product');},_get_active_pricelist:function(){var current_order=this.pos.get_order();var current_pricelist=this.pos.default_pricelist;if(current_order){current_pricelist=current_order.pricelist;}
return current_pricelist;},order_product:function(){this.pos.get_order().add_product(this.get_product(),{quantity:this.weight});},get_product_name:function(){var product=this.get_product();return(product?product.display_name:undefined)||'Unnamed Product';},get_product_price:function(){var product=this.get_product();var pricelist=this._get_active_pricelist();return(product?product.get_price(pricelist,this.weight):0)||0;},get_product_uom:function(){var product=this.get_product();if(product){return this.pos.units_by_id[product.uom_id[0]].name;}else{return'';}},set_weight:function(weight){this.weight=weight;this.$('.weight').text(this.get_product_weight_string());this.$('.computed-price').text(this.get_computed_price_string());},get_product_weight_string:function(){var product=this.get_product();var defaultstr=(this.weight||0).toFixed(3)+' Kg';if(!product||!this.pos){return defaultstr;}
var unit_id=product.uom_id;if(!unit_id){return defaultstr;}
var unit=this.pos.units_by_id[unit_id[0]];var weight=round_pr(this.weight||0,unit.rounding);var weightstr=weight.toFixed(Math.ceil(Math.log(1.0/unit.rounding)/Math.log(10)));weightstr+=' '+unit.name;return weightstr;},get_computed_price_string:function(){return this.format_currency(this.get_product_price()*this.weight);},close:function(){this._super();$('body').off('keypress',this.hotkey_handler);this.pos.proxy_queue.clear();},});gui.define_screen({name:'scale',widget:ScaleScreenWidget});var NumpadWidget=PosBaseWidget.extend({template:'NumpadWidget',init:function(parent){this._super(parent);this.state=new models.NumpadState();},start:function(){this.applyAccessRights();this.state.bind('change:mode',this.changedMode,this);this.pos.bind('change:cashier',this.applyAccessRights,this);this.changedMode();this.$el.find('.numpad-backspace').click(_.bind(this.clickDeleteLastChar,this));this.$el.find('.numpad-minus').click(_.bind(this.clickSwitchSign,this));this.$el.find('.number-char').click(_.bind(this.clickAppendNewChar,this));this.$el.find('.mode-button').click(_.bind(this.clickChangeMode,this));},applyAccessRights:function(){var cashier=this.pos.get('cashier')||this.pos.get_cashier();var has_price_control_rights=!this.pos.config.restrict_price_control||cashier.role=='manager';this.$el.find('.mode-button[data-mode="price"]').toggleClass('disabled-mode',!has_price_control_rights).prop('disabled',!has_price_control_rights);},clickDeleteLastChar:function(){return this.state.deleteLastChar();},clickSwitchSign:function(){return this.state.switchSign();},clickAppendNewChar:function(event){var newChar;newChar=event.currentTarget.innerText||event.currentTarget.textContent;return this.state.appendNewChar(newChar);},clickChangeMode:function(event){var newMode=event.currentTarget.attributes['data-mode'].nodeValue;return this.state.changeMode(newMode);},changedMode:function(){var mode=this.state.get('mode');$('.selected-mode').removeClass('selected-mode');$(_.str.sprintf('.mode-button[data-mode="%s"]',mode),this.$el).addClass('selected-mode');},});var ActionpadWidget=PosBaseWidget.extend({template:'ActionpadWidget',init:function(parent,options){var self=this;this._super(parent,options);this.pos.bind('change:selectedClient',function(){self.renderElement();});},renderElement:function(){var self=this;this._super();this.$('.pay').click(function(){var order=self.pos.get_order();var has_valid_product_lot=_.every(order.orderlines.models,function(line){return line.has_valid_product_lot();});if(!has_valid_product_lot){self.gui.show_popup('confirm',{'title':_t('Empty Serial/Lot Number'),'body':_t('One or more product(s) required serial/lot number.'),confirm:function(){self.gui.show_screen('payment');},});}else{self.gui.show_screen('payment');}});this.$('.set-customer').click(function(){self.gui.show_screen('clientlist');});}});var OrderWidget=PosBaseWidget.extend({template:'OrderWidget',init:function(parent,options){var self=this;this._super(parent,options);this.numpad_state=options.numpad_state;this.numpad_state.reset();this.numpad_state.bind('set_value',this.set_value,this);this.pos.bind('change:selectedOrder',this.change_selected_order,this);this.line_click_handler=function(event){self.click_line(this.orderline,event);};if(this.pos.get_order()){this.bind_order_events();}},click_line:function(orderline,event){this.pos.get_order().select_orderline(orderline);this.numpad_state.reset();},set_value:function(val){var order=this.pos.get_order();if(order.get_selected_orderline()){var mode=this.numpad_state.get('mode');if(mode==='quantity'){order.get_selected_orderline().set_quantity(val);}else if(mode==='discount'){order.get_selected_orderline().set_discount(val);}else if(mode==='price'){var selected_orderline=order.get_selected_orderline();selected_orderline.price_manually_set=true;selected_orderline.set_unit_price(val);}}},change_selected_order:function(){if(this.pos.get_order()){this.bind_order_events();this.numpad_state.reset();this.renderElement();}},orderline_add:function(){this.numpad_state.reset();this.renderElement('and_scroll_to_bottom');},orderline_remove:function(line){this.remove_orderline(line);this.numpad_state.reset();this.update_summary();},orderline_change:function(line){this.rerender_orderline(line);this.update_summary();},bind_order_events:function(){var order=this.pos.get_order();order.unbind('change:client',this.update_summary,this);order.bind('change:client',this.update_summary,this);order.unbind('change',this.update_summary,this);order.bind('change',this.update_summary,this);var lines=order.orderlines;lines.unbind('add',this.orderline_add,this);lines.bind('add',this.orderline_add,this);lines.unbind('remove',this.orderline_remove,this);lines.bind('remove',this.orderline_remove,this);lines.unbind('change',this.orderline_change,this);lines.bind('change',this.orderline_change,this);},render_orderline:function(orderline){var el_str=QWeb.render('Orderline',{widget:this,line:orderline});var el_node=document.createElement('div');el_node.innerHTML=_.str.trim(el_str);el_node=el_node.childNodes[0];el_node.orderline=orderline;el_node.addEventListener('click',this.line_click_handler);var el_lot_icon=el_node.querySelector('.line-lot-icon');if(el_lot_icon){el_lot_icon.addEventListener('click',(function(){this.show_product_lot(orderline);}.bind(this)));}
orderline.node=el_node;return el_node;},remove_orderline:function(order_line){if(this.pos.get_order().get_orderlines().length===0){this.renderElement();}else{order_line.node.parentNode.removeChild(order_line.node);}},rerender_orderline:function(order_line){var node=order_line.node;var replacement_line=this.render_orderline(order_line);node.parentNode.replaceChild(replacement_line,node);},replace:function($target){this.renderElement();var target=$target[0];target.parentNode.replaceChild(this.el,target);},renderElement:function(scrollbottom){var order=this.pos.get_order();if(!order){return;}
var orderlines=order.get_orderlines();var el_str=QWeb.render('OrderWidget',{widget:this,order:order,orderlines:orderlines});var el_node=document.createElement('div');el_node.innerHTML=_.str.trim(el_str);el_node=el_node.childNodes[0];var list_container=el_node.querySelector('.orderlines');for(var i=0,len=orderlines.length;i<len;i++){var orderline=this.render_orderline(orderlines[i]);list_container.appendChild(orderline);}
if(this.el&&this.el.parentNode){this.el.parentNode.replaceChild(el_node,this.el);}
this.el=el_node;this.update_summary();if(scrollbottom){this.el.querySelector('.order-scroller').scrollTop=100*orderlines.length;}},update_summary:function(){var order=this.pos.get_order();if(!order.get_orderlines().length){return;}
var total=order?order.get_total_with_tax():0;var taxes=order?total-order.get_total_without_tax():0;this.el.querySelector('.summary .total > .value').textContent=this.format_currency(total);this.el.querySelector('.summary .total .subentry .value').textContent=this.format_currency(taxes);},show_product_lot:function(orderline){this.pos.get_order().select_orderline(orderline);var order=this.pos.get_order();order.display_lot_popup();},});var ProductCategoriesWidget=PosBaseWidget.extend({template:'ProductCategoriesWidget',init:function(parent,options){var self=this;this._super(parent,options);this.product_type=options.product_type||'all';this.onlyWeightable=options.onlyWeightable||false;this.category=this.pos.root_category;this.breadcrumb=[];this.subcategories=[];this.product_list_widget=options.product_list_widget||null;this.category_cache=new DomCache();this.start_categ_id=this.pos.config.iface_start_categ_id?this.pos.config.iface_start_categ_id[0]:0;this.set_category(this.pos.db.get_category_by_id(this.start_categ_id));this.switch_category_handler=function(event){self.set_category(self.pos.db.get_category_by_id(Number(this.dataset.categoryId)));self.renderElement();};this.clear_search_handler=function(event){self.clear_search();};var search_timeout=null;this.search_handler=function(event){if(event.type=="keypress"||event.keyCode===46||event.keyCode===8){clearTimeout(search_timeout);var searchbox=this;search_timeout=setTimeout(function(){self.perform_search(self.category,searchbox.value,event.which===13);},70);}};},set_category:function(category){var db=this.pos.db;if(!category){this.category=db.get_category_by_id(db.root_category_id);}else{this.category=category;}
this.breadcrumb=[];var ancestors_ids=db.get_category_ancestors_ids(this.category.id);for(var i=1;i<ancestors_ids.length;i++){this.breadcrumb.push(db.get_category_by_id(ancestors_ids[i]));}
if(this.category.id!==db.root_category_id){this.breadcrumb.push(this.category);}
this.subcategories=db.get_category_by_id(db.get_category_childs_ids(this.category.id));},get_image_url:function(category){return window.location.origin+'/web/image?model=pos.category&field=image_medium&id='+category.id;},render_category:function(category,with_image){var cached=this.category_cache.get_node(category.id);if(!cached){if(with_image){var image_url=this.get_image_url(category);var category_html=QWeb.render('CategoryButton',{widget:this,category:category,image_url:this.get_image_url(category),});category_html=_.str.trim(category_html);var category_node=document.createElement('div');category_node.innerHTML=category_html;category_node=category_node.childNodes[0];}else{var category_html=QWeb.render('CategorySimpleButton',{widget:this,category:category,});category_html=_.str.trim(category_html);var category_node=document.createElement('div');category_node.innerHTML=category_html;category_node=category_node.childNodes[0];}
this.category_cache.cache_node(category.id,category_node);return category_node;}
return cached;},replace:function($target){this.renderElement();var target=$target[0];target.parentNode.replaceChild(this.el,target);},renderElement:function(){var el_str=QWeb.render(this.template,{widget:this});var el_node=document.createElement('div');el_node.innerHTML=el_str;el_node=el_node.childNodes[1];if(this.el&&this.el.parentNode){this.el.parentNode.replaceChild(el_node,this.el);}
this.el=el_node;var withpics=this.pos.config.iface_display_categ_images;var list_container=el_node.querySelector('.category-list');if(list_container){if(!withpics){list_container.classList.add('simple');}else{list_container.classList.remove('simple');}
for(var i=0,len=this.subcategories.length;i<len;i++){list_container.appendChild(this.render_category(this.subcategories[i],withpics));}}
var buttons=el_node.querySelectorAll('.js-category-switch');for(var i=0;i<buttons.length;i++){buttons[i].addEventListener('click',this.switch_category_handler);}
var products=this.pos.db.get_product_by_category(this.category.id);this.product_list_widget.set_product_list(products);this.el.querySelector('.searchbox input').addEventListener('keypress',this.search_handler);this.el.querySelector('.searchbox input').addEventListener('keydown',this.search_handler);this.el.querySelector('.search-clear').addEventListener('click',this.clear_search_handler);if(this.pos.config.iface_vkeyboard&&this.chrome.widget.keyboard){this.chrome.widget.keyboard.connect($(this.el.querySelector('.searchbox input')));}},reset_category:function(){this.set_category(this.pos.db.get_category_by_id(this.start_categ_id));this.renderElement();},clear_search:function(){var products=this.pos.db.get_product_by_category(this.category.id);this.product_list_widget.set_product_list(products);var input=this.el.querySelector('.searchbox input');input.value='';input.focus();},perform_search:function(category,query,buy_result){var products;if(query){products=this.pos.db.search_product_in_category(category.id,query);if(buy_result&&products.length===1){this.pos.get_order().add_product(products[0]);this.clear_search();}else{this.product_list_widget.set_product_list(products);}}else{products=this.pos.db.get_product_by_category(this.category.id);this.product_list_widget.set_product_list(products);}},});var ProductListWidget=PosBaseWidget.extend({template:'ProductListWidget',init:function(parent,options){var self=this;this._super(parent,options);this.model=options.model;this.productwidgets=[];this.weight=options.weight||0;this.show_scale=options.show_scale||false;this.next_screen=options.next_screen||false;this.click_product_handler=function(){var product=self.pos.db.get_product_by_id(this.dataset.productId);options.click_product_action(product);};this.product_list=options.product_list||[];this.product_cache=new DomCache();this.pos.get('orders').bind('add remove change',function(){self.renderElement();},this);this.pos.bind('change:selectedOrder',function(){this.renderElement();},this);},set_product_list:function(product_list){this.product_list=product_list;this.renderElement();},get_product_image_url:function(product){return 'image.php?model=product.product&field=image_medium&id='+product.id;},replace:function($target){this.renderElement();var target=$target[0];target.parentNode.replaceChild(this.el,target);},calculate_cache_key:function(product,pricelist){return product.id+','+pricelist.id;},_get_active_pricelist:function(){var current_order=this.pos.get_order();var current_pricelist=this.pos.default_pricelist;if(current_order){current_pricelist=current_order.pricelist;}
return current_pricelist;},render_product:function(product){var current_pricelist=this._get_active_pricelist();var cache_key=this.calculate_cache_key(product,current_pricelist);var cached=this.product_cache.get_node(cache_key);if(!cached){var image_url=this.get_product_image_url(product);var product_html=QWeb.render('Product',{widget:this,product:product,pricelist:current_pricelist,image_url:this.get_product_image_url(product),});var product_node=document.createElement('div');product_node.innerHTML=product_html;product_node=product_node.childNodes[1];this.product_cache.cache_node(cache_key,product_node);return product_node;}
return cached;},renderElement:function(){var el_str=QWeb.render(this.template,{widget:this});var el_node=document.createElement('div');el_node.innerHTML=el_str;el_node=el_node.childNodes[1];if(this.el&&this.el.parentNode){this.el.parentNode.replaceChild(el_node,this.el);}
this.el=el_node;var list_container=el_node.querySelector('.product-list');for(var i=0,len=this.product_list.length;i<len;i++){var product_node=this.render_product(this.product_list[i]);product_node.addEventListener('click',this.click_product_handler);list_container.appendChild(product_node);}},});var action_button_classes=[];var define_action_button=function(classe,options){options=options||{};var classes=action_button_classes;var index=classes.length;var i;if(options.after){for(i=0;i<classes.length;i++){if(classes[i].name===options.after){index=i+1;}}}else if(options.before){for(i=0;i<classes.length;i++){if(classes[i].name===options.after){index=i;break;}}}
classes.splice(i,0,classe);};var ActionButtonWidget=PosBaseWidget.extend({template:'ActionButtonWidget',label:_t('Button'),renderElement:function(){var self=this;this._super();this.$el.click(function(){self.button_click();});},button_click:function(){},highlight:function(highlight){this.$el.toggleClass('highlight',!!highlight);},altlight:function(altlight){this.$el.toggleClass('altlight',!!altlight);},});var ProductScreenWidget=ScreenWidget.extend({template:'ProductScreenWidget',start:function(){var self=this;this.actionpad=new ActionpadWidget(this,{});this.actionpad.replace(this.$('.placeholder-ActionpadWidget'));this.numpad=new NumpadWidget(this,{});this.numpad.replace(this.$('.placeholder-NumpadWidget'));this.order_widget=new OrderWidget(this,{numpad_state:this.numpad.state,});this.order_widget.replace(this.$('.placeholder-OrderWidget'));this.product_list_widget=new ProductListWidget(this,{click_product_action:function(product){self.click_product(product);},product_list:this.pos.db.get_product_by_category(0)});this.product_list_widget.replace(this.$('.placeholder-ProductListWidget'));this.product_categories_widget=new ProductCategoriesWidget(this,{product_list_widget:this.product_list_widget,});this.product_categories_widget.replace(this.$('.placeholder-ProductCategoriesWidget'));this.action_buttons={};var classes=action_button_classes;for(var i=0;i<classes.length;i++){var classe=classes[i];if(!classe.condition||classe.condition.call(this)){var widget=new classe.widget(this,{});widget.appendTo(this.$('.control-buttons'));this.action_buttons[classe.name]=widget;}}
if(_.size(this.action_buttons)){this.$('.control-buttons').removeClass('oe_hidden');}},click_product:function(product){if(product.to_weight&&this.pos.config.iface_electronic_scale){this.gui.show_screen('scale',{product:product});}else{this.pos.get_order().add_product(product);}},show:function(reset){this._super();if(reset){this.product_categories_widget.reset_category();this.numpad.state.reset();}
if(this.pos.config.iface_vkeyboard&&this.chrome.widget.keyboard){this.chrome.widget.keyboard.connect($(this.el.querySelector('.searchbox input')));}},close:function(){this._super();if(this.pos.config.iface_vkeyboard&&this.chrome.widget.keyboard){this.chrome.widget.keyboard.hide();}},});gui.define_screen({name:'products',widget:ProductScreenWidget});var ClientListScreenWidget=ScreenWidget.extend({template:'ClientListScreenWidget',init:function(parent,options){this._super(parent,options);this.partner_cache=new DomCache();},auto_back:true,show:function(){var self=this;this._super();this.renderElement();this.details_visible=false;this.old_client=this.pos.get_order().get_client();this.$('.back').click(function(){self.gui.back();});this.$('.next').click(function(){self.save_changes();self.gui.back();});this.$('.new-customer').click(function(){self.display_client_details('edit',{'country_id':self.pos.company.country_id,});});var partners=this.pos.db.get_partners_sorted(1000);this.render_list(partners);this.reload_partners();if(this.old_client){this.display_client_details('show',this.old_client,0);}
this.$('.client-list-contents').delegate('.client-line','click',function(event){self.line_select(event,$(this),parseInt($(this).data('id')));});var search_timeout=null;if(this.pos.config.iface_vkeyboard&&this.chrome.widget.keyboard){this.chrome.widget.keyboard.connect(this.$('.searchbox input'));}
this.$('.searchbox input').on('keypress',function(event){clearTimeout(search_timeout);var searchbox=this;search_timeout=setTimeout(function(){self.perform_search(searchbox.value,event.which===13);},70);});this.$('.searchbox .search-clear').click(function(){self.clear_search();});},hide:function(){this._super();this.new_client=null;},barcode_client_action:function(code){if(this.editing_client){this.$('.detail.barcode').val(code.code);}else if(this.pos.db.get_partner_by_barcode(code.code)){var partner=this.pos.db.get_partner_by_barcode(code.code);this.new_client=partner;this.display_client_details('show',partner);}},perform_search:function(query,associate_result){var customers;if(query){customers=this.pos.db.search_partner(query);this.display_client_details('hide');if(associate_result&&customers.length===1){this.new_client=customers[0];this.save_changes();this.gui.back();}
this.render_list(customers);}else{customers=this.pos.db.get_partners_sorted();this.render_list(customers);}},clear_search:function(){var customers=this.pos.db.get_partners_sorted(1000);this.render_list(customers);this.$('.searchbox input')[0].value='';this.$('.searchbox input').focus();},render_list:function(partners){var contents=this.$el[0].querySelector('.client-list-contents');contents.innerHTML="";for(var i=0,len=Math.min(partners.length,1000);i<len;i++){var partner=partners[i];var clientline=this.partner_cache.get_node(partner.id);if(!clientline){var clientline_html=QWeb.render('ClientLine',{widget:this,partner:partners[i]});var clientline=document.createElement('tbody');clientline.innerHTML=clientline_html;clientline=clientline.childNodes[1];this.partner_cache.cache_node(partner.id,clientline);}
if(partner===this.old_client){clientline.classList.add('highlight');}else{clientline.classList.remove('highlight');}
contents.appendChild(clientline);}},save_changes:function(){var order=this.pos.get_order();if(this.has_client_changed()){var default_fiscal_position_id=_.findWhere(this.pos.fiscal_positions,{'id':this.pos.config.default_fiscal_position_id[0]});if(this.new_client){if(this.new_client.property_account_position_id){var client_fiscal_position_id=_.findWhere(this.pos.fiscal_positions,{'id':this.new_client.property_account_position_id[0]});order.fiscal_position=client_fiscal_position_id||default_fiscal_position_id;}
order.set_pricelist(_.findWhere(this.pos.pricelists,{'id':this.new_client.property_product_pricelist[0]})||this.pos.default_pricelist);}else{order.fiscal_position=default_fiscal_position_id;order.set_pricelist(this.pos.default_pricelist);}
order.set_client(this.new_client);}},has_client_changed:function(){if(this.old_client&&this.new_client){return this.old_client.id!==this.new_client.id;}else{return!!this.old_client!==!!this.new_client;}},toggle_save_button:function(){var $button=this.$('.button.next');if(this.editing_client){$button.addClass('oe_hidden');return;}else if(this.new_client){if(!this.old_client){$button.text(_t('Set Customer'));}else{$button.text(_t('Change Customer'));}}else{$button.text(_t('Deselect Customer'));}
$button.toggleClass('oe_hidden',!this.has_client_changed());},line_select:function(event,$line,id){var partner=this.pos.db.get_partner_by_id(id);this.$('.client-list .lowlight').removeClass('lowlight');if($line.hasClass('highlight')){$line.removeClass('highlight');$line.addClass('lowlight');this.display_client_details('hide',partner);this.new_client=null;this.toggle_save_button();}else{this.$('.client-list .highlight').removeClass('highlight');$line.addClass('highlight');var y=event.pageY-$line.parent().offset().top;this.display_client_details('show',partner,y);this.new_client=partner;this.toggle_save_button();}},partner_icon_url:function(id){return'/web/image?model=res.partner&id='+id+'&field=image_small';},edit_client_details:function(partner){this.display_client_details('edit',partner);},undo_client_details:function(partner){if(!partner.id){this.display_client_details('hide');}else{this.display_client_details('show',partner);}},save_client_details:function(partner){var self=this;var fields={};this.$('.client-details-contents .detail').each(function(idx,el){fields[el.name]=el.value||false;});if(!fields.name){this.gui.show_popup('error',_t('A Customer Name Is Required'));return;}
if(this.uploaded_picture){fields.image=this.uploaded_picture;}
fields.id=partner.id||false;fields.country_id=fields.country_id||false;if(fields.property_product_pricelist){fields.property_product_pricelist=parseInt(fields.property_product_pricelist,10);}else{fields.property_product_pricelist=false;}
rpc.query({model:'res.partner',method:'create_from_ui/index.php',args:[fields],}).then(function(partner_id){self.saved_client_details(partner_id);},function(err,ev){ev.preventDefault();var error_body=_t('Your Internet connection is probably down.');if(err.data){var except=err.data;error_body=except.arguments&&except.arguments[0]||except.message||error_body;}
self.gui.show_popup('error',{'title':_t('Error: Could not Save Changes'),'body':error_body,});});},saved_client_details:function(partner_id){var self=this;this.reload_partners().then(function(){var partner=self.pos.db.get_partner_by_id(partner_id);if(partner){self.new_client=partner;self.toggle_save_button();self.display_client_details('show',partner);}else{self.display_client_details('hide');}});},resize_image_to_dataurl:function(img,maxwidth,maxheight,callback){img.onload=function(){var canvas=document.createElement('canvas');var ctx=canvas.getContext('2d');var ratio=1;if(img.width>maxwidth){ratio=maxwidth/img.width;}
if(img.height*ratio>maxheight){ratio=maxheight/img.height;}
var width=Math.floor(img.width*ratio);var height=Math.floor(img.height*ratio);canvas.width=width;canvas.height=height;ctx.drawImage(img,0,0,width,height);var dataurl=canvas.toDataURL();callback(dataurl);};},load_image_file:function(file,callback){var self=this;if(!file.type.match(/image.*/)){this.gui.show_popup('error',{title:_t('Unsupported File Format'),body:_t('Only web-compatible Image formats such as .png or .jpeg are supported'),});return;}
var reader=new FileReader();reader.onload=function(event){var dataurl=event.target.result;var img=new Image();img.src=dataurl;self.resize_image_to_dataurl(img,800,600,callback);};reader.onerror=function(){self.gui.show_popup('error',{title:_t('Could Not Read Image'),body:_t('The provided file could not be read due to an unknown error'),});};reader.readAsDataURL(file);},reload_partners:function(){var self=this;return this.pos.load_new_partners().then(function(){self.partner_cache=new DomCache();self.render_list(self.pos.db.get_partners_sorted(1000));var curr_client=self.pos.get_order().get_client();if(curr_client){self.pos.get_order().set_client(self.pos.db.get_partner_by_id(curr_client.id));}});},display_client_details:function(visibility,partner,clickpos){var self=this;var searchbox=this.$('.searchbox input');var contents=this.$('.client-details-contents');var parent=this.$('.client-list').parent();var scroll=parent.scrollTop();var height=contents.height();contents.off('click','.button.edit');contents.off('click','.button.save');contents.off('click','.button.undo');contents.on('click','.button.edit',function(){self.edit_client_details(partner);});contents.on('click','.button.save',function(){self.save_client_details(partner);});contents.on('click','.button.undo',function(){self.undo_client_details(partner);});this.editing_client=false;this.uploaded_picture=null;if(visibility==='show'){contents.empty();contents.append($(QWeb.render('ClientDetails',{widget:this,partner:partner})));var new_height=contents.height();if(!this.details_visible){parent.height('-='+new_height);if(clickpos<scroll+new_height+20){parent.scrollTop(clickpos-20);}else{parent.scrollTop(parent.scrollTop()+new_height);}}else{parent.scrollTop(parent.scrollTop()-height+new_height);}
this.details_visible=true;this.toggle_save_button();}else if(visibility==='edit'){if(this.pos.config.iface_vkeyboard&&this.chrome.widget.keyboard){contents.off('click','.detail');searchbox.off('click');contents.on('click','.detail',function(ev){self.chrome.widget.keyboard.connect(ev.target);self.chrome.widget.keyboard.show();});searchbox.on('click',function(){self.chrome.widget.keyboard.connect($(this));});}
this.editing_client=true;contents.empty();contents.append($(QWeb.render('ClientDetailsEdit',{widget:this,partner:partner})));this.toggle_save_button();contents.find('input').blur(function(){setTimeout(function(){self.$('.window').scrollTop(0);},0);});contents.find('.image-uploader').on('change',function(event){self.load_image_file(event.target.files[0],function(res){if(res){contents.find('.client-picture img, .client-picture .fa').remove();contents.find('.client-picture').append("<img src='"+res+"'>");contents.find('.detail.picture').remove();self.uploaded_picture=res;}});});}else if(visibility==='hide'){contents.empty();parent.height('100%');if(height>scroll){contents.css({height:height+'px'});contents.animate({height:0},400,function(){contents.css({height:''});});}else{parent.scrollTop(parent.scrollTop()-height);}
this.details_visible=false;this.toggle_save_button();}},close:function(){this._super();if(this.pos.config.iface_vkeyboard&&this.chrome.widget.keyboard){this.chrome.widget.keyboard.hide();}},});gui.define_screen({name:'clientlist',widget:ClientListScreenWidget});var ReceiptScreenWidget=ScreenWidget.extend({template:'ReceiptScreenWidget',show:function(){this._super();var self=this;this.render_change();this.render_receipt();this.handle_auto_print();},handle_auto_print:function(){if(this.should_auto_print()){this.print();if(this.should_close_immediately()){this.click_next();}}else{this.lock_screen(false);}},should_auto_print:function(){return this.pos.config.iface_print_auto&&!this.pos.get_order()._printed;},should_close_immediately:function(){return this.pos.config.iface_print_via_proxy&&this.pos.config.iface_print_skip_screen;},lock_screen:function(locked){this._locked=locked;if(locked){this.$('.next').removeClass('highlight');}else{this.$('.next').addClass('highlight');}},get_receipt_render_env:function(){var order=this.pos.get_order();return{widget:this,pos:this.pos,order:order,receipt:order.export_for_printing(),orderlines:order.get_orderlines(),paymentlines:order.get_paymentlines(),};},print_web:function(){if($.browser.safari){document.execCommand('print',false,null);}
else{window.print();}
this.pos.get_order()._printed=true;},print_xml:function(){var receipt=QWeb.render('XmlReceipt',this.get_receipt_render_env());this.pos.proxy.print_receipt(receipt);this.pos.get_order()._printed=true;},print:function(){var self=this;if(!this.pos.config.iface_print_via_proxy){this.lock_screen(true);setTimeout(function(){self.lock_screen(false);},1000);this.print_web();}else{this.print_xml();this.lock_screen(false);}},click_next:function(){this.pos.get_order().finalize();},click_back:function(){},renderElement:function(){var self=this;this._super();this.$('.next').click(function(){if(!self._locked){self.click_next();}});this.$('.back').click(function(){if(!self._locked){self.click_back();}});this.$('.button.print').click(function(){if(!self._locked){self.print();}});},render_change:function(){this.$('.change-value').html(this.format_currency(this.pos.get_order().get_change()));},render_receipt:function(){this.$('.pos-receipt-container').html(QWeb.render('PosTicket',this.get_receipt_render_env()));},});gui.define_screen({name:'receipt',widget:ReceiptScreenWidget});var PaymentScreenWidget=ScreenWidget.extend({template:'PaymentScreenWidget',back_screen:'product',init:function(parent,options){var self=this;this._super(parent,options);this.pos.bind('change:selectedOrder',function(){this.renderElement();this.watch_order_changes();},this);this.watch_order_changes();this.inputbuffer="";this.firstinput=true;this.decimal_point=_t.database.parameters.decimal_point;this.keyboard_keydown_handler=function(event){if(event.keyCode===8||event.keyCode===46){event.preventDefault();self.keyboard_handler(event);}};this.keyboard_handler=function(event){var key='';if(event.type==="keypress"){if(event.keyCode===13){self.validate_order();}else if(event.keyCode===190||event.keyCode===110||event.keyCode===188||event.keyCode===46){key=self.decimal_point;}else if(event.keyCode>=48&&event.keyCode<=57){key=''+(event.keyCode-48);}else if(event.keyCode===45){key='-';}else if(event.keyCode===43){key='+';}}else{if(event.keyCode===46){key='CLEAR';}else if(event.keyCode===8){key='BACKSPACE';}}
self.payment_input(key);event.preventDefault();};this.pos.bind('change:selectedClient',function(){self.customer_changed();},this);},reset_input:function(){var line=this.pos.get_order().selected_paymentline;this.firstinput=true;if(line){this.inputbuffer=this.format_currency_no_symbol(line.get_amount());}else{this.inputbuffer="";}},payment_input:function(input){var newbuf=this.gui.numpad_input(this.inputbuffer,input,{'firstinput':this.firstinput});this.firstinput=(newbuf.length===0);if(this.gui.has_popup()){return;}
if(newbuf!==this.inputbuffer){this.inputbuffer=newbuf;var order=this.pos.get_order();if(order.selected_paymentline){var amount=this.inputbuffer;if(this.inputbuffer!=="-"){amount=field_utils.parse.float(this.inputbuffer);}
order.selected_paymentline.set_amount(amount);this.order_changes();this.render_paymentlines();this.$('.paymentline.selected .edit').text(this.format_currency_no_symbol(amount));}}},click_numpad:function(button){var paymentlines=this.pos.get_order().get_paymentlines();var open_paymentline=false;for(var i=0;i<paymentlines.length;i++){if(!paymentlines[i].paid){open_paymentline=true;}}
if(!open_paymentline){this.pos.get_order().add_paymentline(this.pos.cashregisters[0]);this.render_paymentlines();}
this.payment_input(button.data('action'));},render_numpad:function(){var self=this;var numpad=$(QWeb.render('PaymentScreen-Numpad',{widget:this}));numpad.on('click','button',function(){self.click_numpad($(this));});return numpad;},click_delete_paymentline:function(cid){var lines=this.pos.get_order().get_paymentlines();for(var i=0;i<lines.length;i++){if(lines[i].cid===cid){this.pos.get_order().remove_paymentline(lines[i]);this.reset_input();this.render_paymentlines();return;}}},click_paymentline:function(cid){var lines=this.pos.get_order().get_paymentlines();for(var i=0;i<lines.length;i++){if(lines[i].cid===cid){this.pos.get_order().select_paymentline(lines[i]);this.reset_input();this.render_paymentlines();return;}}},render_paymentlines:function(){var self=this;var order=this.pos.get_order();if(!order){return;}
var lines=order.get_paymentlines();var due=order.get_due();var extradue=0;if(due&&lines.length&&due!==order.get_due(lines[lines.length-1])){extradue=due;}
this.$('.paymentlines-container').empty();var lines=$(QWeb.render('PaymentScreen-Paymentlines',{widget:this,order:order,paymentlines:lines,extradue:extradue,}));lines.on('click','.delete-button',function(){self.click_delete_paymentline($(this).data('cid'));});lines.on('click','.paymentline',function(){self.click_paymentline($(this).data('cid'));});lines.appendTo(this.$('.paymentlines-container'));},click_paymentmethods:function(id){var cashregister=null;for(var i=0;i<this.pos.cashregisters.length;i++){if(this.pos.cashregisters[i].journal_id[0]===id){cashregister=this.pos.cashregisters[i];break;}}
this.pos.get_order().add_paymentline(cashregister);this.reset_input();this.render_paymentlines();},render_paymentmethods:function(){var self=this;var methods=$(QWeb.render('PaymentScreen-Paymentmethods',{widget:this}));methods.on('click','.paymentmethod',function(){self.click_paymentmethods($(this).data('id'));});return methods;},click_invoice:function(){var order=this.pos.get_order();order.set_to_invoice(!order.is_to_invoice());if(order.is_to_invoice()){this.$('.js_invoice').addClass('highlight');}else{this.$('.js_invoice').removeClass('highlight');}},click_tip:function(){var self=this;var order=this.pos.get_order();var tip=order.get_tip();var change=order.get_change();var value=tip;if(tip===0&&change>0){value=change;}
this.gui.show_popup('number',{'title':tip?_t('Change Tip'):_t('Add Tip'),'value':self.format_currency_no_symbol(value),'confirm':function(value){order.set_tip(field_utils.parse.float(value));self.order_changes();self.render_paymentlines();}});},customer_changed:function(){var client=this.pos.get_client();this.$('.js_customer_name').text(client?client.name:_t('Customer'));},click_set_customer:function(){this.gui.show_screen('clientlist');},click_back:function(){this.gui.show_screen('products');},renderElement:function(){var self=this;this._super();var numpad=this.render_numpad();numpad.appendTo(this.$('.payment-numpad'));var methods=this.render_paymentmethods();methods.appendTo(this.$('.paymentmethods-container'));this.render_paymentlines();this.$('.back').click(function(){self.click_back();});this.$('.next').click(function(){self.validate_order();});this.$('.js_set_customer').click(function(){self.click_set_customer();});this.$('.js_tip').click(function(){self.click_tip();});this.$('.js_invoice').click(function(){self.click_invoice();});this.$('.js_cashdrawer').click(function(){self.pos.proxy.open_cashbox();});},show:function(){this.pos.get_order().clean_empty_paymentlines();this.reset_input();this.render_paymentlines();this.order_changes();$('body').keypress(this.keyboard_handler);$('body').keydown(this.keyboard_keydown_handler);window.document.body.addEventListener('keypress',this.keyboard_handler);window.document.body.addEventListener('keydown',this.keyboard_keydown_handler);this._super();},hide:function(){$('body').off('keypress',this.keyboard_handler);$('body').off('keydown',this.keyboard_keydown_handler);window.document.body.removeEventListener('keypress',this.keyboard_handler);window.document.body.removeEventListener('keydown',this.keyboard_keydown_handler);this._super();},watch_order_changes:function(){var self=this;var order=this.pos.get_order();if(!order){return;}
if(this.old_order){this.old_order.unbind(null,null,this);}
order.bind('all',function(){self.order_changes();});this.old_order=order;},order_changes:function(){var self=this;var order=this.pos.get_order();if(!order){return;}else if(order.is_paid()){self.$('.next').addClass('highlight');}else{self.$('.next').removeClass('highlight');}},order_is_valid:function(force_validation){var self=this;var order=this.pos.get_order();if(order.get_orderlines().length===0){this.gui.show_popup('error',{'title':_t('Empty Order'),'body':_t('There must be at least one product in your order before it can be validated'),});return false;}
if(!order.is_paid()||this.invoicing){return false;}
if(Math.abs(order.get_total_with_tax()-order.get_total_paid())>0.00001){var cash=false;for(var i=0;i<this.pos.cashregisters.length;i++){cash=cash||(this.pos.cashregisters[i].journal.type==='cash');}
if(!cash){this.gui.show_popup('error',{title:_t('Cannot return change without a cash payment method'),body:_t('There is no cash payment method available in this point of sale to handle the change.\n\n Please pay the exact amount or add a cash payment method in the point of sale configuration'),});return false;}}
if(!force_validation&&order.get_total_with_tax()>0&&(order.get_total_with_tax()*1000<order.get_total_paid())){this.gui.show_popup('confirm',{title:_t('Please Confirm Large Amount'),body:_t('Are you sure that the customer wants to  pay')+' '+
this.format_currency(order.get_total_paid())+' '+
_t('for an order of')+' '+
this.format_currency(order.get_total_with_tax())+' '+
_t('? Clicking "Confirm" will validate the payment.'),confirm:function(){self.validate_order('confirm');},});return false;}
return true;},finalize_validation:function(){var self=this;var order=this.pos.get_order();if(order.is_paid_with_cash()&&this.pos.config.iface_cashdrawer){this.pos.proxy.open_cashbox();}
order.initialize_validation_date();order.finalized=true;if(order.is_to_invoice()){var invoiced=this.pos.push_and_invoice_order(order);this.invoicing=true;invoiced.fail(function(error){self.invoicing=false;order.finalized=false;if(error.message==='Missing Customer'){self.gui.show_popup('confirm',{'title':_t('Please select the Customer'),'body':_t('You need to select the customer before you can invoice an order.'),confirm:function(){self.gui.show_screen('clientlist');},});}else if(error.code<0){self.gui.show_popup('error',{'title':_t('The order could not be sent'),'body':_t('Check your internet connection and try again.'),});}else if(error.code===200){self.gui.show_popup('error-traceback',{'title':error.data.message||_t("Server Error"),'body':error.data.debug||_t('The server encountered an error while receiving your order.'),});}else{self.gui.show_popup('error',{'title':_t("Unknown Error"),'body':_t("The order could not be sent to the server due to an unknown error"),});}});invoiced.done(function(){self.invoicing=false;self.gui.show_screen('receipt');});}else{this.pos.push_order(order);this.gui.show_screen('receipt');}},validate_order:function(force_validation){if(this.order_is_valid(force_validation)){this.finalize_validation();}},});gui.define_screen({name:'payment',widget:PaymentScreenWidget});var set_fiscal_position_button=ActionButtonWidget.extend({template:'SetFiscalPositionButton',init:function(parent,options){this._super(parent,options);this.pos.get('orders').bind('add remove change',function(){this.renderElement();},this);this.pos.bind('change:selectedOrder',function(){this.renderElement();},this);},button_click:function(){var self=this;var no_fiscal_position=[{label:_t("None"),}];var fiscal_positions=_.map(self.pos.fiscal_positions,function(fiscal_position){return{label:fiscal_position.name,item:fiscal_position};});var selection_list=no_fiscal_position.concat(fiscal_positions);self.gui.show_popup('selection',{title:_t('Select tax'),list:selection_list,confirm:function(fiscal_position){var order=self.pos.get_order();order.fiscal_position=fiscal_position;_.each(order.orderlines.models,function(line){line.set_quantity(line.quantity);});order.trigger('change');},is_selected:function(fiscal_position){return fiscal_position===self.pos.get_order().fiscal_position;}});},get_current_fiscal_position_name:function(){var name=_t('Tax');var order=this.pos.get_order();if(order){var fiscal_position=order.fiscal_position;if(fiscal_position){name=fiscal_position.display_name;}}
return name;},});define_action_button({'name':'set_fiscal_position','widget':set_fiscal_position_button,'condition':function(){return this.pos.fiscal_positions.length>0;},});var set_pricelist_button=ActionButtonWidget.extend({template:'SetPricelistButton',init:function(parent,options){this._super(parent,options);this.pos.get('orders').bind('add remove change',function(){this.renderElement();},this);this.pos.bind('change:selectedOrder',function(){this.renderElement();},this);},button_click:function(){var self=this;var pricelists=_.map(self.pos.pricelists,function(pricelist){return{label:pricelist.name,item:pricelist};});self.gui.show_popup('selection',{title:_t('Select pricelist'),list:pricelists,confirm:function(pricelist){var order=self.pos.get_order();order.set_pricelist(pricelist);},is_selected:function(pricelist){return pricelist.id===self.pos.get_order().pricelist.id;}});},get_current_pricelist_name:function(){var name=_t('Pricelist');var order=this.pos.get_order();if(order){var pricelist=order.pricelist;if(pricelist){name=pricelist.display_name;}}
return name;},});define_action_button({'name':'set_pricelist','widget':set_pricelist_button,'condition':function(){return this.pos.pricelists.length>1;},});return{ReceiptScreenWidget:ReceiptScreenWidget,ActionButtonWidget:ActionButtonWidget,define_action_button:define_action_button,ScreenWidget:ScreenWidget,PaymentScreenWidget:PaymentScreenWidget,OrderWidget:OrderWidget,NumpadWidget:NumpadWidget,ProductScreenWidget:ProductScreenWidget,ProductListWidget:ProductListWidget,ClientListScreenWidget:ClientListScreenWidget,ActionpadWidget:ActionpadWidget,DomCache:DomCache,ProductCategoriesWidget:ProductCategoriesWidget,ScaleScreenWidget:ScaleScreenWidget,set_fiscal_position_button:set_fiscal_position_button,set_pricelist_button:set_pricelist_button,};});;

/* /point_of_sale/static/src/js/tests.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.tour.pricelist',function(require){"use strict";var Tour=require('web_tour.tour');var rpc=require('web.rpc');var utils=require('web.utils');var round_di=utils.round_decimals;function assert(condition,message){if(!condition){throw message||"Assertion failed";}}
function _build_pricelist_context(pricelist,quantity,date){return{pricelist:pricelist.id,quantity:quantity,};}
function compare_backend_frontend(product,pricelist_name,quantity){return function(){var pricelist=_.findWhere(posmodel.pricelists,{name:pricelist_name});var frontend_price=product.get_price(pricelist,quantity);frontend_price=round_di(frontend_price,posmodel.dp['Product Price']);var context=_build_pricelist_context(pricelist,quantity);return rpc.query({model:'product.product',method:'read',args:[[product.id],['price']],context:context}).then(function(backend_result){var debug_info=_.extend(context,{product:product.id,product_display_name:product.display_name,pricelist_name:pricelist.name,});var backend_price=backend_result[0].price;assert(frontend_price===backend_price,JSON.stringify(debug_info)+' DOESN\'T MATCH -> '+backend_price+' (backend) != '+frontend_price+' (frontend)');return(new $.Deferred()).resolve();});};}
var steps=[{content:'waiting for loading to finish',trigger:'.o_main_content:has(.loader:hidden)',run:function(){var product_boni_orange=posmodel.db.search_product_in_category(0,'Boni Oranges')[0];var product_papillon_orange=posmodel.db.search_product_in_category(0,'Orange Butterfly')[0];var product_citron=posmodel.db.search_product_in_category(0,'Lemon')[0];var product_limon=posmodel.db.search_product_in_category(0,'Stringers')[0];var product_pamplemousse=posmodel.db.search_product_in_category(0,'Red grapefruit')[0];var product_grapes=posmodel.db.search_product_in_category(0,'Black Grapes')[0];var product_poire_conference=posmodel.db.search_product_in_category(0,'Conference pears')[0];var product_external_audit=posmodel.db.search_product_in_category(0,'External Audit')[0];var product_miscellaneous=posmodel.db.search_product_in_category(0,'Miscellaneous')[0];compare_backend_frontend(product_grapes,'Public Pricelist',0,undefined)().then(compare_backend_frontend(product_grapes,'Public Pricelist',1,undefined)).then(compare_backend_frontend(product_grapes,'Fixed',1,undefined)).then(compare_backend_frontend(product_boni_orange,'Fixed',1,undefined)).then(compare_backend_frontend(product_papillon_orange,'Fixed',1,undefined)).then(compare_backend_frontend(product_boni_orange,'Percentage',1,undefined)).then(compare_backend_frontend(product_papillon_orange,'Percentage',1,undefined)).then(compare_backend_frontend(product_citron,'Percentage',1,undefined)).then(compare_backend_frontend(product_boni_orange,'Formula',1,undefined)).then(compare_backend_frontend(product_papillon_orange,'Formula',1,undefined)).then(compare_backend_frontend(product_citron,'Formula',1,undefined)).then(compare_backend_frontend(product_limon,'Formula',1,undefined)).then(compare_backend_frontend(product_pamplemousse,'Formula',1,undefined)).then(compare_backend_frontend(product_boni_orange,'min_quantity ordering',1,undefined)).then(compare_backend_frontend(product_boni_orange,'min_quantity ordering',2,undefined)).then(compare_backend_frontend(product_grapes,'Category vs no category',1,undefined)).then(compare_backend_frontend(product_external_audit,'Category vs no category',1,undefined)).then(compare_backend_frontend(product_grapes,'Category',1,undefined)).then(compare_backend_frontend(product_external_audit,'Category',1,undefined)).then(compare_backend_frontend(product_boni_orange,'Product template',1,undefined)).then(compare_backend_frontend(product_external_audit,'Product template',1,undefined)).then(compare_backend_frontend(product_boni_orange,'Dates',1,undefined)).then(compare_backend_frontend(product_miscellaneous,'Cost base',1,undefined)).then(compare_backend_frontend(product_miscellaneous,'Pricelist base',1,undefined)).then(compare_backend_frontend(product_miscellaneous,'Pricelist base 2',1,undefined)).then(compare_backend_frontend(product_papillon_orange,'Pricelist base rounding',1,undefined)).then(compare_backend_frontend(product_poire_conference,'Public Pricelist',1,undefined)).then(function(){$('.pos').addClass('done-testing');});},}];steps=steps.concat([{content:"wait for unit tests to finish",trigger:".pos.done-testing",run:function(){},},{content:"click pricelist button",trigger:".control-button.o_pricelist_button",},{content:"verify default pricelist is set",trigger:".selection-item.selected:contains('Public Pricelist')",run:function(){},},{content:"select fixed pricelist",trigger:".selection-item:contains('Fixed')",},{content:"prices should be updated in the product screen",trigger:".product:contains('Miscellaneous'):contains('$ 1.00')",run:function(){},},{content:"open customer list",trigger:"button.set-customer",},{content:"select agrolait",trigger:".client-line:contains('Agrolait')",},{content:"confirm selection",trigger:".clientlist-screen .next",},{content:"click pricelist button",trigger:".control-button.o_pricelist_button",},{content:"verify pricelist changed",trigger:".selection-item.selected:contains('Public Pricelist')",run:function(){},},{content:"cancel pricelist dialog",trigger:".button.cancel:visible",},{content:"prices should be updated in the product screen",trigger:".product:contains('Miscellaneous'):contains('$ 18.00')",run:function(){},},{content:"open customer list",trigger:"button.set-customer",},{content:"select think big systems",trigger:".client-line:contains('Think Big Systems')",},{content:"confirm selection",trigger:".clientlist-screen .next",},{content:"click pricelist button",trigger:".control-button.o_pricelist_button",},{content:"verify pricelist remained public pricelist ('Not loaded' is not available)",trigger:".selection-item.selected:contains('Public Pricelist')",run:function(){},},{content:"cancel pricelist dialog",trigger:".button.cancel:visible",},{content:"click pricelist button",trigger:".control-button.o_pricelist_button",},{content:"select fixed pricelist",trigger:".selection-item:contains('min_quantity ordering')",},{content:"order 1 kg oranges",trigger:".product:contains('Boni Oranges')",},{content:"change qty to 2 kg",trigger:".numpad button.input-button:visible:contains('2')",},{content:"verify that unit price of oranges changed to $1",trigger:".total > .value:contains('$ 2.00')",},{content:"order different oranges",trigger:".product:contains('Orange Butterfly')",},{content:"change to price mode",trigger:".numpad button:contains('Price')",},{content:"manually override the unit price of these oranges to $5",trigger:".numpad button.input-button:visible:contains('5')",},{content:"change back to qty mode",trigger:".numpad button:contains('Qty')",},{content:"click pricelist button",trigger:".control-button.o_pricelist_button",},{content:"select public pricelist",trigger:".selection-item:contains('Public Pricelist')",},{content:"verify that the boni oranges have been recomputed and the\
butterfly oranges have not (their price was manually overriden)",trigger:".total > .value:contains('$ 8.96')",},{content:"click pricelist button",trigger:".control-button.o_pricelist_button",},{content:"select fixed pricelist",trigger:".selection-item:contains('min_quantity ordering')",},{content:"order 1 miscellaneous product",trigger:".product:contains('Miscellaneous')",},{content:"order 1 miscellaneous product",trigger:".product:contains('Miscellaneous')",},{content:"order 1 miscellaneous product",trigger:".product:contains('Miscellaneous')",},{content:"verify there is one line with 3 miscellaneous products",trigger:".orderline:contains('Miscellaneous') em:contains('3.000')",run:function(){},},{content:"close the Point of Sale frontend",trigger:".header-button",},{content:"confirm closing the frontend",trigger:".header-button",}]);Tour.register('pos_pricelist',{test:true,url:'/pos/web'},steps);});odoo.define('point_of_sale.tour.acceptance',function(require){"use strict";var Tour=require("web_tour.tour");function add_product_to_order(product_name){return[{content:'buy '+product_name,trigger:'.product-list .product-name:contains("'+product_name+'")',},{content:'the '+product_name+' have been added to the order',trigger:'.order .product-name:contains("'+product_name+'")',run:function(){},}];}
function generate_keypad_steps(amount_str,keypad_selector){var i,steps=[],current_char;for(i=0;i<amount_str.length;++i){current_char=amount_str[i];steps.push({content:'press '+current_char+' on payment keypad',trigger:keypad_selector+' .input-button:contains("'+current_char+'"):visible'});}
return steps;}
function generate_payment_screen_keypad_steps(amount_str){return generate_keypad_steps(amount_str,'.payment-numpad');}
function generate_product_screen_keypad_steps(amount_str){return generate_keypad_steps(amount_str,'.numpad');}
function verify_order_total(total_str){return[{content:'order total contains '+total_str,trigger:'.order .total .value:contains("'+total_str+'")',run:function(){},}];}
function goto_payment_screen_and_select_payment_method(){return[{content:"go to payment screen",trigger:'.button.pay',},{content:"pay with cash",trigger:'.paymentmethod:contains("Cash")',}];}
function finish_order(){return[{content:"validate the order",trigger:'.button.next:visible',},{content:"verify that the order is being sent to the backend",trigger:".js_connecting:visible",run:function(){},},{content:"verify that the order has been succesfully sent to the backend",trigger:".js_connected:visible",run:function(){},},{content:"next order",trigger:'.button.next:visible',}];}
var steps=[{content:'waiting for loading to finish',trigger:'.o_main_content:has(.loader:hidden)',run:function(){},}];steps=steps.concat(add_product_to_order('Peaches'));steps=steps.concat(verify_order_total('5.10'));steps=steps.concat(add_product_to_order('Peaches'));steps=steps.concat(verify_order_total('10.20'));steps=steps.concat(goto_payment_screen_and_select_payment_method());steps=steps.concat(generate_payment_screen_keypad_steps("12.20"));steps=steps.concat([{content:"verify tendered",trigger:'.col-tendered:contains("12.20")',run:function(){},},{content:"verify change",trigger:'.col-change:contains("2.00")',run:function(){},}]);steps=steps.concat(finish_order());steps=steps.concat(add_product_to_order('Peaches'));steps=steps.concat(generate_product_screen_keypad_steps('.999'));steps=steps.concat(verify_order_total('5.09'));steps=steps.concat(goto_payment_screen_and_select_payment_method());steps=steps.concat(generate_payment_screen_keypad_steps("10"));steps=steps.concat(finish_order());steps=steps.concat([{content:"close the Point of Sale frontend",trigger:".header-button",},{content:"confirm closing the frontend",trigger:".header-button.confirm",run:function(){},}]);Tour.register('pos_basic_order',{test:true,url:'/pos/web'},steps);});;

/* /pos_restaurant/static/lib/js/jquery.event.drag-2.2.js defined in bundle 'point_of_sale.assets' */
;(function($){$.fn.drag=function(str,arg,opts){var type=typeof str=="string"?str:"",fn=$.isFunction(str)?str:$.isFunction(arg)?arg:null;if(type.indexOf("drag")!==0)
type="drag"+type;opts=(str==fn?arg:opts)||{};return fn?this.bind(type,opts,fn):this.trigger(type);};var $event=$.event,$special=$event.special,drag=$special.drag={defaults:{which:1,distance:0,not:':input',handle:null,relative:false,drop:true,click:false},datakey:"dragdata",noBubble:true,add:function(obj){var data=$.data(this,drag.datakey),opts=obj.data||{};data.related+=1;$.each(drag.defaults,function(key,def){if(opts[key]!==undefined)
data[key]=opts[key];});},remove:function(){$.data(this,drag.datakey).related-=1;},setup:function(){if($.data(this,drag.datakey))
return;var data=$.extend({related:0},drag.defaults);$.data(this,drag.datakey,data);$event.add(this,"touchstart mousedown",drag.init,data);if(this.attachEvent)
this.attachEvent("ondragstart",drag.dontstart);},teardown:function(){var data=$.data(this,drag.datakey)||{};if(data.related)
return;$.removeData(this,drag.datakey);$event.remove(this,"touchstart mousedown",drag.init);drag.textselect(true);if(this.detachEvent)
this.detachEvent("ondragstart",drag.dontstart);},init:function(event){if(drag.touched)
return;var dd=event.data,results;if(event.which!=0&&dd.which>0&&event.which!=dd.which)
return;if($(event.target).is(dd.not))
return;if(dd.handle&&!$(event.target).closest(dd.handle,event.currentTarget).length)
return;drag.touched=event.type=='touchstart'?this:null;dd.propagates=1;dd.mousedown=this;dd.interactions=[drag.interaction(this,dd)];dd.target=event.target;dd.pageX=event.pageX;dd.pageY=event.pageY;dd.dragging=null;results=drag.hijack(event,"draginit",dd);if(!dd.propagates)
return;results=drag.flatten(results);if(results&&results.length){dd.interactions=[];$.each(results,function(){dd.interactions.push(drag.interaction(this,dd));});}
dd.propagates=dd.interactions.length;if(dd.drop!==false&&$special.drop)
$special.drop.handler(event,dd);drag.textselect(false);if(drag.touched)
$event.add(drag.touched,"touchmove touchend",drag.handler,dd);else
$event.add(document,"mousemove mouseup",drag.handler,dd);if(!drag.touched||dd.live)
return false;},interaction:function(elem,dd){var offset=$(elem)[dd.relative?"position":"offset"]()||{top:0,left:0};return{drag:elem,callback:new drag.callback(),droppable:[],offset:offset};},handler:function(event){var dd=event.data;switch(event.type){case!dd.dragging&&'touchmove':event.preventDefault();case!dd.dragging&&'mousemove':if(Math.pow(event.pageX-dd.pageX,2)+Math.pow(event.pageY-dd.pageY,2)<Math.pow(dd.distance,2))
break;event.target=dd.target;drag.hijack(event,"dragstart",dd);if(dd.propagates)
dd.dragging=true;case'touchmove':event.preventDefault();case'mousemove':if(dd.dragging){drag.hijack(event,"drag",dd);if(dd.propagates){if(dd.drop!==false&&$special.drop)
$special.drop.handler(event,dd);break;}
event.type="mouseup";}
case'touchend':case'mouseup':default:if(drag.touched)
$event.remove(drag.touched,"touchmove touchend",drag.handler);else
$event.remove(document,"mousemove mouseup",drag.handler);if(dd.dragging){if(dd.drop!==false&&$special.drop)
$special.drop.handler(event,dd);drag.hijack(event,"dragend",dd);}
drag.textselect(true);if(dd.click===false&&dd.dragging)
$.data(dd.mousedown,"suppress.click",new Date().getTime()+5);dd.dragging=drag.touched=false;break;}},hijack:function(event,type,dd,x,elem){if(!dd)
return;var orig={event:event.originalEvent,type:event.type},mode=type.indexOf("drop")?"drag":"drop",result,i=x||0,ia,$elems,callback,len=!isNaN(x)?x:dd.interactions.length;event.type=type;event.originalEvent=null;dd.results=[];do if(ia=dd.interactions[i]){if(type!=="dragend"&&ia.cancelled)
continue;callback=drag.properties(event,dd,ia);ia.results=[];$(elem||ia[mode]||dd.droppable).each(function(p,subject){callback.target=subject;event.isPropagationStopped=function(){return false;};result=subject?$event.dispatch.call(subject,event,callback):null;if(result===false){if(mode=="drag"){ia.cancelled=true;dd.propagates-=1;}
if(type=="drop"){ia[mode][p]=null;}}
else if(type=="dropinit")
ia.droppable.push(drag.element(result)||subject);if(type=="dragstart")
ia.proxy=$(drag.element(result)||ia.drag)[0];ia.results.push(result);delete event.result;if(type!=="dropinit")
return result;});dd.results[i]=drag.flatten(ia.results);if(type=="dropinit")
ia.droppable=drag.flatten(ia.droppable);if(type=="dragstart"&&!ia.cancelled)
callback.update();}
while(++i<len)
event.type=orig.type;event.originalEvent=orig.event;return drag.flatten(dd.results);},properties:function(event,dd,ia){var obj=ia.callback;obj.drag=ia.drag;obj.proxy=ia.proxy||ia.drag;obj.startX=dd.pageX;obj.startY=dd.pageY;obj.deltaX=event.pageX-dd.pageX;obj.deltaY=event.pageY-dd.pageY;obj.originalX=ia.offset.left;obj.originalY=ia.offset.top;obj.offsetX=obj.originalX+obj.deltaX;obj.offsetY=obj.originalY+obj.deltaY;obj.drop=drag.flatten((ia.drop||[]).slice());obj.available=drag.flatten((ia.droppable||[]).slice());return obj;},element:function(arg){if(arg&&(arg.jquery||arg.nodeType==1))
return arg;},flatten:function(arr){return $.map(arr,function(member){return member&&member.jquery?$.makeArray(member):member&&member.length?drag.flatten(member):member;});},textselect:function(bool){$(document)[bool?"unbind":"bind"]("selectstart",drag.dontstart).css("MozUserSelect",bool?"":"none");document.unselectable=bool?"off":"on";},dontstart:function(){return false;},callback:function(){}};drag.callback.prototype={update:function(){if($special.drop&&this.available.length)
$.each(this.available,function(i){$special.drop.locate(this,i);});}};var $dispatch=$event.dispatch;$event.dispatch=function(event){if($.data(this,"suppress."+event.type)-new Date().getTime()>0){$.removeData(this,"suppress."+event.type);return;}
return $dispatch.apply(this,arguments);};var touchHooks=$event.fixHooks.touchstart=$event.fixHooks.touchmove=$event.fixHooks.touchend=$event.fixHooks.touchcancel={props:"clientX clientY pageX pageY screenX screenY".split(" "),filter:function(event,orig){if(orig){var touched=(orig.touches&&orig.touches[0])||(orig.changedTouches&&orig.changedTouches[0])||null;if(touched)
$.each(touchHooks.props,function(i,prop){event[prop]=touched[prop];});}
return event;}};$special.draginit=$special.dragstart=$special.dragend=drag;})(jQuery);;

/* /pos_restaurant/static/src/js/multiprint.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.multiprint',function(require){"use strict";var models=require('point_of_sale.models');var screens=require('point_of_sale.screens');var core=require('web.core');var mixins=require('web.mixins');var Session=require('web.Session');var QWeb=core.qweb;var Printer=core.Class.extend(mixins.PropertiesMixin,{init:function(parent,options){mixins.PropertiesMixin.init.call(this);this.setParent(parent);options=options||{};var url=options.url||'http://localhost:8069';this.connection=new Session(undefined,url,{use_cors:true});this.host=url;this.receipt_queue=[];},print:function(receipt){var self=this;if(receipt){this.receipt_queue.push(receipt);}
function send_printing_job(){if(self.receipt_queue.length>0){var r=self.receipt_queue.shift();var options={shadow:true,timeout:5000};self.connection.rpc('/hw_proxy/print_xml_receipt',{receipt:r},options).then(function(){send_printing_job();},function(error,event){self.receipt_queue.unshift(r);console.log('There was an error while trying to print the order:');console.log(error);});}}
send_printing_job();},});models.load_models({model:'restaurant.printer',fields:['name','proxy_ip','product_categories_ids'],domain:null,loaded:function(self,printers){var active_printers={};for(var i=0;i<self.config.printer_ids.length;i++){active_printers[self.config.printer_ids[i]]=true;}
self.printers=[];self.printers_categories={};for(var i=0;i<printers.length;i++){if(active_printers[printers[i].id]){var url=printers[i].proxy_ip||'';if(url.indexOf('//')<0){url='http://'+url;}
if(url.indexOf(':',url.indexOf('//')+2)<0){url=url+':8069';}
var printer=new Printer(self,{url:url});printer.config=printers[i];self.printers.push(printer);for(var j=0;j<printer.config.product_categories_ids.length;j++){self.printers_categories[printer.config.product_categories_ids[j]]=true;}}}
self.printers_categories=_.keys(self.printers_categories);self.config.iface_printers=!!self.printers.length;},});var _super_orderline=models.Orderline.prototype;models.Orderline=models.Orderline.extend({initialize:function(){_super_orderline.initialize.apply(this,arguments);if(!this.pos.config.iface_printers){return;}
if(typeof this.mp_dirty==='undefined'){this.mp_dirty=this.printable()||undefined;}
if(!this.mp_skip){this.mp_skip=false;}},printable:function(){return this.pos.db.is_product_in_category(this.pos.printers_categories,this.get_product().id);},init_from_JSON:function(json){_super_orderline.init_from_JSON.apply(this,arguments);this.mp_dirty=json.mp_dirty;this.mp_skip=json.mp_skip;},export_as_JSON:function(){var json=_super_orderline.export_as_JSON.apply(this,arguments);json.mp_dirty=this.mp_dirty;json.mp_skip=this.mp_skip;return json;},set_quantity:function(quantity){if(this.pos.config.iface_printers&&quantity!==this.quantity&&this.printable()){this.mp_dirty=true;}
_super_orderline.set_quantity.apply(this,arguments);},can_be_merged_with:function(orderline){return(!this.mp_skip)&&(!orderline.mp_skip)&&_super_orderline.can_be_merged_with.apply(this,arguments);},set_skip:function(skip){if(this.mp_dirty&&skip&&!this.mp_skip){this.mp_skip=true;this.trigger('change',this);}
if(this.mp_skip&&!skip){this.mp_dirty=true;this.mp_skip=false;this.trigger('change',this);}},set_dirty:function(dirty){this.mp_dirty=dirty;this.trigger('change',this);},get_line_diff_hash:function(){if(this.get_note()){return this.id+'|'+this.get_note();}else{return''+this.id;}},});screens.OrderWidget.include({render_orderline:function(orderline){var node=this._super(orderline);if(this.pos.config.iface_printers){if(orderline.mp_skip){node.classList.add('skip');}else if(orderline.mp_dirty){node.classList.add('dirty');}}
return node;},click_line:function(line,event){if(!this.pos.config.iface_printers){this._super(line,event);}else if(this.pos.get_order().selected_orderline!==line){this.mp_dbclk_time=(new Date()).getTime();}else if(!this.mp_dbclk_time){this.mp_dbclk_time=(new Date()).getTime();}else if(this.mp_dbclk_time+500>(new Date()).getTime()){line.set_skip(!line.mp_skip);this.mp_dbclk_time=0;}else{this.mp_dbclk_time=(new Date()).getTime();}
this._super(line,event);},});var _super_order=models.Order.prototype;models.Order=models.Order.extend({build_line_resume:function(){var resume={};this.orderlines.each(function(line){if(line.mp_skip){return;}
var line_hash=line.get_line_diff_hash();var qty=Number(line.get_quantity());var note=line.get_note();var product_id=line.get_product().id;if(typeof resume[line_hash]==='undefined'){resume[line_hash]={qty:qty,note:note,product_id:product_id,product_name_wrapped:line.generate_wrapped_product_name(),};}else{resume[line_hash].qty+=qty;}});return resume;},saveChanges:function(){this.saved_resume=this.build_line_resume();this.orderlines.each(function(line){line.set_dirty(false);});this.trigger('change',this);},computeChanges:function(categories){var current_res=this.build_line_resume();var old_res=this.saved_resume||{};var json=this.export_as_JSON();var add=[];var rem=[];var line_hash;for(line_hash in current_res){var curr=current_res[line_hash];var old=old_res[line_hash];if(typeof old==='undefined'){add.push({'id':curr.product_id,'name':this.pos.db.get_product_by_id(curr.product_id).display_name,'name_wrapped':curr.product_name_wrapped,'note':curr.note,'qty':curr.qty,});}else if(old.qty<curr.qty){add.push({'id':curr.product_id,'name':this.pos.db.get_product_by_id(curr.product_id).display_name,'name_wrapped':curr.product_name_wrapped,'note':curr.note,'qty':curr.qty-old.qty,});}else if(old.qty>curr.qty){rem.push({'id':curr.product_id,'name':this.pos.db.get_product_by_id(curr.product_id).display_name,'name_wrapped':curr.product_name_wrapped,'note':curr.note,'qty':old.qty-curr.qty,});}}
for(line_hash in old_res){if(typeof current_res[line_hash]==='undefined'){var old=old_res[line_hash];rem.push({'id':old.product_id,'name':this.pos.db.get_product_by_id(old.product_id).display_name,'name_wrapped':old.product_name_wrapped,'note':old.note,'qty':old.qty,});}}
if(categories&&categories.length>0){var self=this;var _add=[];var _rem=[];for(var i=0;i<add.length;i++){if(self.pos.db.is_product_in_category(categories,add[i].id)){_add.push(add[i]);}}
add=_add;for(var i=0;i<rem.length;i++){if(self.pos.db.is_product_in_category(categories,rem[i].id)){_rem.push(rem[i]);}}
rem=_rem;}
var d=new Date();var hours=''+d.getHours();hours=hours.length<2?('0'+hours):hours;var minutes=''+d.getMinutes();minutes=minutes.length<2?('0'+minutes):minutes;return{'new':add,'cancelled':rem,'table':json.table||false,'floor':json.floor||false,'name':json.name||'unknown order','time':{'hours':hours,'minutes':minutes,},};},printChanges:function(){var printers=this.pos.printers;for(var i=0;i<printers.length;i++){var changes=this.computeChanges(printers[i].config.product_categories_ids);if(changes['new'].length>0||changes['cancelled'].length>0){var receipt=QWeb.render('OrderChangeReceipt',{changes:changes,widget:this});printers[i].print(receipt);}}},hasChangesToPrint:function(){var printers=this.pos.printers;for(var i=0;i<printers.length;i++){var changes=this.computeChanges(printers[i].config.product_categories_ids);if(changes['new'].length>0||changes['cancelled'].length>0){return true;}}
return false;},hasSkippedChanges:function(){var orderlines=this.get_orderlines();for(var i=0;i<orderlines.length;i++){if(orderlines[i].mp_skip){return true;}}
return false;},export_as_JSON:function(){var json=_super_order.export_as_JSON.apply(this,arguments);json.multiprint_resume=this.saved_resume;return json;},init_from_JSON:function(json){_super_order.init_from_JSON.apply(this,arguments);this.saved_resume=json.multiprint_resume;},});var SubmitOrderButton=screens.ActionButtonWidget.extend({'template':'SubmitOrderButton',button_click:function(){var order=this.pos.get_order();if(order.hasChangesToPrint()){order.printChanges();order.saveChanges();}},});screens.define_action_button({'name':'submit_order','widget':SubmitOrderButton,'condition':function(){return this.pos.printers.length;},});screens.OrderWidget.include({update_summary:function(){this._super();var changes=this.pos.get_order().hasChangesToPrint();var skipped=changes?false:this.pos.get_order().hasSkippedChanges();var buttons=this.getParent().action_buttons;if(buttons&&buttons.submit_order){buttons.submit_order.highlight(changes);buttons.submit_order.altlight(skipped);}},});});;

/* /pos_restaurant/static/src/js/splitbill.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.splitbill',function(require){"use strict";var gui=require('point_of_sale.gui');var models=require('point_of_sale.models');var screens=require('point_of_sale.screens');var core=require('web.core');var QWeb=core.qweb;var SplitbillScreenWidget=screens.ScreenWidget.extend({template:'SplitbillScreenWidget',previous_screen:'products',renderElement:function(){var self=this;var linewidget;this._super();var order=this.pos.get_order();if(!order){return;}
var orderlines=order.get_orderlines();for(var i=0;i<orderlines.length;i++){var line=orderlines[i];linewidget=$(QWeb.render('SplitOrderline',{widget:this,line:line,selected:false,quantity:0,id:line.id,}));linewidget.data('id',line.id);this.$('.orderlines').append(linewidget);}
this.$('.back').click(function(){self.gui.show_screen(self.previous_screen);});},lineselect:function($el,order,neworder,splitlines,line_id){var split=splitlines[line_id]||{'quantity':0,line:null};var line=order.get_orderline(line_id);if(!line.get_unit().is_pos_groupable){if(split.quantity!==line.get_quantity()){split.quantity=line.get_quantity();}else{split.quantity=0;}}else{if(split.quantity<line.get_quantity()){split.quantity+=line.get_unit().is_pos_groupable?1:line.get_unit().rounding;if(split.quantity>line.get_quantity()){split.quantity=line.get_quantity();}}else{split.quantity=0;}}
if(split.quantity){if(!split.line){split.line=line.clone();neworder.add_orderline(split.line);}
split.line.set_quantity(split.quantity,'do not recompute unit price');}else if(split.line){neworder.remove_orderline(split.line);split.line=null;}
splitlines[line_id]=split;$el.replaceWith($(QWeb.render('SplitOrderline',{widget:this,line:line,selected:split.quantity!==0,quantity:split.quantity,id:line_id,})));this.$('.order-info .subtotal').text(this.format_currency(neworder.get_subtotal()));},pay:function(order,neworder,splitlines){var orderlines=order.get_orderlines();var empty=true;var full=true;for(var i=0;i<orderlines.length;i++){var id=orderlines[i].id;var split=splitlines[id];if(!split){full=false;}else{if(split.quantity){empty=false;if(split.quantity!==orderlines[i].get_quantity()){full=false;}}}}
if(empty){return;}
delete neworder.temporary;if(full){this.gui.show_screen('payment');}else{for(var id in splitlines){var split=splitlines[id];var line=order.get_orderline(parseInt(id));line.set_quantity(line.get_quantity()-split.quantity,'do not recompute unit price');if(Math.abs(line.get_quantity())<0.00001){order.remove_orderline(line);}
delete splitlines[id];}
neworder.set_screen_data('screen','payment');if(neworder.saveChanges){order.saveChanges();neworder.saveChanges();}
neworder.set_customer_count(1);order.set_customer_count(order.get_customer_count()-1);this.pos.get('orders').add(neworder);this.pos.set('selectedOrder',neworder);}},show:function(){var self=this;this._super();this.renderElement();var order=this.pos.get_order();var neworder=new models.Order({},{pos:this.pos,temporary:true,});neworder.set('client',order.get('client'));var splitlines={};this.$('.orderlines').on('click','.orderline',function(){var id=parseInt($(this).data('id'));var $el=$(this);self.lineselect($el,order,neworder,splitlines,id);});this.$('.paymentmethods .button').click(function(){self.pay(order,neworder,splitlines);});},});gui.define_screen({'name':'splitbill','widget':SplitbillScreenWidget,'condition':function(){return this.pos.config.iface_splitbill;},});var SplitbillButton=screens.ActionButtonWidget.extend({template:'SplitbillButton',button_click:function(){if(this.pos.get_order().get_orderlines().length>0){this.gui.show_screen('splitbill');}},});screens.define_action_button({'name':'splitbill','widget':SplitbillButton,'condition':function(){return this.pos.config.iface_splitbill;},});});;

/* /pos_restaurant/static/src/js/printbill.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.printbill',function(require){"use strict";var core=require('web.core');var screens=require('point_of_sale.screens');var gui=require('point_of_sale.gui');var QWeb=core.qweb;var BillScreenWidget=screens.ReceiptScreenWidget.extend({template:'BillScreenWidget',click_next:function(){this.gui.show_screen('products');},click_back:function(){this.gui.show_screen('products');},render_receipt:function(){this._super();this.$('.receipt-paymentlines').remove();this.$('.receipt-change').remove();},print_web:function(){window.print();},});gui.define_screen({name:'bill',widget:BillScreenWidget});var PrintBillButton=screens.ActionButtonWidget.extend({template:'PrintBillButton',print_xml:function(){var order=this.pos.get('selectedOrder');if(order.get_orderlines().length>0){var receipt=order.export_for_printing();receipt.bill=true;this.pos.proxy.print_receipt(QWeb.render('BillReceipt',{receipt:receipt,widget:this,pos:this.pos,order:order,}));}},button_click:function(){if(!this.pos.config.iface_print_via_proxy){this.gui.show_screen('bill');}else{this.print_xml();}},});screens.define_action_button({'name':'print_bill','widget':PrintBillButton,'condition':function(){return this.pos.config.iface_printbill;},});});;

/* /pos_restaurant/static/src/js/floors.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.floors',function(require){"use strict";var PosBaseWidget=require('point_of_sale.BaseWidget');var chrome=require('point_of_sale.chrome');var gui=require('point_of_sale.gui');var models=require('point_of_sale.models');var screens=require('point_of_sale.screens');var core=require('web.core');var rpc=require('web.rpc');var QWeb=core.qweb;var _t=core._t;models.load_models({model:'restaurant.floor',fields:['name','background_color','table_ids','sequence'],domain:function(self){return[['pos_config_id','=',self.config.id]];},loaded:function(self,floors){self.floors=floors;self.floors_by_id={};for(var i=0;i<floors.length;i++){floors[i].tables=[];self.floors_by_id[floors[i].id]=floors[i];}
self.floors=self.floors.sort(function(a,b){return a.sequence-b.sequence;});self.config.iface_floorplan=!!self.floors.length;},});models.load_models({model:'restaurant.table',fields:['name','width','height','position_h','position_v','shape','floor_id','color','seats'],loaded:function(self,tables){self.tables_by_id={};for(var i=0;i<tables.length;i++){self.tables_by_id[tables[i].id]=tables[i];var floor=self.floors_by_id[tables[i].floor_id[0]];if(floor){floor.tables.push(tables[i]);tables[i].floor=floor;}}},});var TableWidget=PosBaseWidget.extend({template:'TableWidget',init:function(parent,options){this._super(parent,options);this.table=options.table;this.selected=false;this.moved=false;this.dragpos={x:0,y:0};this.handle_dragging=false;this.handle=null;},event_position:function(event){if(event.touches&&event.touches[0]){return{x:event.touches[0].screenX,y:event.touches[0].screenY};}else{return{x:event.screenX,y:event.screenY};}},click_handler:function(){var self=this;var floorplan=this.getParent();if(floorplan.editing){setTimeout(function(){if(!self.dragging){if(self.moved){self.moved=false;}else if(!self.selected){self.getParent().select_table(self);}else{self.getParent().deselect_tables();}}},50);}else{floorplan.pos.set_table(this.table);}},dragstart_handler:function(event,$el,drag){if(this.selected&&!this.handle_dragging){this.dragging=true;this.dragpos={x:drag.offsetX,y:drag.offsetY};}},dragend_handler:function(){this.dragging=false;},dragmove_handler:function(event,$el,drag){if(this.dragging){var dx=drag.offsetX-this.dragpos.x;var dy=drag.offsetY-this.dragpos.y;this.dragpos={x:drag.offsetX,y:drag.offsetY};this.moved=true;this.table.position_v+=dy;this.table.position_h+=dx;$el.css(this.table_style());}},handle_dragstart_handler:function(event,$el,drag){if(this.selected&&!this.dragging){this.handle_dragging=true;this.handle_dragpos=this.event_position(event);this.handle=drag.target;}},handle_dragend_handler:function(){this.handle_dragging=false;},handle_dragmove_handler:function(event){if(this.handle_dragging){var pos=this.event_position(event);var dx=pos.x-this.handle_dragpos.x;var dy=pos.y-this.handle_dragpos.y;this.handle_dragpos=pos;this.moved=true;var cl=this.handle.classList;var MIN_SIZE=40;var tw=Math.max(MIN_SIZE,this.table.width);var th=Math.max(MIN_SIZE,this.table.height);var tx=this.table.position_h;var ty=this.table.position_v;if(cl.contains('left')&&tw-dx>=MIN_SIZE){tw-=dx;tx+=dx;}else if(cl.contains('right')&&tw+dx>=MIN_SIZE){tw+=dx;}
if(cl.contains('top')&&th-dy>=MIN_SIZE){th-=dy;ty+=dy;}else if(cl.contains('bottom')&&th+dy>=MIN_SIZE){th+=dy;}
this.table.width=tw;this.table.height=th;this.table.position_h=tx;this.table.position_v=ty;this.$el.css(this.table_style());}},set_table_color:function(color){this.table.color=_.escape(color);this.$el.css({'background':this.table.color});},set_table_name:function(name){if(name){this.table.name=name;this.renderElement();}},set_table_seats:function(seats){if(seats){this.table.seats=Number(seats);this.renderElement();}},table_style:function(){var table=this.table;function unit(val){return''+val+'px';}
var style={'width':unit(table.width),'height':unit(table.height),'line-height':unit(table.height),'margin-left':unit(-table.width/2),'margin-top':unit(-table.height/2),'top':unit(table.position_v+table.height/2),'left':unit(table.position_h+table.width/2),'border-radius':table.shape==='round'?unit(Math.max(table.width,table.height)/2):'3px',};if(table.color){style.background=table.color;}
if(table.height>=150&&table.width>=150){style['font-size']='32px';}
return style;},table_style_str:function(){var style=this.table_style();var str="";var s;for(s in style){str+=s+":"+style[s]+"; ";}
return str;},select:function(){this.selected=true;this.renderElement();},deselect:function(){this.selected=false;this.renderElement();this.save_changes();},save_changes:function(){var self=this;var fields=_.find(this.pos.models,function(model){return model.model==='restaurant.table';}).fields;var serializable_table={};for(var i=0;i<fields.length;i++){if(typeof this.table[fields[i]]!=='undefined'){serializable_table[fields[i]]=this.table[fields[i]];}}
serializable_table.id=this.table.id;rpc.query({model:'restaurant.table',method:'create_from_ui/index.php',args:[serializable_table],}).then(function(table_id){rpc.query({model:'restaurant.table',method:'search_read',args:[[['id','=',table_id]],fields],limit:1,}).then(function(table){for(var field in table){self.table[field]=table[field];}
self.renderElement();});},function(type,err){self.gui.show_popup('error',{'title':_t('Changes could not be saved'),'body':_t('You must be connected to the internet to save your changes.'),});});},trash:function(){var self=this;rpc.query({model:'restaurant.table',method:'create_from_ui/index.php',args:[{'active':false,'id':this.table.id}],}).then(function(table_id){for(var i=0;i<self.pos.floors.length;i++){var floor=self.pos.floors[i];for(var j=0;j<floor.tables.length;j++){if(floor.tables[j].id===table_id){floor.tables.splice(j,1);break;}}}
var floorplan=self.getParent();for(var i=0;i<floorplan.table_widgets.length;i++){if(floorplan.table_widgets[i]===self){floorplan.table_widgets.splice(i,1);}}
if(floorplan.selected_table===self){floorplan.selected_table=null;}
floorplan.update_toolbar();self.destroy();},function(type,err){self.gui.show_popup('error',{'title':_t('Changes could not be saved'),'body':_t('You must be connected to the internet to save your changes.'),});});},get_notifications:function(){var orders=this.pos.get_table_orders(this.table);var notifications={};for(var i=0;i<orders.length;i++){if(orders[i].hasChangesToPrint()){notifications.printing=true;break;}else if(orders[i].hasSkippedChanges()){notifications.skipped=true;}}
return notifications;},update_click_handlers:function(editing){var self=this;this.$el.off('mouseup touchend touchcancel click dragend');if(editing){this.$el.on('mouseup touchend touchcancel',function(event){self.click_handler(event,$(this));});}else{this.$el.on('click dragend',function(event){self.click_handler(event,$(this));});}},renderElement:function(){var self=this;this.order_count=this.pos.get_table_orders(this.table).length;this.customer_count=this.pos.get_customer_count(this.table);this.fill=Math.min(1,Math.max(0,this.customer_count/this.table.seats));this.notifications=this.get_notifications();this._super();this.update_click_handlers();this.$el.on('dragstart',function(event,drag){self.dragstart_handler(event,$(this),drag);});this.$el.on('drag',function(event,drag){self.dragmove_handler(event,$(this),drag);});this.$el.on('dragend',function(event,drag){self.dragend_handler(event,$(this),drag);});var handles=this.$el.find('.table-handle');handles.on('dragstart',function(event,drag){self.handle_dragstart_handler(event,$(this),drag);});handles.on('drag',function(event,drag){self.handle_dragmove_handler(event,$(this),drag);});handles.on('dragend',function(event,drag){self.handle_dragend_handler(event,$(this),drag);});},});var FloorScreenWidget=screens.ScreenWidget.extend({template:'FloorScreenWidget',barcode_product_action:function(code){},barcode_discount_action:function(code){},barcode_client_action:function(code){},init:function(parent,options){this._super(parent,options);this.floor=this.pos.floors[0];this.table_widgets=[];this.selected_table=null;this.editing=false;},hide:function(){this._super();if(this.editing){this.toggle_editing();}
this.chrome.widget.order_selector.show();},show:function(){this._super();this.chrome.widget.order_selector.hide();for(var i=0;i<this.table_widgets.length;i++){this.table_widgets[i].renderElement();}
this.check_empty_floor();},click_floor_button:function(event,$el){var floor=this.pos.floors_by_id[$el.data('id')];if(floor!==this.floor){if(this.editing){this.toggle_editing();}
this.floor=floor;this.selected_table=null;this.renderElement();this.check_empty_floor();}},background_image_url:function(floor){return'/web/image?model=restaurant.floor&id='+floor.id+'&field=background_image';},get_floor_style:function(){var style="";if(this.floor.background_image){style+="background-image: url("+this.background_image_url(this.floor)+"); ";}
if(this.floor.background_color){style+="background-color: "+_.escape(this.floor.background_color)+";";}
return style;},set_background_color:function(background){var self=this;this.floor.background_color=background;rpc.query({model:'restaurant.floor',method:'write',args:[[this.floor.id],{'background_color':background}],}).fail(function(type,err){self.gui.show_popup('error',{'title':_t('Changes could not be saved'),'body':_t('You must be connected to the internet to save your changes.'),});});this.$('.floor-map').css({"background-color":_.escape(background)});},deselect_tables:function(){for(var i=0;i<this.table_widgets.length;i++){var table=this.table_widgets[i];if(table.selected){table.deselect();}}
this.selected_table=null;this.update_toolbar();},select_table:function(table_widget){if(!table_widget.selected){this.deselect_tables();table_widget.select();this.selected_table=table_widget;this.update_toolbar();}},tool_shape_action:function(){if(this.selected_table){var table=this.selected_table.table;if(table.shape==='square'){table.shape='round';}else{table.shape='square';}
this.selected_table.renderElement();this.update_toolbar();}},tool_colorpicker_open:function(){this.$('.color-picker').addClass('oe_hidden');if(this.selected_table){this.$('.color-picker.fg-picker').removeClass('oe_hidden');}else{this.$('.color-picker.bg-picker').removeClass('oe_hidden');}},tool_colorpicker_pick:function(event,$el){if(this.selected_table){this.selected_table.set_table_color($el[0].style['background-color']);}else{this.set_background_color($el[0].style['background-color']);}},tool_colorpicker_close:function(){this.$('.color-picker').addClass('oe_hidden');},tool_rename_table:function(){var self=this;if(this.selected_table){this.gui.show_popup('textinput',{'title':_t('Table Name ?'),'value':this.selected_table.table.name,'confirm':function(value){self.selected_table.set_table_name(value);},});}},tool_change_seats:function(){var self=this;if(this.selected_table){this.gui.show_popup('number',{'title':_t('Number of Seats ?'),'cheap':true,'value':this.selected_table.table.seats,'confirm':function(value){self.selected_table.set_table_seats(value);},});}},tool_duplicate_table:function(){if(this.selected_table){var tw=this.create_table(this.selected_table.table);tw.table.position_h+=10;tw.table.position_v+=10;tw.save_changes();this.select_table(tw);}},tool_new_table:function(){var tw=this.create_table({'position_v':100,'position_h':100,'width':75,'height':75,'shape':'square','seats':1,});tw.save_changes();this.select_table(tw);this.check_empty_floor();},new_table_name:function(name){if(name){var num=Number((name.match(/\d+/g)||[])[0]||0);var str=(name.replace(/\d+/g,''));var n={num:num,str:str};n.num+=1;this.last_name=n;}else if(this.last_name){this.last_name.num+=1;}else{this.last_name={num:1,str:'T'};}
return''+this.last_name.str+this.last_name.num;},create_table:function(params){var table={};for(var p in params){table[p]=params[p];}
table.name=this.new_table_name(params.name);delete table.id;table.floor_id=[this.floor.id,''];table.floor=this.floor;this.floor.tables.push(table);var tw=new TableWidget(this,{table:table});tw.appendTo('.floor-map .tables');this.table_widgets.push(tw);return tw;},tool_trash_table:function(){var self=this;if(this.selected_table){this.gui.show_popup('confirm',{'title':_t('Are you sure ?'),'comment':_t('Removing a table cannot be undone'),'confirm':function(){self.selected_table.trash();},});}},toggle_editing:function(){this.editing=!this.editing;this.update_toolbar();this.update_table_click_handlers();if(!this.editing){this.deselect_tables();}},update_table_click_handlers:function(){for(var i=0;i<this.table_widgets.length;++i){if(this.editing){this.table_widgets[i].update_click_handlers("editing");}else{this.table_widgets[i].update_click_handlers();}}},check_empty_floor:function(){if(!this.floor.tables.length){if(!this.editing){this.toggle_editing();}
this.$('.empty-floor').removeClass('oe_hidden');}else{this.$('.empty-floor').addClass('oe_hidden');}},update_toolbar:function(){if(this.editing){this.$('.edit-bar').removeClass('oe_hidden');this.$('.edit-button.editing').addClass('active');}else{this.$('.edit-bar').addClass('oe_hidden');this.$('.edit-button.editing').removeClass('active');}
if(this.selected_table){this.$('.needs-selection').removeClass('disabled');var table=this.selected_table.table;if(table.shape==='square'){this.$('.button-option.square').addClass('oe_hidden');this.$('.button-option.round').removeClass('oe_hidden');}else{this.$('.button-option.square').removeClass('oe_hidden');this.$('.button-option.round').addClass('oe_hidden');}}else{this.$('.needs-selection').addClass('disabled');}
this.tool_colorpicker_close();},renderElement:function(){var self=this;for(var i=0;i<this.table_widgets.length;i++){this.table_widgets[i].destroy();}
this.table_widgets=[];this._super();for(var i=0;i<this.floor.tables.length;i++){var tw=new TableWidget(this,{table:this.floor.tables[i],});tw.appendTo(this.$('.floor-map .tables'));this.table_widgets.push(tw);}
$('body').on('keyup',function(event){if(event.which===$.ui.keyCode.ESCAPE){if(self.editing){self.toggle_editing();}}});this.$('.floor-selector .button').click(function(event){self.click_floor_button(event,$(this));});this.$('.edit-button.shape').click(function(){self.tool_shape_action();});this.$('.edit-button.color').click(function(){self.tool_colorpicker_open();});this.$('.edit-button.dup-table').click(function(){self.tool_duplicate_table();});this.$('.edit-button.new-table').click(function(){self.tool_new_table();});this.$('.edit-button.rename').click(function(){self.tool_rename_table();});this.$('.edit-button.seats').click(function(){self.tool_change_seats();});this.$('.edit-button.trash').click(function(){self.tool_trash_table();});this.$('.color-picker .close-picker').click(function(event){self.tool_colorpicker_close();event.stopPropagation();});this.$('.color-picker .color').click(function(event){self.tool_colorpicker_pick(event,$(this));event.stopPropagation();});this.$('.edit-button.editing').click(function(){self.toggle_editing();});this.$('.floor-map,.floor-map .tables').click(function(event){if(event.target===self.$('.floor-map')[0]||event.target===self.$('.floor-map .tables')[0]){self.deselect_tables();}});this.$('.color-picker .close-picker').click(function(event){self.tool_colorpicker_close();event.stopPropagation();});this.update_toolbar();},});gui.define_screen({'name':'floors','widget':FloorScreenWidget,'condition':function(){return this.pos.config.iface_floorplan;},});chrome.Chrome.include({build_widgets:function(){this._super();if(this.pos.config.iface_floorplan){this.gui.set_startup_screen('floors');}},});var _super_order=models.Order.prototype;models.Order=models.Order.extend({initialize:function(){_super_order.initialize.apply(this,arguments);if(!this.table){this.table=this.pos.table;}
this.customer_count=this.customer_count||1;this.save_to_db();},export_as_JSON:function(){var json=_super_order.export_as_JSON.apply(this,arguments);json.table=this.table?this.table.name:undefined;json.table_id=this.table?this.table.id:false;json.floor=this.table?this.table.floor.name:false;json.floor_id=this.table?this.table.floor.id:false;json.customer_count=this.customer_count;return json;},init_from_JSON:function(json){_super_order.init_from_JSON.apply(this,arguments);this.table=this.pos.tables_by_id[json.table_id];this.floor=this.table?this.pos.floors_by_id[json.floor_id]:undefined;this.customer_count=json.customer_count||1;},export_for_printing:function(){var json=_super_order.export_for_printing.apply(this,arguments);json.table=this.table?this.table.name:undefined;json.floor=this.table?this.table.floor.name:undefined;json.customer_count=this.get_customer_count();return json;},get_customer_count:function(){return this.customer_count;},set_customer_count:function(count){this.customer_count=Math.max(count,0);this.trigger('change');},});chrome.OrderSelectorWidget.include({floor_button_click_handler:function(){this.pos.set_table(null);},hide:function(){this.$el.addClass('oe_invisible');},show:function(){this.$el.removeClass('oe_invisible');},renderElement:function(){var self=this;this._super();if(this.pos.config.iface_floorplan){if(this.pos.get_order()){if(this.pos.table&&this.pos.table.floor){this.$('.orders').prepend(QWeb.render('BackToFloorButton',{table:this.pos.table,floor:this.pos.table.floor}));this.$('.floor-button').click(function(){self.floor_button_click_handler();});}
this.$el.removeClass('oe_invisible');}else{this.$el.addClass('oe_invisible');}}},});var _super_posmodel=models.PosModel.prototype;models.PosModel=models.PosModel.extend({initialize:function(session,attributes){this.table=null;return _super_posmodel.initialize.call(this,session,attributes);},transfer_order_to_different_table:function(){this.order_to_transfer_to_different_table=this.get_order();this.set_table(null);},set_table:function(table){if(!table){this.set_order(null);}else if(this.order_to_transfer_to_different_table){this.order_to_transfer_to_different_table.table=table;this.order_to_transfer_to_different_table.save_to_db();this.order_to_transfer_to_different_table=null;this.set_table(table);}else{this.table=table;var orders=this.get_order_list();if(orders.length){this.set_order(orders[0]);}else{this.add_new_order();}}},set_start_order:function(){if(!this.config.iface_floorplan){_super_posmodel.set_start_order.apply(this,arguments);}},add_new_order:function(){if(this.config.iface_floorplan){if(this.table){return _super_posmodel.add_new_order.call(this);}else{console.warn("WARNING: orders cannot be created when there is no active table in restaurant mode");return undefined;}}else{return _super_posmodel.add_new_order.apply(this,arguments);}},get_order_list:function(){var orders=_super_posmodel.get_order_list.call(this);if(!this.config.iface_floorplan){return orders;}else if(!this.table){return[];}else{var t_orders=[];for(var i=0;i<orders.length;i++){if(orders[i].table===this.table){t_orders.push(orders[i]);}}
return t_orders;}},get_table_orders:function(table){var orders=_super_posmodel.get_order_list.call(this);var t_orders=[];for(var i=0;i<orders.length;i++){if(orders[i].table===table){t_orders.push(orders[i]);}}
return t_orders;},get_customer_count:function(table){var orders=this.get_table_orders(table);var count=0;for(var i=0;i<orders.length;i++){count+=orders[i].get_customer_count();}
return count;},on_removed_order:function(removed_order,index,reason){if(this.config.iface_floorplan){var order_list=this.get_order_list();if((reason==='abandon'||removed_order.temporary)&&order_list.length>0){this.set_order(order_list[index]||order_list[order_list.length-1]);}else{this.set_table(null);}}else{_super_posmodel.on_removed_order.apply(this,arguments);}},});var TableGuestsButton=screens.ActionButtonWidget.extend({template:'TableGuestsButton',guests:function(){if(this.pos.get_order()){return this.pos.get_order().customer_count;}else{return 0;}},button_click:function(){var self=this;this.gui.show_popup('number',{'title':_t('Guests ?'),'cheap':true,'value':this.pos.get_order().customer_count,'confirm':function(value){value=Math.max(1,Number(value));self.pos.get_order().set_customer_count(value);self.renderElement();},});},});screens.OrderWidget.include({update_summary:function(){this._super();if(this.getParent().action_buttons&&this.getParent().action_buttons.guests){this.getParent().action_buttons.guests.renderElement();}},});screens.define_action_button({'name':'guests','widget':TableGuestsButton,'condition':function(){return this.pos.config.iface_floorplan;},});var TransferOrderButton=screens.ActionButtonWidget.extend({template:'TransferOrderButton',button_click:function(){this.pos.transfer_order_to_different_table();},});screens.define_action_button({'name':'transfer','widget':TransferOrderButton,'condition':function(){return this.pos.config.iface_floorplan;},});return{TableGuestsButton:TableGuestsButton,TransferOrderButton:TransferOrderButton,TableWidget:TableWidget,FloorScreenWidget:FloorScreenWidget,};});;

/* /pos_restaurant/static/src/js/notes.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.notes',function(require){"use strict";var models=require('point_of_sale.models');var screens=require('point_of_sale.screens');var core=require('web.core');var QWeb=core.qweb;var _t=core._t;var _super_orderline=models.Orderline.prototype;models.Orderline=models.Orderline.extend({initialize:function(attr,options){_super_orderline.initialize.call(this,attr,options);this.note=this.note||"";},set_note:function(note){this.note=note;this.trigger('change',this);},get_note:function(note){return this.note;},can_be_merged_with:function(orderline){if(orderline.get_note()!==this.get_note()){return false;}else{return _super_orderline.can_be_merged_with.apply(this,arguments);}},clone:function(){var orderline=_super_orderline.clone.call(this);orderline.note=this.note;return orderline;},export_as_JSON:function(){var json=_super_orderline.export_as_JSON.call(this);json.note=this.note;return json;},init_from_JSON:function(json){_super_orderline.init_from_JSON.apply(this,arguments);this.note=json.note;},});var OrderlineNoteButton=screens.ActionButtonWidget.extend({template:'OrderlineNoteButton',button_click:function(){var line=this.pos.get_order().get_selected_orderline();if(line){this.gui.show_popup('textarea',{title:_t('Add Note'),value:line.get_note(),confirm:function(note){line.set_note(note);},});}},});screens.define_action_button({'name':'orderline_note','widget':OrderlineNoteButton,'condition':function(){return this.pos.config.iface_orderline_notes;},});});